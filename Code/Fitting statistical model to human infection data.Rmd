---
title: "Analyzing Norovirus Data"
author: "Kayla Zhang, Damie Pak, Megan Greischar"
date: "2024-04-27"
output:
  bookdown::pdf_document2:
    toc: no
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warnings = FALSE)
```

```{r}
library(here)
library(pzfx)
library(data.table)
library(spatialEco)
library(Polychrome)
library(pracma)
```

We use the shedding and symptom timing data that Ge *et al*., 2023 obtained 
from a norovirus study (Atmar *et al*., 2008).
```{r, echo = TRUE, eval = FALSE}
exclude.participants <- function(p, data) {
  pdata <- data[data$ID == p, ]
  
  if(nrow(pdata[!is.na(pdata$y_virus),]) < 5) {
    return(p)
  }
}

noroData <- readRDS(here("norodata.rds")) 

write.table(noroData$ftsshedding, "noroFtsData.txt")
noro.FShedData <- read.table("noroFtsData.txt", stringsAsFactors = F)
noro.FShedData <- noro.FShedData[, c(1, 2, 5, 6, 8)]

write.table(noroData$incubation, "noroIncubationData.txt")
noro.IncubData <- read.table("noroIncubationData.txt", stringsAsFactors = F)
noro.IncubData <- noro.IncubData[, c(1, 2, 5)]

# Get rid of viral shedding below the qRT-PCR detection threshold (4e7 copies /ml)
noro.detection.threshold <- 15000
noro.detection.threshold.2 <- 4e7
noro.FShedData[noro.FShedData$y_virus <= noro.detection.threshold.2,]$y_virus <- NA

# Exclude participants with less than 5 points of data 
noro.excluded <- unlist(lapply(unique(noro.FShedData$ID), exclude.participants, data=noro.FShedData))

noro.excluded <- noro.excluded[!is.null(noro.excluded)]

noro.FShedData <- noro.FShedData[!(noro.FShedData$ID %in% noro.excluded),]

# Average across viral shedding values at the same time point
aggregated_virus <- aggregate(y_virus ~ ID + days, 
                              noro.FShedData,
                              mean,
                              na.action=na.pass)
aggregated_virus <- aggregated_virus[order(as.numeric(substring(aggregated_virus$ID, 3, 4)),
                       aggregated_virus$days),]$y_virus

noro.FShedData <- noro.FShedData[!duplicated(noro.FShedData[, c(1, 3)]),]
noro.FShedData$y_virus <- aggregated_virus
```

Importing SARS-CoV-2 data
```{r}
extract.incubation <- function(symp.data) {
  
  symptom.indexes <- symp.data[which(symp.data[, 2] > 0),]$ROWTITLE
  
  if (length(symptom.indexes) == 0) {
    symp.onset <- NA
  } else {
    symp.onset <- min(symptom.indexes) 
  }
  
  incub.data <- data.frame("ID" = colnames(symp.data)[2], "incubation" = symp.onset)
  
  return(incub.data)
}

sars.TShedData <- read_pzfx(here("SARS-Supp-2.pzfx"), table=37)[, c(1, 20:37)]
sars.TShedData <- melt(as.data.table(sars.TShedData), id.vars=c("Day"), 
                       variable.name = "ID", value.name = "y_virus", 
                       variable.factor = F)
colnames(sars.TShedData)[1] <- "days"

incub.indexes <- 37:54
sars.IncubData <- data.frame(do.call(rbind, 
                                     lapply(incub.indexes, 
                                            function(x) 
                                              extract.incubation(
                                                read_pzfx(here("SARS-Fig-1.pzfx"), 
                                                    table=x)))))

ID_dict <- c("680539" = "Throat_10",
"673353" = "Throat_18",
"667186" = "Throat_11",
"550630" = "Throat_7",
"635495" = "Throat_1",
"666482" = "Throat_9",
"651806" = "Throat_15",
"635331" = "Throat_5",
"634105" = "Throat_2",
"635779" = "Throat_16",
"635729" = "Throat_4",
"637340" = "Throat_12",
"627506" = "Throat_6",
"666660" = "Throat_8",
"676586" = "Throat_13",
"666427" = "Throat_14",
"647785" = "Throat_3",
"674700" = "Throat_17"
)

sars.IncubData$ID <- ID_dict[sars.IncubData$ID]

# Get rid of viral shedding below the detection threshold (1200 copies/ml)
sars.detection.threshold <- 1200
sars.TShedData[sars.TShedData$y_virus < sars.detection.threshold,]$y_virus <- NA

# Exclude participants with less than 5 points of data 
sars.excluded <- unlist(lapply(unique(sars.TShedData$ID), exclude.participants, data=sars.TShedData))

sars.excluded <- sars.excluded[!is.null(sars.excluded)]

sars.TShedData <- sars.TShedData[!(sars.TShedData$ID %in% sars.excluded),]
```

We then fit a statistical model (Li & Handel, 2014, Holder & Beauchemin, 2011) 
that estimates viral load values over time to the shedding data we just 
extracted using the least squares method. There is a typo in 
Li & Handel, 2014 in the denominator, where the term 
exp(p4 * (t-p3)) is written as exp(-p4 * (t-p3)) (Holder & Beauchemin, 2011). 
We make the assumption that viral load is a 1-to-1 mapping to viral shedding. 
We also subtract 19 hours each time we convert from days to hours to set time 
point = 0 as time of inoculation, since Atmar et al., 2008 defined study day 1 
as beginning around 5-6 hours after inoculation.
```{r}
generate.estimates <- function(t, pars) {
  
  p1 <- exp(pars[1])
  p2 <- exp(pars[2])
  p3 <- exp(pars[3])
  p4 <- exp(pars[4])
  
  estimate <- (2 * p1) / (exp(-p2*(t-p3)) + exp(p4*(t-p3)))
  return(log10(estimate))
  
} 

sse.viralLoad <- function(pars, data, detect.threshold, detect.threshold.2 = NA) {
  vl <- log10(data$y_virus)
  t <- data$days * 24
  
  estimates <- generate.estimates(t, pars)
  
  vl[which(is.na(vl) & estimates > detect.threshold)] <- detect.threshold
  
  # Shedding values only reported as positives without numbers attached 
  vl[which(grepl('~', data$y_type) & estimates < detect.threshold)] <- detect.threshold 
  vl[which(grepl('~', data$y_type) & estimates > detect.threshold.2)] <- detect.threshold.2
  
  sse <- sum((estimates - vl)^2, na.rm=TRUE)

  if (sse > 1e20) {
    return(1e20)
  } else {
    return(sse)
  }
  
}

generate.possible.params <- function(data, detect.threshold,
                                     detect.threshold.2 = NA) {
  
  # These are ln(param) values
  
  p1 <- runif(1, -1, log(1e12))
  p2 <- runif(1, -1, 1) 
  p3 <- runif(1, -1, log(4 * 24))
  p4 <- runif(1, -5, 1)
  
  params <- c(p1, p2, p3, p4)

  fit <- optim(params, sse.viralLoad, data=data, detect.threshold=detect.threshold,
               detect.threshold.2=detect.threshold.2)
  
  param.guess <- data.frame(unique(data$ID), 
                         fit$par[1],
                         fit$par[2],
                         fit$par[3],
                         fit$par[4],
                         fit$convergence, 
                         fit$value)
  
  return(param.guess)
  
}

generate.fits <- function(data, numguess, detect.threshold, detect.threshold.2 = NA) {

  fits <- do.call(rbind, 
                  lapply(1:numguess,
                         function(x) generate.possible.params(data, detect.threshold,
                                                              detect.threshold.2))) 
  
  colnames(fits) <- c('ID', 'p1','p2','p3','p4','convergence','sse')
  return(fits)
}

get.params <- function(fits) {
  
  minsse <- min(fits[fits$convergence==0, ]$sse)
  pars <- unlist((fits[fits$sse == minsse, ])[1:5])
  return(pars)
}
 
```

We define two endpoints for the fit: 1) stopping at the first local minimum
in viral load after the peak, and 2) stopping at the first viral load value 
after the peak that is equal to or less than the inoculum dose/initial viral 
load.
```{r}
first.local.min <- function(data) {
       
  quantifiable.vl <- data[!is.na(data$y_virus),]$y_virus
  quantifiable.vl <- quantifiable.vl[3:length(quantifiable.vl)]
  
  minima <- local.min.max(quantifiable.vl)$minima

  for (mi in minima) {
    
    min.index <- min(which(quantifiable.vl == mi))
    data.context <- quantifiable.vl[(min.index - 2): (min.index + 2)]
    
    if(length(na.omit(data.context)) == 5 & (min(data.context) == mi)) {
      return(min(which(data$y_virus==quantifiable.vl[min.index])))
    }
  }

  return(max(which(data$y_virus == quantifiable.vl[length(quantifiable.vl)])))
  
}

back.to.initial <- function(data) {
  
  quantifiable.vl <- data[!is.na(data$y_virus),]$y_virus 
  less.than.initial <- which(quantifiable.vl[5:length(quantifiable.vl)] <= 
                               quantifiable.vl[1])

  if (length(less.than.initial) == 0) {
    return(which(data$y_virus == quantifiable.vl[length(quantifiable.vl)]))
  } else {
    return(which(data$y_virus == quantifiable.vl[min(less.than.initial)+4]))
  }
}

all.fits <- function(data, maxt, numguess, detect.threshold, detect.threshold.2 = NA) {
  
  participants <- unique(data$ID)

  participantfits <- do.call(rbind,
                             lapply(participants,
                                    function(x) 
                                      generate.fits(data[data$ID==x,][1:(maxt[maxt$ID==x,]$max.point),],
                                                    numguess, detect.threshold,
                                                    detect.threshold.2)))
  
  return(participantfits)
}

participant.params <- function(fits) {
  
  participants <- unique(fits$ID)
  
  participantparams <- data.frame(do.call(rbind, 
                               lapply(participants, 
                                      function(x) get.params(fits[fits$ID == x,]))))
  
  colnames(participantparams) <- c("ID", "p1", "p2",
                               "p3", "p4")
  
  participantparams[, 2:5] <- apply(participantparams[, 2:5], 2, as.numeric)
  
  return(participantparams)
}

noroParticipants <- unique(noro.FShedData$ID)

# Setting the endpoint as the first local minimum
noro.maxt.firstmin <- do.call(rbind, 
                         lapply(noroParticipants, 
                                function(x) data.frame(x, 
                                                       first.local.min(noro.FShedData[noro.FShedData$ID == x,]))))
colnames(noro.maxt.firstmin) <- c('ID', 'max.point')

# SARS-CoV-2 data
sarsParticipants <- unique(sars.TShedData$ID)

sars.maxt.firstmin <- do.call(rbind, 
                         lapply(sarsParticipants, 
                                function(x) data.frame(x, 
                                                       first.local.min(sars.TShedData[sars.TShedData$ID == x,]))))
colnames(sars.maxt.firstmin) <- c('ID', 'max.point')

# Setting the endpoint as the first time after peak viral load that viral 
# load decreases to the initial viral load

noro.maxt.backtoinitial <- do.call(rbind, 
                         lapply(noroParticipants, 
                                function(x) data.frame(x, 
                                                       back.to.initial(noro.FShedData[noro.FShedData$ID == x,]))))
colnames(noro.maxt.backtoinitial) <- c('ID', 'max.point')

# SARS-CoV-2 data
sars.maxt.backtoinitial <- do.call(rbind, 
                         lapply(sarsParticipants, 
                                function(x) data.frame(x, 
                                                       back.to.initial(sars.TShedData[sars.TShedData$ID == x,]))))
colnames(sars.maxt.backtoinitial) <- c('ID', 'max.point')

```

Note that because this model is statistical, not deterministic, the parameters
will fluctuate with each run.
```{r, eval = FALSE}
noro.fits.localmin <- all.fits(noro.FShedData, noro.maxt.firstmin, 100,
                               detect.threshold = log10(noro.detection.threshold), 
                               detect.threshold.2 = log10(noro.detection.threshold.2))
noro.params.localmin <- participant.params(noro.fits.localmin)

sars.fits.localmin <- all.fits(sars.TShedData, sars.maxt.firstmin, 100,
                               detect.threshold = log10(sars.detection.threshold))
sars.params.localmin <- participant.params(sars.fits.localmin)

noro.fits.backtoinitial <- all.fits(noro.FShedData, noro.maxt.backtoinitial, 100,
                                    detect.threshold = log10(noro.detection.threshold), 
                                    detect.threshold.2 = log10(noro.detection.threshold.2))
noro.params.backtoinitial <- participant.params(noro.fits.backtoinitial)

sars.fits.backtoinitial <- all.fits(sars.TShedData, sars.maxt.backtoinitial, 100,
                                    detect.threshold = log10(sars.detection.threshold))
sars.params.backtoinitial <- participant.params(sars.fits.backtoinitial)
```

As a result, we saved the results of our first iteration in a csv file.
```{r}
write.csv(noro.fits.localmin, "Atmar Fits local minimum.csv", row.names=F)
write.csv(noro.params.localmin, "Atmar Parameters local minimum.csv", row.names=F)
write.csv(sars.fits.localmin, "Zhou Fits local minimum.csv", row.names=F)
write.csv(sars.params.localmin, "Zhou Parameters local minimum.csv", row.names=F)

write.csv(noro.fits.backtoinitial, "Atmar Fits back to initial.csv", row.names=F)
write.csv(noro.params.backtoinitial, "Atmar Parameters back to initial.csv", row.names=F)
write.csv(sars.fits.backtoinitial, "Zhou Fits back to initial.csv", row.names=F)
write.csv(sars.params.backtoinitial, "Zhou Parameters back to initial.csv", row.names=F)

noro.fits.localmin <- read.csv("Atmar Fits local minimum.csv")
noro.params.localmin <- read.csv("Atmar Parameters local minimum.csv")

sars.fits.localmin <- read.csv("Zhou Fits local minimum.csv")
sars.params.localmin <- read.csv("Zhou Parameters local minimum.csv")

noro.fits.backtoinitial <- read.csv("Atmar Fits back to initial.csv")
noro.params.backtoinitial <- read.csv("Atmar Parameters back to initial.csv")

sars.fits.backtoinitial <- read.csv("Zhou Fits back to initial.csv")
sars.params.backtoinitial <- read.csv("Zhou Parameters back to initial.csv")
```

We plot the range (max and min) of each parameter for the top 5% of fitting runs 
from each infection to assess parameter uncertainty.
```{r}
top5.paramranges <- function(fits) {
  
  top5sse <- quantile(fits$sse, probs=c(0.05))
    
  top5 <- fits[fits$convergence==0 &
                            fits$sse <= top5sse,][1:5]
  
  return(top5)
}

plot.paramranges <- function(ranges, cols) {
  
  participants <- unique(ranges$ID)
  globalmin <- min(ranges[,2])
  globalmax <- max(ranges[,2])
  
  param.name <- colnames(ranges)[2]
  
  if (param.name == 'p1') {
    xlab <- "Peak Viral Load"
    label <- "A"
  } else if (param.name == 'p2') {
    xlab <- expression(Viral~replication~rate~(hour^-1))
    label <- "B"
  } else if (param.name == 'p3') {
    xlab <- "Time of Peak Viral Load (hour)"
    label <- "C"
  } else {
    xlab <- expression(Viral~decay~rate~(hour^-1))
    label <- "D"
  }
  
  plot(1, type="n", xlab="", ylab="", yaxt="n", 
     xlim=c(globalmin, globalmax), ylim=c(0, 20), bty="l",
     mgp=c(2, 0.75, 0), tck=-0.04)
  
  text(.975 * (globalmax - globalmin) + globalmin, .975*20, label)
  
  axis(2, lwd.ticks=0, labels = NA)

  for (i in 1: length(participants)) {
    participantrange <- ranges[ranges$ID == participants[i],]
    p.range <- c(min(participantrange[,2]), max(participantrange[,2])) 
    
    points(p.range, rep(i, 2), col=cols[i])
    lines(p.range, rep(i, 2), col=cols[i])

  }
  
  mtext(xlab, side = 1, line= 2.3)
  
}

# Norovirus data
topnoro.params.localmin <- do.call(rbind, 
                              lapply(noroParticipants,
                                     function(x) top5.paramranges(noro.fits.localmin[noro.fits.localmin$ID == x,]))) 

cols <- glasbey.colors(length(noroParticipants)+1)[2:(length(noroParticipants)+1)]

tiff(filename="Parameter Ranges Norovirus.tiff", height=6.5, width=6.5, units = "in",
    res=500)
par(mfrow=c(2, 2), mai=c(0.72, 0.42, 0.42, 0.02))

{plot.paramranges(topnoro.params.localmin[, c(1, 2)], cols)
mtext("Parameter ranges in the top 5% by SSE (norovirus)", side = 3, adj=-1.3, line=1.5)
plot.paramranges(topnoro.params.localmin[, c(1, 3)], cols)
legend(10, 10, legend=noroParticipants, ncol=3,
         lty=1, col=cols, cex=0.6)
plot.paramranges(topnoro.params.localmin[, c(1, 4)], cols)
mtext("Participants", side = 2, line=1.2)
plot.paramranges(topnoro.params.localmin[, c(1, 5)], cols)}

dev.off()

# SARS-CoV-2 Data
topsars.params.localmin <- do.call(rbind, 
                              lapply(sarsParticipants,
                                     function(x) top5.paramranges(sars.fits.localmin[sars.fits.localmin$ID == x,]))) 

cols <- glasbey.colors(length(sarsParticipants)+1)[2:(length(sarsParticipants)+1)]

tiff(filename="Parameter Ranges SARS-CoV-2.tiff", height=6.5, width=6.5, units = "in",
    res=500)
par(mfrow=c(2, 2), mai=c(0.72, 0.42, 0.42, 0.02))

{plot.paramranges(topsars.params.localmin[, c(1, 2)], cols)
mtext("Parameter ranges in the top 5% by SSE (SARS-CoV-2)", side = 3, adj=-0.75, line=1.5)
plot.paramranges(topsars.params.localmin[, c(1, 3)], cols)
plot.paramranges(topsars.params.localmin[, c(1, 4)], cols)
mtext("Participants", side = 2, line=1.2)
plot.paramranges(topsars.params.localmin[, c(1, 5)], cols)
legend(-22, 10, legend=sarsParticipants, ncol=3,
         lty=1, col=cols, cex=0.6)}
dev.off()
```

Function for calculating peak
```{r}
calculate.peaktime <- function(vldata, maxt, params) {
  
  t <- seq(0, vldata[maxt$max.point,]$days*24, 
        by=1)
  
  predictedvl <- generate.estimates(t, params)
  
  peak.vl.time <- t[which(predictedvl==max(predictedvl))]
  
  return(peak.vl.time)
}
```

Now we plot the trajectories of three participants (703, 722, 724) as an example.
```{r, fig.height = 7.5, fig.width = 3.5}
plot.viralload <- function(data, pars, sympdata, max.modeltime, cex=1,
                           xaxisLabs = T, yaxisLabs = T, col, pch, ylim.lower=3,
                           cex_labels, cex.axis, xlabel, ylabel, panellabel,
                           example=FALSE) {

  # Plotting real VL
  plot(1, col=col, xlim=c(0, 25), 
       ylim=c(ylim.lower, 15), xlab="", ylab="", xaxt="n", yaxt="n", cex.lab=cex, 
       cex.axis=cex, font.lab=2, bty='n')
  
  # Grey rectangles where viral shedding is a range
  range.indexes <- which(is.na(data$y_virus) & grepl('POS', data$y_type))
  rectangle.x_vals <- lapply(range.indexes, function(x) c(data[x-1,]$days + 0.25, 
                                                          data[x+1,]$days - 0.25))
  lapply(rectangle.x_vals, function(x) 
    rect(x[1], log10(15000), x[2], log10(4e7), border=NA, col="lightgray"))
  
  points(data$days, log10(data$y_virus), col=col, cex=cex, pch=pch)
  
  # Plotting simulated VL
  if("y_type" %in% colnames(data)) {
    linet <- seq(min(data[grepl('POS', data$y_type) | !is.na(data$y_virus),]$days) * 24, data[max.modeltime,]$days * 24, by=1)
  } else {
    linet <- seq(min(data[!is.na(data$y_virus),]$days) * 24, 
                 data[max.modeltime,]$days * 24, by=1)
  }
  

  predictedvl <- generate.estimates(linet, pars)

  lines(linet / 24, predictedvl, col=col)
  
  
  symp.onset <- sympdata$incubation
  
  abline(v = symp.onset, col=col, lty=2)
  
  t.peak <- linet[which(predictedvl == max(predictedvl))]/24

if (is.na(symp.onset)) {
  redpointstyle <- NA
}
else if (t.peak < symp.onset) {
  redpointstyle <- 19
} else {
  redpointstyle <- 1
}
  
  if (!example) {
    text(x=18, y=12, labels=unique(data$ID), font=2)
    ylabel.line <- 4.5
    xlabel.line <- 3.5
  } else {
    ylabel.line <- 4.5
    xlabel.line <- 3.5
  }

  points(t.peak, max(predictedvl), pch=redpointstyle,
         col="red", lwd=cex, cex=cex)

  xLabs = NA
  if(xaxisLabs==T){
        xLabs = c(expression(0),
                  expression(5),
                  expression(10),
                  expression(15),
                  expression(20),
                  expression(25))}
  axis(1, cex.axis=cex.axis, at=seq(0, 25, by=5), labels = xLabs,
       line=1.25,
       mgp=c(2, 0.75, 0), tck=-0.04)
  
  yLabs = NA
  if(yaxisLabs==T){
      yLabs = c(expression(10^3),
                expression(10^5),
                expression(10^7),
                expression(10^9),
                expression(10^11),
                expression(10^13),
                expression(10^15))}
  axis(2, cex.axis=cex.axis, at=seq(3, 15, by=2), 
       labels=yLabs,
       line=1.25,
       las=2, 
       mgp=c(2, 1, 0), tck= -0.04)
  
  if (example) {
    mtext(text=xlabel, side=1, line=xlabel.line, cex=cex_labels, adj=3.25)
    mtext(text=ylabel, side=2, line=ylabel.line, cex=cex_labels, adj=5)
    text(.93 * 25, .93 * (15-3) + 3, panellabel, cex=cex_labels,
         font=2)
  }
  else {
    mtext(text=xlabel, side=1, line=xlabel.line, cex=cex_labels)
    mtext(text=ylabel, side=2, line=ylabel.line, cex=cex_labels)
  }
  
}

sars.color <- "#56b3e9"
noro.color <- "#871a6e"
sars.pch <- 5
noro.pch <- 2

tiff(filename="Example Trajectories.tiff", height=5, 
     width=6.5, units = "in", res=500)

participantexamples <- c('Throat_16', 'Throat_5', 'ID12')

par(mfrow=c(2, 2), mai=c(0.42, 0.52, 0.52, 0.1), oma=c(2, 3, 1, 2))

for(i in 1: length(participantexamples)) {
  
  p <- participantexamples[i]
  
  if(grepl('Throat', p)) {
    participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
    sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
    params <- unlist(sars.params.localmin[sars.params.localmin$ID==p,][2:5])
    maxt <- sars.maxt.firstmin[sars.maxt.firstmin$ID==p,]$max.point
    col <- sars.color
    pch <- sars.pch
  } else {
    participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
    sympdata <- noro.IncubData[noro.IncubData$ID == p, ]
    params <- unlist(noro.params.localmin[noro.params.localmin$ID==p,][2:5])
    maxt <- noro.maxt.firstmin[noro.maxt.firstmin$ID==p,]$max.point
    col <- noro.color
    pch <- noro.pch
  }

  if (i == 3) {
    ylabel <- "Viral shedding"
    xlabel <- "Hours after inoculation"
  } else {
    ylabel <- ""
    xlabel <- ""
  }
  
  plot.viralload(data=participantdata, 
                 pars=params, 
                 sympdata=sympdata, 
                 max.modeltime=maxt,
                 cex=1.33, 
                 col=col,
                 pch=pch,
                 cex_labels=1,
                 cex.axis=1,
                 xlabel=xlabel,
                 ylabel=ylabel,
                 panellabel=LETTERS[i],
                 example=TRUE)
  
  if (i == 1) {
    mtext("Post-symptomatic", side=3, line=2, font=2)
  } else if (p==participantexamples[2]) {
    mtext("Pre-symptomatic", side=3, line=2, font=2)
  }
}

plot.new()

legend("center", legend=c("SARS-CoV-2", "Norovirus"), col=c(sars.color, noro.color),
       pch=c(5, 2))

dev.off()
```

```{r}
png("Norovirus Endpoints (back to initial).png", width=6.5, height=7.5, unit="in", res=500)
par(mfrow=c(7, 3), mai=c(0.32, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))
for (p in noroParticipants) {
  pdat <- noro.FShedData[noro.FShedData$ID == p,]
  plot(log10(y_virus) ~ days, data=pdat,
       xlim=c(0, 29), ylim=c(0, 15), mgp=c(3, 0.5, 0), tck=-0.04)
  text(27, 13, p)
  abline(v = pdat[noro.maxt.backtoinitial[noro.maxt.backtoinitial$ID == p,]$max.point,]$days, col="red")
}
dev.off()

png("SARS-CoV-2 Endpoints (back to initial).png", width=6.5, height=7.5, unit="in", res=500)
par(mfrow=c(7, 3), mai=c(0.32, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))
for (p in sarsParticipants) {
  pdat <- sars.TShedData[sars.TShedData$ID == p,]
  plot(log10(y_virus) ~ days, data=pdat,
       xlim=c(0, 15), ylim=c(0, 15), mgp=c(3, 0.5, 0), tck=-0.04)
  text(12, 13, p)
  abline(v = pdat[sars.maxt.backtoinitial[sars.maxt.backtoinitial$ID == p,]$max.point,]$days, col="red")
}
dev.off()
```

We then plot the trajectories of each participant using both sets of endpoints.
Since they produce qualitatively similar fits, we arbitrarily use the first 
local minimum in pathogen load as the endpoint going forward.
```{r, fig.height = 7.5, fig.width = 6.5}
tiff("Participant trajectories norovirus.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(6, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(noroParticipants)) {
  
  p <- noroParticipants[i]
  participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
  sympdata <- noro.IncubData[noro.IncubData$ID==p, ]
  params <- unlist(noro.params.localmin[noro.params.localmin$ID==p,][2:5])
  maxt <- noro.maxt.firstmin[noro.maxt.firstmin$ID==p,]$max.point
  col <- noro.color
  pch <- noro.pch
  
  if (i==16) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else if (i %in% seq(1, 16, by=3)) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(15, 17)) {
     plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else {
    plot.viralload(
    data=participantdata,
    pars=params,
    sympdata=sympdata,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=col,
    pch=pch,
    ylim.lower = 7,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}
dev.off()

#Repeating with a different endpoint

tiff("Participant trajectories norovirus alternative endpoint.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(6, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(noroParticipants)) {
  
  p <- noroParticipants[i]
  participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
  sympdata <- noro.IncubData[noro.IncubData$ID==p, ]
  params <- unlist(noro.params.backtoinitial[noro.params.backtoinitial$ID==p,][2:5])
  maxt <- noro.maxt.backtoinitial[noro.maxt.backtoinitial$ID==p,]$max.point
  col <- noro.color
  pch <- noro.pch
  
  if (i==16) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      col=noro.color,
      pch=noro.pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else if (i %in% seq(1, 16, by=3)) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=noro.color,
      pch=noro.pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(15, 17)) {
     plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=noro.color,
      pch=noro.pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else {
    plot.viralload(
    data=participantdata,
    pars=params,
    sympdata=sympdata,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=noro.color,
    pch=noro.pch,
    ylim.lower = 7,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}

dev.off()

```

Plotting SARS-CoV-2 trajectories
```{r}
tiff("Participant Trajectories SARS-CoV-2.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(7, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(sarsParticipants)) {
  
  p <- sarsParticipants[i]
  participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
  sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
  params <- unlist(sars.params.localmin[sars.params.localmin$ID==p,][2:5])
  maxt <- sars.maxt.firstmin[sars.maxt.firstmin$ID==p,]$max.point
  
  if (i %in% seq(1, 13, by=3)) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(17, 18)) {
     plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else if (i==16) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else {
    plot.viralload(
    data=participantdata,
    sympdata=sympdata,
    pars=params,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=sars.color,
    pch=sars.pch,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}

dev.off()

# Repeating with a different endpoint

tiff("Participant Trajectories SARS-CoV-2 alternative endpoint.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(7, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(sarsParticipants)) {
  
  p <- sarsParticipants[i]
  participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
  sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
  params <- unlist(sars.params.backtoinitial[sars.params.backtoinitial$ID==p,][2:5])
  maxt <- sars.maxt.backtoinitial[sars.maxt.backtoinitial$ID==p,]$max.point
  
  if (i %in% seq(1, 13, by=3)) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(17, 18)) {
     plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else if (i==16) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else {
    plot.viralload(
    data=participantdata,
    sympdata=sympdata,
    pars=params,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=sars.color,
    pch=sars.pch,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}

dev.off()
```

We are excluding some participants due to unclear peaks.
```{r}
noroParticipants.all <- unique(noro.FShedData$ID)
noroParticipants <- unique(noro.FShedData[!(noro.FShedData$ID %in% c('ID5', 'ID20')),]$ID)

sarsParticipants.all <- unique(sars.TShedData$ID)
sarsParticipants <- unique(sars.TShedData[!(sars.TShedData$ID %in% c('Throat_1', 'Throat_12', 'Throat_13', 'Throat_14')),]$ID)
```

Here we calculate the delay between symptom onset and peak pathogen load for
each participant in the Atmar *et al*., 2008 study. The delay is in days.
```{r}
calculate.delay.conservative <- function(vldata, sympdata, params, maxt) {
  
  peak.vl.time <- calculate.peaktime(vldata, maxt, params)

  delay <- peak.vl.time - (sympdata$incubation * 24)
  
  return(delay/24)
}


delays.conservative.noro <- do.call(rbind,  
                               lapply(noroParticipants, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.conservative(noro.FShedData[noro.FShedData$ID == x, ],
                                                        noro.IncubData[noro.IncubData$ID == x,],
                                                        unlist(noro.params.localmin[noro.params.localmin$ID == x,][2:5]), 
                                                        noro.maxt.firstmin[noro.maxt.firstmin$ID == x,]))))

colnames(delays.conservative.noro) <- c('ID', 'delay')
```

We run a linear regression between the delay between symptom onset and peak
pathogen load and each of the 4 parameters from the statistical model as well
as between viral growth and decay rate. Only p2 and p4, which represent pathogen 
replication rate and time of peak pathogen load, respectively, were found to 
have significant correlations with delay. They are also significantly correlated 
 to each other.
```{r}
params.and.delays.conservative.noro <- merge(noro.params.localmin, delays.conservative.noro)

lm.fit.p1.delay.conservative.noro <- 
  lm(delay ~ p1, data=params.and.delays.conservative.noro)
p1.delay.conservative.pval.noro <- 
  summary(lm.fit.p1.delay.conservative.noro)$coefficients[2,4]
p1.delay.conservative.pval.noro

lm.fit.p2.delay.conservative.noro <- 
  lm(delay ~ p2, data=params.and.delays.conservative.noro)
p2.delay.conservative.pval.noro <- 
  summary(lm.fit.p2.delay.conservative.noro)$coefficients[2,4]
p2.delay.conservative.pval.noro

lm.fit.p3.delay.conservative.noro <- 
  lm(delay ~ p3, data=params.and.delays.conservative.noro)
p3.delay.conservative.pval.noro <- 
  summary(lm.fit.p3.delay.conservative.noro)$coefficients[2,4]
p3.delay.conservative.pval.noro

lm.fit.p4.delay.conservative.noro <- 
  lm(delay ~ p4, data=params.and.delays.conservative.noro)
p4.delay.conservative.pval.noro <- 
  summary(lm.fit.p4.delay.conservative.noro)$coefficients[2,4]
p4.delay.conservative.pval.noro

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.noro <- 
  lm(p4 ~ p2, data=params.and.delays.conservative.noro)
p4.p2.conservative.pval.noro <- 
  summary(lm.fit.p4.p2.conservative.noro)$coefficients[2,4]
p4.p2.conservative.pval.noro

# Test for collinearity
lm.fit.p2.p3.conservative.noro <-
  lm(p2 ~ p3, data=params.and.delays.conservative.noro)
p2.p3.conservative.pval.noro <-
  summary(lm.fit.p2.p3.conservative.noro)$coefficients[2,4]
p2.p3.conservative.pval.noro
```

Conservative delay SARS-CoV-2 data
```{r}
delays.conservative.sars <- do.call(rbind,  
                               lapply(sarsParticipants, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.conservative(sars.TShedData[sars.TShedData$ID == x, ],
                                                        sars.IncubData[sars.IncubData$ID == x,],
                                                        unlist(sars.params.localmin[sars.params.localmin$ID == x,][2:5]), 
                                                        sars.maxt.firstmin[sars.maxt.firstmin$ID == x,]))))

colnames(delays.conservative.sars) <- c('ID', 'delay')
```

Linear regression conservative delay SARS
```{r}
params.and.delays.conservative.sars <- merge(sars.params.localmin, delays.conservative.sars)

lm.fit.p1.delay.conservative.sars <- 
  lm(delay ~ p1, data=params.and.delays.conservative.sars)
p1.delay.conservative.pval.sars <- 
  summary(lm.fit.p1.delay.conservative.sars)$coefficients[2,4]
p1.delay.conservative.pval.sars

lm.fit.p2.delay.conservative.sars <- 
  lm(delay ~ p2, data=params.and.delays.conservative.sars)
p2.delay.conservative.pval.sars <- 
  summary(lm.fit.p2.delay.conservative.sars)$coefficients[2,4]
p2.delay.conservative.pval.sars

lm.fit.p3.delay.conservative.sars <- 
  lm(delay ~ p3, data=params.and.delays.conservative.sars)
p3.delay.conservative.pval.sars <- 
  summary(lm.fit.p3.delay.conservative.sars)$coefficients[2,4]
p3.delay.conservative.pval.sars

lm.fit.p4.delay.conservative.sars <- 
  lm(delay ~ p4, data=params.and.delays.conservative.sars)
p4.delay.conservative.pval.sars <- 
  summary(lm.fit.p4.delay.conservative.sars)$coefficients[2,4]
p4.delay.conservative.pval.sars

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.sars <- 
  lm(p4 ~ p2, data=params.and.delays.conservative.sars)
p4.p2.conservative.pval.sars <- 
  summary(lm.fit.p4.p2.conservative.sars)$coefficients[2,4]
p4.p2.conservative.pval.sars

# Test for collinearity
lm.fit.p2.p3.conservative.sars <-
  lm(p2 ~ p3, data=params.and.delays.conservative.sars)
p2.p3.conservative.pval.sars <-
  summary(lm.fit.p2.p3.conservative.sars)$coefficients[2,4]
p2.p3.conservative.pval.sars
```

Using a non-conservative measure of pre-symptomatic transmission, ie shedding
onset values as reported in the study, we calculate the delay between
shedding onset and symptom onset (the length of the latency period). For 
simplicity's sake, a negative delay still indicates pre-symptomatic transmission.

```{r}
shed.onset <- function(vldata) {
  if("y_type" %in% colnames(vldata)) {
    return(min(vldata[grepl('POS', vldata$y_type),]$days))
  } else {
    return(min(vldata[!is.na(vldata$y_virus),]$days))
  }
}

calculate.delay.nonconservative <- function(vldata, sympdata) {

  delay <- shed.onset(vldata) - sympdata$incubation 
  
  return(delay)
}

delays.nonconservative.noro <- do.call(rbind,  
                               lapply(noroParticipants.all, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.nonconservative(noro.FShedData[noro.FShedData$ID == x, ],
                                                        noro.IncubData[noro.IncubData$ID == x,]))))

colnames(delays.nonconservative.noro) <- c('ID', 'delay')
```

Non-conservative delays SARS
```{r}

delays.nonconservative.sars <- do.call(rbind,  
                               lapply(sarsParticipants.all, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.nonconservative(sars.TShedData[sars.TShedData$ID == x, ],
                                                        sars.IncubData[sars.IncubData$ID == x,]))))

colnames(delays.nonconservative.sars) <- c('ID', 'delay')
```

As before, we test for any significant correlations between the statistical 
model parameters and the duration of the latency period as well as
between viral growth and decay rate. Just as with the
conservative measure of pre-symptomatic transmission, there is a significant
correlation between both viral replication rate and time of peak pathogen load
with the duration of the latency period. We test for collinearity with
another linear regression, which returns positive.
```{r}
params.and.delays.nonconservative.noro <- merge(noro.params.localmin, delays.nonconservative.noro)

lm.fit.p1.delay.nonconservative.noro <- 
  lm(delay ~ p1, data=params.and.delays.nonconservative.noro)
p1.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p1.delay.nonconservative.noro)$coefficients[2,4]
p1.delay.nonconservative.pval.noro

lm.fit.p2.delay.nonconservative.noro <- 
  lm(delay ~ p2, data=params.and.delays.nonconservative.noro)
p2.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p2.delay.nonconservative.noro)$coefficients[2,4]
p2.delay.nonconservative.pval.noro

lm.fit.p3.delay.nonconservative.noro <- 
  lm(delay ~ p3, data=params.and.delays.nonconservative.noro)
p3.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p3.delay.nonconservative.noro)$coefficients[2,4]
p3.delay.nonconservative.pval.noro

lm.fit.p4.delay.nonconservative.noro <- 
  lm(delay ~ p4, data=params.and.delays.nonconservative.noro)
p4.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p4.delay.nonconservative.noro)$coefficients[2,4]
p4.delay.nonconservative.pval.noro
```

SARS nonconservative delay vs. params
```{r}
params.and.delays.nonconservative.sars <- merge(sars.params.localmin, delays.nonconservative.sars)

lm.fit.p1.delay.nonconservative.sars <- 
  lm(delay ~ p1, data=params.and.delays.nonconservative.sars)
p1.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p1.delay.nonconservative.sars)$coefficients[2,4]
p1.delay.nonconservative.pval.sars

lm.fit.p2.delay.nonconservative.sars <- 
  lm(delay ~ p2, data=params.and.delays.nonconservative.sars)
p2.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p2.delay.nonconservative.sars)$coefficients[2,4]
p2.delay.nonconservative.pval.sars

lm.fit.p3.delay.nonconservative.sars <- 
  lm(delay ~ p3, data=params.and.delays.nonconservative.sars)
p3.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p3.delay.nonconservative.sars)$coefficients[2,4]
p3.delay.nonconservative.pval.sars

lm.fit.p4.delay.nonconservative.sars <- 
  lm(delay ~ p4, data=params.and.delays.nonconservative.sars)
p4.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p4.delay.nonconservative.sars)$coefficients[2,4]
p4.delay.nonconservative.pval.sars
```

We also run a linear regression between pre-symptomatic transmission potential,
measured as average shedding prior to symptoms, and time of symptom onset. 
There is no correlation.
```{r}
presymp.transmission.potential <- function(vldata, sympdata) {
  
  vl.latent <- vldata[vldata$days < sympdata$incubation,]
  
  if(length(vl.latent[grepl('~', vl.latent$y_type),]$y_virus) > 0) {
    vl.latent[grepl('~', vl.latent$y_type),]$y_virus <- mean(c(15000, 4e7))
  }

  avg.shedding.latent <- log10(mean(vl.latent$y_virus, na.rm=T))
  
  return(avg.shedding.latent)
  
}

transmission.latent.noro <- do.call(rbind, 
                               lapply(noroParticipants.all, 
                                      function(x) 
                                        data.frame(x,
                                                   presymp.transmission.potential(noro.FShedData[noro.FShedData$ID == x,],
                                                                                  noro.IncubData[noro.IncubData$ID == x,]),
                                                   noro.IncubData[noro.IncubData$ID == x,]$incubation)))
  
colnames(transmission.latent.noro) <- c('ID', 'transmission_potential', 'symptom_onset')

transmission.latent.fit.noro <- lm(transmission_potential ~ symptom_onset, 
                              data = transmission.latent.noro)
transmission.latent.pval.noro <- 
  summary(transmission.latent.fit.noro)$coefficients[2,4]

transmission.latent.pval.noro

# SARS-CoV-2 data 

transmission.latent.sars <- do.call(rbind, 
                               lapply(sarsParticipants.all, 
                                      function(x) 
                                        data.frame(x,
                                                   presymp.transmission.potential(sars.TShedData[sars.TShedData$ID == x,],
                                                                                  sars.IncubData[sars.IncubData$ID == x,]),
                                                   sars.IncubData[sars.IncubData$ID == x,]$incubation)))
  
colnames(transmission.latent.sars) <- c('ID', 'transmission_potential', 'symptom_onset')

transmission.latent.fit.sars <- lm(transmission_potential ~ symptom_onset, 
                              data = transmission.latent.sars)
transmission.latent.pval.sars <- 
  summary(transmission.latent.fit.sars)$coefficients[2,4]

transmission.latent.pval.sars
```

Presymptomatic transmission potential via cumulative pre-symptomatic 
shedding.
```{r}
presymp.transmission.potential.cum <- function(vldata, sympdata) {
  
  vl.latent <- vldata[vldata$days < sympdata$incubation,]
  
  if(length(vl.latent[grepl('~', vl.latent$y_type),]$y_virus) > 0) {
    vl.latent[grepl('~', vl.latent$y_type),]$y_virus <- mean(c(15000, 4e7))
  }
  
  vl.latent[is.na(vl.latent$y_virus),]$y_virus <- 0

  if (length(vl.latent$y_virus) == 1) {
    auc.vl.latent <- log10(vl.latent$y_virus)
  } else {
    auc.vl.latent <- log10(trapz(vl.latent$days, vl.latent$y_virus))
  }
  
  if (is.infinite(auc.vl.latent)) {return(NaN)} else {return(auc.vl.latent)}
}

transmission.latent.cum.noro <- do.call(rbind, 
                               lapply(noroParticipants.all, 
                                      function(x) 
                                        data.frame(x,
                                                   presymp.transmission.potential.cum(noro.FShedData[noro.FShedData$ID == x,],
                                                                                      noro.IncubData[noro.IncubData$ID == x,]),
                                                   noro.IncubData[noro.IncubData$ID == x,]$incubation)))
  
colnames(transmission.latent.cum.noro) <- c('ID', 'transmission_potential', 'symptom_onset')

transmission.latent.cum.fit.noro <- lm(transmission_potential ~ symptom_onset, 
                              data = transmission.latent.cum.noro)
transmission.latent.cum.pval.noro <- 
  summary(transmission.latent.cum.fit.noro)$coefficients[2,4]

transmission.latent.cum.pval.noro

# SARS-CoV-2 data

transmission.latent.cum.sars <- do.call(rbind, 
                               lapply(sarsParticipants.all, 
                                      function(x) 
                                        data.frame(x,
                                                   presymp.transmission.potential.cum(sars.TShedData[sars.TShedData$ID == x,],
                                                                                      sars.IncubData[sars.IncubData$ID == x,]),
                                                   sars.IncubData[sars.IncubData$ID == x,]$incubation)))
  
colnames(transmission.latent.cum.sars) <- c('ID', 'transmission_potential', 'symptom_onset')

transmission.latent.cum.fit.sars <- lm(transmission_potential ~ symptom_onset, 
                              data = transmission.latent.cum.sars)
transmission.latent.cum.pval.sars <- 
  summary(transmission.latent.cum.fit.sars)$coefficients[2,4]

transmission.latent.cum.pval.sars
```

Lastly, we break down the correlation between pre-symptomatic transmission
and viral growth rate by examining the relationships between time of
peak shedding and viral growth rate as well as between symptom onset
and viral growth rate.

```{r, fig.height = 3, fig.width = 6.5}
participant.peaktimes.noro <- do.call(rbind, 
                               lapply(noroParticipants, 
                                      function(x) 
                                        data.frame(x,
                                                   calculate.peaktime(noro.FShedData[noro.FShedData$ID == x,],
                                                                      noro.maxt.firstmin[noro.maxt.firstmin$ID == x,],
                                                                      unlist(noro.params.localmin[noro.params.localmin$ID==x, 2:5])))))

colnames(participant.peaktimes.noro) <- c("ID", "peaktime")

params.peaktime.data.noro <- merge(merge(noro.params.localmin, participant.peaktimes.noro),
                              delays.conservative.noro)

lm.fit.p2.peaktime.noro <- lm(peaktime/24 ~ p2, data=params.peaktime.data.noro)
p2.peaktime.pval.noro <- summary(lm.fit.p2.peaktime.noro)$coefficients[2,4]
p2.peaktime.pval.noro

params.symp.data.noro <- merge(merge(noro.params.localmin, noro.IncubData[,c(1, 3)]),
                          delays.conservative.noro)
lm.fit.p2.symponset.noro <- lm(incubation ~ p2, data=params.symp.data.noro)
p2.symponset.pval.noro <- summary(lm.fit.p2.symponset.noro)$coefficients[2,4]
p2.symponset.pval.noro

# SARS-CoV-2 data
participant.peaktimes.sars <- do.call(rbind, 
                               lapply(sarsParticipants, 
                                      function(x) 
                                        data.frame(x,
                                                   calculate.peaktime(sars.TShedData[sars.TShedData$ID == x,],
                                                                      sars.maxt.firstmin[sars.maxt.firstmin$ID == x,],
                                                                      unlist(sars.params.localmin[sars.params.localmin$ID==x, 2:5])))))

colnames(participant.peaktimes.sars) <- c("ID", "peaktime")

params.peaktime.data.sars <- merge(merge(sars.params.localmin, participant.peaktimes.sars),
                              delays.conservative.sars)

lm.fit.p2.peaktime.sars <- lm(peaktime/24 ~ p2, data=params.peaktime.data.sars)
p2.peaktime.pval.sars <- summary(lm.fit.p2.peaktime.sars)$coefficients[2,4]
p2.peaktime.pval.sars

params.symp.data.sars <- merge(merge(sars.params.localmin, sars.IncubData),
                          delays.conservative.sars)
lm.fit.p2.symponset.sars <- lm(incubation ~ p2, data=params.symp.data.sars)
p2.symponset.pval.sars <- summary(lm.fit.p2.symponset.sars)$coefficients[2,4]
p2.symponset.pval.sars
```

We plot delay vs. inoculum dose, delay vs. viral growth rate, and pre-symptomatic
transmission potential vs. symptom onset in a 3-panel figure.
```{r, fig.height = 7.5, fig.width = 3.5}

plot.fig3 <- function(delays, params.delays.data, 
                      b.mod.noro, b.mod.sars,
                      c.mod.noro=NA, c.mod.sars=NA,
                      params.peaktime.data=NA,
                      d.mod.noro=NA, d.mod.sars=NA,
                      params.symp.data=NA,
                      transmission.latent.incubation.data=NA, 
                      e.mod.noro=NA, e.mod.sars=NA,
                      cex, cex_labels, 
                      panellabelratio, nonconservative = FALSE) {

  par(mfrow=c(5, 1), oma=c(0.5, 2, 0.5, 0), mai=c(0.3, 0.5, 0.1, 0.1))
  
  # Panel A: Delay between symptom onset and peak viral shedding 
  ylim.ab <- c(floor(min(delays$delay, na.rm=T))-1, 
               ceiling(max(delays$delay, na.rm=T))+1)
  
  plot(jitter(delay, 3) ~ ifelse(pathogen == 'Norovirus', 1, 2), data=delays,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       xlim=c(.5, 2.5),
       ylim=ylim.ab, cex.axis=cex, cex=cex,
       pch=ifelse(delay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(delay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(delay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                ifelse(delay > 0 & pathogen == 'SARS-CoV-2', 5,
                                       9)))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       yaxt="n",
       xaxt="n",
       ylab = "",
       xlab = "",
       mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  axis(1, at=seq(1,2), labels=unique(delays$pathogen), cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
       las=2)
  
  #Average delays per pathogen
  for (i in 1:length(unique(delays$pathogen))) {
    segments(-0.3 + i, 
             mean(delays[delays$pathogen == unique(delays$pathogen)[i],]$delay,
                  na.rm=T),
             -0.3 + i + 0.6, col=ifelse(unique(delays$pathogen)[i] == 'Norovirus', 
                                        noro.color, sars.color), 
             lwd=cex)
  }

  #Pre-symptomatic vs post-symptomatic line
  abline(h=0, lty=3, lwd=cex)
  
  text(panellabelratio * 2 + .5, panellabelratio * (ylim.ab[2] - ylim.ab[1]) + 
         ylim.ab[1], labels="A", cex=cex, font=2)
  
  # Panel B: Delay between symptom onset and peak viral shedding vs. viral
  # growth rate
  
  xlim.bcd <- c(floor(min(params.delays.data$p2)) - 1,
                ceiling(max(params.delays.data$p2)) + 1)
    
  plot(delay ~ p2, data=params.delays.data, 
     col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
     pch=ifelse(delay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(delay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(delay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                ifelse(delay > 0 & pathogen == 'SARS-CoV-2', 5,
                                       9)))),
     bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
     cex=cex, cex.axis=cex,
     ylab="", xlab="", xaxt="n", yaxt="n",
     ylim=ylim.ab,
     xlim=xlim.bcd,
     mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  
  bcd.xlabels <- lapply(seq(xlim.bcd[1], xlim.bcd[2], by=4), function(x) 
         bquote(10^.(x)))
  
  axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=4),
       labels=do.call(expression, bcd.xlabels),
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
       las=2)
  
  noro.r.range <- seq(min(
    params.delays.data[params.delays.data$pathogen == 'Norovirus',]$p2),
    max(params.delays.data[params.delays.data$pathogen == 'Norovirus',]$p2),
    length=10)
  
  sars.r.range <- seq(min(
    params.delays.data[params.delays.data$pathogen == 'SARS-CoV-2',]$p2),
    max(params.delays.data[params.delays.data$pathogen == 'SARS-CoV-2',]$p2),
    length=10)
  
  # Lines of best fit
  noro.bpred <- data.frame(p2 = noro.r.range)
  noro.bpred <- transform(noro.bpred, y_predicted = predict(b.mod.noro, newdata=noro.bpred))
  lines(y_predicted ~ p2, data=noro.bpred, col=noro.color)
  
  sars.bpred <- data.frame(p2 = sars.r.range)
  sars.bpred <- transform(sars.bpred, y_predicted = predict(b.mod.sars, newdata=sars.bpred))
  lines(y_predicted ~ p2, data=sars.bpred, col=sars.color)
  
  abline(h=0, lty=3, lwd=cex)
  
  if (nonconservative) {
    mtext(text=expression(Viral~replication~rate~(hour^-1)),
          side=1, line=2.5, cex=cex_labels)
    mtext(text="Day of shedding onset \n minus day of symptom onset",
          side=2, line=2.1, cex=cex_labels)
  } else {
    mtext(text="Day of peak viral shedding \n minus day of symptom onset",
          side=2, line=2.1, cex=cex_labels, adj=-0.5)
  }
  
  text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1])  + xlim.bcd[1], panellabelratio * (ylim.ab[2] - ylim.ab[1]) + 
         ylim.ab[1], labels="B", cex=cex, font=2)
  
  if (!nonconservative) {
    ylim.c <- c(floor(min(params.peaktime.data$peaktime/24)) - 1, 
                ceiling(max(params.peaktime.data$peaktime/24)) + 1)
    # Panel C: Time of peak shedding vs. viral replication rate
    plot(peaktime/24 ~ p2, data=params.peaktime.data,
         col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
         xlim=xlim.bcd,
         ylim=ylim.c, cex.axis=cex, cex=cex,
         pch=ifelse(delay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(delay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(delay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                ifelse(delay > 0 & pathogen == 'SARS-CoV-2', 5,
                                       9)))),
         bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         xaxt="n", yaxt="n", ylab = "", xlab = "",
         mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=2), 
       labels=do.call(expression, bcd.xlabels),
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    axis(2, at=seq(ylim.c[1],ylim.c[2], by=2), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, las=2)
    
      # Lines of best fit
    noro.cpred <- data.frame(p2 = noro.r.range)
    noro.cpred <- transform(noro.cpred, y_predicted = predict(c.mod.noro, newdata=noro.cpred))
    lines(y_predicted ~ p2, data=noro.cpred, col=noro.color)
    
    sars.cpred <- data.frame(p2 = sars.r.range)
    sars.cpred <- transform(sars.cpred, y_predicted = predict(c.mod.sars, newdata=sars.cpred))
    lines(y_predicted ~ p2, data=sars.cpred, col=sars.color)
    
    mtext(text="Day of \npeak shedding", side=2, line=2, cex=cex_labels)
    
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
         panellabelratio * (ylim.c[2] - ylim.c[1]) + ylim.c[1], labels="C", cex=cex, font=2)
      
    # Panel D: Symptom onset vs. viral replication rate
    ylim.d <- c(floor(min(params.symp.data$incubation, na.rm=T)) - 1, 
                ceiling(max(params.symp.data$incubation, na.rm=T)) + 1)
    
    plot(incubation ~ p2, data=params.symp.data,
         col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         xlim=xlim.bcd, ylim=ylim.d, cex.axis=cex, cex=cex,
         pch=ifelse(delay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(delay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(delay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                ifelse(delay > 0 & pathogen == 'SARS-CoV-2', 5,
                                       9)))),
         bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         yaxt="n", xaxt="n", ylab = "", xlab = "", bty='l')
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=2), 
       labels=do.call(expression, bcd.xlabels), 
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    
    axis(2, at=seq(ylim.d[1], ylim.d[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, las=2)
    
      # Lines of best fit
    noro.dpred <- data.frame(p2 = noro.r.range)
    noro.dpred <- transform(noro.dpred, y_predicted = predict(d.mod.noro, newdata=noro.dpred))
    lines(y_predicted ~ p2, data=noro.dpred, col=noro.color)
    
    sars.dpred <- data.frame(p2 = sars.r.range)
    sars.dpred <- transform(sars.dpred, y_predicted = predict(d.mod.sars, newdata=sars.dpred))
    lines(y_predicted ~ p2, data=sars.dpred, col=sars.color)
    
    mtext(text="Day of \nsymptom onset", side=2, line=2, cex=cex_labels)
    mtext(text=expression(Viral~replication~rate~(hour^-1)),
          side=1, line=2, cex=cex_labels)
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
         panellabelratio * (ylim.d[2] - ylim.d[1]) + ylim.d[1], 
         labels="D", cex=cex, font=2)
  
    # Panel E: Pre-symptomatic transmission potential vs. symptom onset
  
    xlim.e <- c(floor(min(transmission.latent.incubation.data$symptom_onset,
                    na.rm=T)) - 1,
                ceiling(max(transmission.latent.incubation.data$symptom_onset,
                    na.rm=T)) + 1)
    
    ylim.e <- c(floor(min(transmission.latent.incubation.data$transmission_potential,
                    na.rm=T)) - 1,
                ceiling(max(transmission.latent.incubation.data$transmission_potential,
                    na.rm=T)) + 1)
    
    plot(transmission_potential ~ jitter(symptom_onset), 
         data=merge(delays, transmission.latent.incubation.data, by='ID',
                    all.y=T),
         col=ifelse(pathogen.y == 'Norovirus', noro.color, sars.color), 
         pch=ifelse(is.na(ifelse(delay < 0 & pathogen.y == 'Norovirus', 17, 
                ifelse(delay > 0 & pathogen.y == 'Norovirus', 2,
                       ifelse(delay < 0 & pathogen.y == 'SARS-CoV-2',
                              23, 5)))) | delay == 0,
                9, 
                ifelse(delay < 0 & pathogen.y == 'Norovirus', 17, 
                ifelse(delay > 0 & pathogen.y == 'Norovirus', 2,
                       ifelse(delay < 0 & pathogen.y == 'SARS-CoV-2',
                              23, 5)))),
         bg=ifelse(pathogen.y == 'Norovirus', noro.color, sars.color), 
         ylim=ylim.e,
         xlim=xlim.e,
         cex.axis=cex, cex=cex,
         ylab = "",
         xlab = "",
         xaxt="n",
         yaxt="n", bty='l')
    
    e.ylabels <- lapply(seq(ylim.e[1], ylim.e[2], by=2.5), function(x) 
         bquote(10^.(x)))
    axis(1, cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04)
    axis(2, cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, at=seq(ylim.e[1], ylim.e[2], by=2.5),
         labels=do.call(expression, e.ylabels),
         las=2)
    
    legend(.375 * (xlim.e[2] - xlim.e[1]) + xlim.e[1], 
           .9 * (ylim.e[2] - ylim.e[1]) + ylim.e[1], 
           legend=c("Pre-symptomatic", "Post-symptomatic", 
                    "Unclear peak (this panel only)"), 
       pch=c(19, 1, 9), col=c("black", "black", "black"), cex=cex_labels, bty="n")
  
    mtext(text="Average viral shedding \n prior to symptom onset",
          side=2, line=3, cex=cex_labels)
    mtext(text="Symptom onset (day)", side=1, line=1.5, cex=cex_labels)
    
      # Lines of best fit
    noro.epred <- data.frame(symptom_onset= 
                               seq(min(transmission.latent.incubation.data[
                                 transmission.latent.incubation.data$pathogen == 'Norovirus',]$symptom_onset, na.rm=T), 
                                  max(transmission.latent.incubation.data[
                                    transmission.latent.incubation.data$pathogen == 'Norovirus',]$symptom_onset, na.rm=T), length=10))
    noro.epred <- transform(noro.epred, y_predicted = predict(e.mod.noro, newdata=noro.epred))
    lines(y_predicted ~ symptom_onset, data=noro.epred, col=noro.color)
    
    sars.epred <- data.frame(symptom_onset = 
                               seq(min(transmission.latent.incubation.data[
                                 transmission.latent.incubation.data$pathogen == 'SARS-CoV-2',]$symptom_onset, na.rm=T), 
                                  max(transmission.latent.incubation.data[
                                    transmission.latent.incubation.data$pathogen == 'SARS-CoV-2',]$symptom_onset, na.rm=T), length=10))
    sars.epred <- transform(sars.epred, y_predicted = predict(e.mod.sars, newdata=sars.epred))
    lines(y_predicted ~ symptom_onset, data=sars.epred, col=sars.color)
    
    text(panellabelratio * (xlim.e[2] - xlim.e[1]) + xlim.e[1], 
         panellabelratio * (ylim.e[2] - ylim.e[1]) + ylim.e[1], 
         labels="E", cex=cex, font=2)
  }

}

combined.delays.conservative <- rbind(delays.conservative.noro, delays.conservative.sars)
combined.delays.conservative$pathogen <- ifelse(grepl('ID', 
                                                      combined.delays.conservative$ID), 
                                                'Norovirus', 'SARS-CoV-2')

params.and.delays.conservative.combined <- rbind(params.and.delays.conservative.noro, 
                                    params.and.delays.conservative.sars)
params.and.delays.conservative.combined$pathogen <- ifelse(grepl('ID', 
                                                      params.and.delays.conservative.combined$ID), 
                                                'Norovirus', 'SARS-CoV-2')

transmission.latent.combined <- rbind(transmission.latent.noro, transmission.latent.sars)
transmission.latent.combined$pathogen <- ifelse(grepl('ID', 
                                                      transmission.latent.combined$ID), 
                                                'Norovirus', 'SARS-CoV-2')

combined.params.peaktime.data <- rbind(params.peaktime.data.noro, params.peaktime.data.sars)
combined.params.peaktime.data$pathogen <- ifelse(grepl('ID', 
                                                      combined.params.peaktime.data$ID), 
                                                'Norovirus', 'SARS-CoV-2')

combined.params.sympdata <- rbind(params.symp.data.noro, params.symp.data.sars)
combined.params.sympdata$pathogen <- ifelse(grepl('ID', 
                                                      combined.params.sympdata$ID), 
                                                'Norovirus', 'SARS-CoV-2')

tiff("Pre-symptomatic transmission analysis.tiff", res=500, height=6.5, width=3.5, unit="in")

plot.fig3(
  delays = combined.delays.conservative, 
  params.delays.data = params.and.delays.conservative.combined,
  b.mod.noro = lm.fit.p2.delay.conservative.noro, 
  b.mod.sars = lm.fit.p2.delay.conservative.sars,
  c.mod.noro = lm.fit.p2.peaktime.noro,
  c.mod.sars = lm.fit.p2.peaktime.sars,
  params.peaktime.data = combined.params.peaktime.data,
  d.mod.noro = lm.fit.p2.symponset.noro,
  d.mod.sars = lm.fit.p2.symponset.sars,
  params.symp.data = combined.params.sympdata,
  transmission.latent.incubation.data = transmission.latent.combined,
  e.mod.noro = transmission.latent.fit.noro,
  e.mod.sars = transmission.latent.fit.sars,
  cex=1.1, cex_labels=0.75, panellabelratio=0.975)

dev.off()
```

We again plot delay vs. inoculum dose and delay vs. viral growth rate using
the non-conservative measure of pre-symptomatic transmission.

```{r, fig.height = 6, fig.width = 3.5}

combined.delays.nonconservative <- rbind(delays.nonconservative.noro, delays.nonconservative.sars)
combined.delays.nonconservative$pathogen <- ifelse(grepl('ID', 
                                                      combined.delays.nonconservative$ID), 
                                                'Norovirus', 'SARS-CoV-2')

params.and.delays.nonconservative.combined <- rbind(params.and.delays.nonconservative.noro, 
                                    params.and.delays.nonconservative.sars)
params.and.delays.nonconservative.combined$pathogen <- ifelse(grepl('ID', 
                                                      params.and.delays.nonconservative.combined$ID), 
                                                'Norovirus', 'SARS-CoV-2')

tiff("Non-conservative pre-symptomatic transmission analysis.tiff", res=500, height=6.5, width=3.5, unit="in")

plot.fig3(
  delays = combined.delays.nonconservative, 
  params.delays.data = params.and.delays.nonconservative.combined,
  b.mod.noro = lm.fit.p2.delay.nonconservative.noro, 
  b.mod.sars = lm.fit.p2.delay.nonconservative.sars,
  cex=1.1, cex_labels=0.75, panellabelratio=0.975,
  nonconservative = TRUE)

dev.off()

```

Comparing raw Atmar data to published Atmar data
```{r}
atmar.ShedData <- read.csv("atmardata.csv")[, 1:3]
colnames(atmar.ShedData) <- c('ID', 'days', 'y_virus')

atmar.IncubData <- read.csv("atmarsymptoms.csv")[, 1:2]
colnames(atmar.IncubData) <- c('ID', 'incubation')

atmarParticipants <- unique(atmar.ShedData$ID)

atmar.maxt.firstmin <- do.call(rbind, 
                         lapply(atmarParticipants, 
                                function(x) data.frame(x, 
                                                       first.local.min(
                                                         atmar.ShedData[atmar.ShedData$ID == x,]))))
colnames(atmar.maxt.firstmin) <- c('ID', 'max.point')

atmar.fits.localmin <- all.fits(atmar.ShedData, atmar.maxt.firstmin, 100,
                               detect.threshold = log10(noro.detection.threshold), 
                               detect.threshold.2 = log10(noro.detection.threshold.2))
atmar.params.localmin <- participant.params(atmar.fits.localmin)

par(mfrow=c(6, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(atmarParticipants)) {
  
  p <- atmarParticipants[i]
  participantdata <- atmar.ShedData[atmar.ShedData$ID==p, ]
  sympdata <- atmar.IncubData[atmar.IncubData$ID==p, ]
  params <- unlist(atmar.params.localmin[atmar.params.localmin$ID==p,][2:5])
  maxt <- atmar.maxt.firstmin[atmar.maxt.firstmin$ID==p,]$max.point
  col <- noro.color
  pch <- noro.pch
  
  plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="")
  
  
}

atmarParticipants <- atmarParticipants[!atmarParticipants %in% c(707, 723, 731)]
delays.conservative.noro.atmar <- do.call(rbind,  
                               lapply(atmarParticipants, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.conservative(
                                                     atmar.ShedData[atmar.ShedData$ID == x, ],
                                                     atmar.IncubData[atmar.IncubData$ID == x,],
                                                     unlist(atmar.params.localmin[atmar.params.localmin$ID == x,][2:5]), 
                                                     atmar.maxt.firstmin[atmar.maxt.firstmin$ID == x,]))))

colnames(delays.conservative.noro.atmar) <- c('ID', 'delay')

params.and.delays.conservative.noro.atmar <- merge(atmar.params.localmin, delays.conservative.noro.atmar)

lm.fit.p1.delay.conservative.noro.atmar <- 
  lm(delay ~ p1, data=params.and.delays.conservative.noro.atmar)
p1.delay.conservative.pval.noro.atmar <- 
  summary(lm.fit.p1.delay.conservative.noro.atmar)$coefficients[2,4]
p1.delay.conservative.pval.noro.atmar

lm.fit.p2.delay.conservative.noro.atmar <- 
  lm(delay ~ p2, data=params.and.delays.conservative.noro.atmar)
p2.delay.conservative.pval.noro.atmar <- 
  summary(lm.fit.p2.delay.conservative.noro.atmar)$coefficients[2,4]
p2.delay.conservative.pval.noro.atmar

lm.fit.p3.delay.conservative.noro.atmar <- 
  lm(delay ~ p3, data=params.and.delays.conservative.noro.atmar)
p3.delay.conservative.pval.noro.atmar <- 
  summary(lm.fit.p3.delay.conservative.noro.atmar)$coefficients[2,4]
p3.delay.conservative.pval.noro.atmar

lm.fit.p4.delay.conservative.noro.atmar <- 
  lm(delay ~ p4, data=params.and.delays.conservative.noro.atmar)
p4.delay.conservative.pval.noro.atmar <- 
  summary(lm.fit.p4.delay.conservative.noro.atmar)$coefficients[2,4]
p4.delay.conservative.pval.noro.atmar

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.noro.atmar <- 
  lm(p4 ~ p2, data=params.and.delays.conservative.noro.atmar)
p4.p2.conservative.pval.noro.atmar <- 
  summary(lm.fit.p4.p2.conservative.noro.atmar)$coefficients[2,4]
p4.p2.conservative.pval.noro.atmar

# Test for collinearity
lm.fit.p2.p3.conservative.noro.atmar <-
  lm(p2 ~ p3, data=params.and.delays.conservative.noro.atmar)
p2.p3.conservative.pval.noro.atmar <-
  summary(lm.fit.p2.p3.conservative.noro.atmar)$coefficients[2,4]
p2.p3.conservative.pval.noro.atmar

atmar.ShedDataNonconservative <- read.csv("atmarshedding.csv")[, c(1, 3)]
colnames(atmar.ShedDataNonconservative) <- c('ID', 'shed.onset')
atmar.Nonconservative <- merge(atmar.ShedDataNonconservative, atmar.IncubData)

delays.nonconservative.noro.atmar <- do.call(rbind,  
                               lapply(atmarParticipants, 
                                      function(x) 
                                        data.frame(x, 
                                                   atmar.Nonconservative[
                                                     atmar.Nonconservative$ID == x,
                                                   ]$shed.onset - 
                                                     atmar.Nonconservative[
                                                     atmar.Nonconservative$ID == x,
                                                   ]$incubation)))

colnames(delays.nonconservative.noro.atmar) <- c('ID', 'delay')

params.and.delays.nonconservative.noro.atmar <- merge(atmar.params.localmin, delays.nonconservative.noro.atmar)

lm.fit.p1.delay.nonconservative.noro.atmar <- 
  lm(delay ~ p1, data=params.and.delays.nonconservative.noro.atmar)
p1.delay.nonconservative.pval.noro.atmar <- 
  summary(lm.fit.p1.delay.nonconservative.noro.atmar)$coefficients[2,4]
p1.delay.nonconservative.pval.noro.atmar

lm.fit.p2.delay.nonconservative.noro.atmar <- 
  lm(delay ~ p2, data=params.and.delays.nonconservative.noro.atmar)
p2.delay.nonconservative.pval.noro.atmar <- 
  summary(lm.fit.p2.delay.nonconservative.noro.atmar)$coefficients[2,4]
p2.delay.nonconservative.pval.noro.atmar

lm.fit.p3.delay.nonconservative.noro.atmar <- 
  lm(delay ~ p3, data=params.and.delays.nonconservative.noro.atmar)
p3.delay.nonconservative.pval.noro.atmar <- 
  summary(lm.fit.p3.delay.nonconservative.noro.atmar)$coefficients[2,4]
p3.delay.nonconservative.pval.noro.atmar

lm.fit.p4.delay.nonconservative.noro.atmar <- 
  lm(delay ~ p4, data=params.and.delays.nonconservative.noro.atmar)
p4.delay.nonconservative.pval.noro.atmar <- 
  summary(lm.fit.p4.delay.nonconservative.noro.atmar)$coefficients[2,4]
p4.delay.nonconservative.pval.noro.atmar
```