---
title: "Analyzing human infection data (norovirus and SARS-CoV-2)"
author: "Kayla Zhang, Damie Pak, Megan Greischar"
date: "2024-04-27"
output:
  bookdown::pdf_document2:
    toc: no
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warnings = FALSE)
```

Packages we use
```{r}
library(here)
library(pzfx)
library(data.table)
library(spatialEco)
library(pracma)
```

### Importing/cleaning data

We use the shedding and symptom timing data that Ge *et al*., 2023 obtained 
from a norovirus study (Atmar *et al*., 2008). We exclude participants with 
less than 5 quantitative viral shedding points to avoid overfitting the 
statistical model. This data also contains qualitative test results for 
viral shedding values (positive or negative) falling below the qRT-PCR detection 
threshold. Any shedding values below the detection threshold for quantitative
results are set to NA.
```{r, echo = TRUE, eval = FALSE}
exclude.participants <- function(p, data) {
  pdata <- data[data$ID == p, ]
  
  if(nrow(pdata[!is.na(pdata$y_virus),]) < 5) {
    return(p)
  }
}

noroData <- readRDS(here("data", "norodata.rds")) 

write.table(noroData$ftsshedding, "noroFtsData.txt")
noro.FShedData <- read.table("noroFtsData.txt", stringsAsFactors = F)
noro.FShedData <- noro.FShedData[, c(1, 2, 5, 6, 8)]

write.table(noroData$incubation, "noroIncubationData.txt")
noro.IncubData <- read.table("noroIncubationData.txt", stringsAsFactors = F)
noro.IncubData <- noro.IncubData[, c(1, 2, 5)]

# Get rid of viral shedding numbers below the qRT-PCR detection threshold 
# (4e7 copies /ml)
noro.detection.threshold <- 15000
noro.detection.threshold.2 <- 4e7
noro.FShedData[noro.FShedData$y_virus <= noro.detection.threshold.2,]$y_virus <- NA

# Exclude participants with less than 5 points of data 
noro.excluded <- unlist(lapply(unique(noro.FShedData$ID), exclude.participants, 
                               data=noro.FShedData))

noro.excluded <- noro.excluded[!is.null(noro.excluded)]

noro.FShedData <- noro.FShedData[!(noro.FShedData$ID %in% noro.excluded),]
noro.IncubData <- noro.IncubData[!(noro.IncubData$ID %in% noro.excluded),]

# Average across viral shedding values at the same time point
aggregated_virus <- aggregate(y_virus ~ ID + days, 
                              noro.FShedData,
                              mean,
                              na.action=na.pass)
aggregated_virus <- aggregated_virus[order(as.numeric(substring(aggregated_virus$ID, 3, 4)),
                       aggregated_virus$days),]$y_virus

noro.FShedData <- noro.FShedData[!duplicated(noro.FShedData[, c(1, 3)]),]
noro.FShedData$y_virus <- aggregated_virus
```

We extract the shedding and symptom timing data from Zhou *et al*., 2023, 
a SARS-CoV-2 study, as well.
```{r}
extract.incubation <- function(symp.data) {
  
  symptom.indexes <- symp.data[which(symp.data[, 2] > 0),]$ROWTITLE
  
  if (length(symptom.indexes) == 0) {
    symp.onset <- NA
  } else {
    symp.onset <- min(symptom.indexes) 
  }
  
  incub.data <- data.frame("ID" = colnames(symp.data)[2], "incubation" = symp.onset)
  
  return(incub.data)
}

sars.TShedData <- read_pzfx(here("data", "SARS-Supp-2.pzfx"), table=37)[, c(1, 20:37)]
sars.TShedData <- melt(as.data.table(sars.TShedData), id.vars=c("Day"), 
                       variable.name = "ID", value.name = "y_virus", 
                       variable.factor = F)
colnames(sars.TShedData)[1] <- "days"

incub.indexes <- 37:54
sars.IncubData <- data.frame(do.call(rbind, 
                                     lapply(incub.indexes, 
                                            function(x) 
                                              extract.incubation(
                                                read_pzfx(here("data", "SARS-Fig-1.pzfx"), 
                                                    table=x)))))

# Participants were matched up by visually comparing viral shedding values

ID_dict_sars <- c("680539" = "Throat_10",
"673353" = "Throat_18",
"667186" = "Throat_11",
"550630" = "Throat_7",
"635495" = "Throat_1",
"666482" = "Throat_9",
"651806" = "Throat_15",
"635331" = "Throat_5",
"634105" = "Throat_2",
"635779" = "Throat_16",
"635729" = "Throat_4",
"637340" = "Throat_12",
"627506" = "Throat_6",
"666660" = "Throat_8",
"676586" = "Throat_13",
"666427" = "Throat_14",
"647785" = "Throat_3",
"674700" = "Throat_17"
)

sars.IncubData$ID <- ID_dict_sars[sars.IncubData$ID]

# Get rid of viral shedding below the detection threshold (1200 copies/ml)
sars.detection.threshold <- 1200
sars.TShedData[sars.TShedData$y_virus < sars.detection.threshold,]$y_virus <- NA

# Exclude participants with less than 5 points of data 
sars.excluded <- unlist(lapply(unique(sars.TShedData$ID), exclude.participants, data=sars.TShedData))

sars.excluded <- sars.excluded[!is.null(sars.excluded)]

sars.TShedData <- sars.TShedData[!(sars.TShedData$ID %in% sars.excluded),]
sars.IncubData <- sars.IncubData[!(sars.IncubData$ID %in% sars.excluded),]
```

We calculate each study's average shedding and symptom onset.
```{r}
shed.onset <- function(vldata) {
  if("y_type" %in% colnames(vldata)) {
    return(min(vldata[grepl('POS', vldata$y_type),]$days))
  } else {
    return(min(vldata[!is.na(vldata$y_virus),]$days))
  }
}

noroParticipants <- unique(noro.FShedData$ID)

noro.avg.shed.onset <- mean(unlist(lapply(noroParticipants, function(x) 
  shed.onset(noro.FShedData[noro.FShedData$ID == x, ]))))
noro.avg.shed.onset

noro.avg.symp.onset <- mean(noro.IncubData$incubation)
noro.avg.symp.onset

sarsParticipants <- unique(sars.TShedData$ID)

sars.avg.shed.onset <- mean(unlist(lapply(sarsParticipants, function(x) 
  shed.onset(sars.TShedData[sars.TShedData$ID == x, ]))))
sars.avg.shed.onset

sars.avg.symp.onset <- mean(sars.IncubData$incubation, na.rm=T)
sars.avg.symp.onset
```

### Fitting statistical model to observed shedding values

We fit a statistical model (Li & Handel, 2014, Holder & Beauchemin, 2011) to each
individual's shedding data that estimates viral load over time using the 
least squares method. There is a typo in Li & Handel, 2014 in the denominator, 
where the term exp(p4 * (t-p3)) is written as exp(-p4 * (t-p3)) (Holder & 
Beauchemin, 2011). We make the assumption that viral load is a 1-to-1 mapping to 
viral shedding. 

When model estimates incorrectly lie outside a given detection range,
we calculate the SSE of that point using the nearest detection threshold as 
the "observed" data point.
```{r}
generate.estimates <- function(t, pars) {
  
  p1 <- exp(pars[1])
  p2 <- exp(pars[2])
  p3 <- exp(pars[3])
  p4 <- exp(pars[4])
  
  estimate <- (2 * p1) / (exp(-p2*(t-p3)) + exp(p4*(t-p3)))
  return(log10(estimate))
  
} 

sse.viralLoad <- function(pars, data, detect.threshold, detect.threshold.2 = NA) {
  vl <- log10(data$y_virus)
  t <- data$days * 24
  
  estimates <- generate.estimates(t, pars)
  
  # Punishing model estimates that incorrectly lie above the detection
  # threshold
  vl[which(is.na(vl) & estimates > detect.threshold)] <- detect.threshold
  
  # Punishing model estimates that incorrectly lie outside the detection range of 
  # qualitative results
  vl[which(grepl('~', data$y_type) & estimates < detect.threshold)] <- detect.threshold 
  vl[which(grepl('~', data$y_type) & estimates > detect.threshold.2)] <- detect.threshold.2
  
  sse <- sum((estimates - vl)^2, na.rm=TRUE)

  if (sse > 1e20) {
    return(1e20)
  } else {
    return(sse)
  }
  
}

generate.possible.params <- function(data, detect.threshold,
                                     detect.threshold.2 = NA) {
  
  # These are ln(param) values
  
  p1 <- runif(1, -1, log(1e12))
  p2 <- runif(1, -1, 1) 
  p3 <- runif(1, -1, log(4 * 24))
  p4 <- runif(1, -5, 1)
  
  params <- c(p1, p2, p3, p4)

  fit <- optim(params, sse.viralLoad, data=data, detect.threshold=detect.threshold,
               detect.threshold.2=detect.threshold.2)
  
  param.guess <- data.frame(unique(data$ID), 
                         fit$par[1],
                         fit$par[2],
                         fit$par[3],
                         fit$par[4],
                         fit$convergence, 
                         fit$value)
  
  return(param.guess)
  
}

generate.fits <- function(data, numguess, detect.threshold, detect.threshold.2 = NA) {

  fits <- do.call(rbind, 
                  lapply(1:numguess,
                         function(x) generate.possible.params(data, detect.threshold,
                                                              detect.threshold.2))) 
  
  colnames(fits) <- c('ID', 'p1','p2','p3','p4','convergence','sse')
  return(fits)
}

params.minsse <- function(fits) {
  
  minsse <- min(fits[fits$convergence==0, ]$sse)
  pars <- unlist((fits[fits$sse == minsse, ])[1:5])
  return(pars)
}
 
```

For endpoints, we looked at values on or after the fifth data point, to
ensure we are not overfitting the model. We define two 
endpoints: 1) stopping at the first local minimum in viral shedding (two greater 
points at each side), and 2) stopping at the first viral shedding value that is 
equal to or less than the first observed shedding value. If there are 
no data points that meet these criteria, we set the endpoint to the last 
viral shedding value.
```{r}
first.local.min <- function(data) {
       
  quantifiable.vl <- data[!is.na(data$y_virus),]$y_virus
  quantifiable.vl <- quantifiable.vl[3:length(quantifiable.vl)]
  
  minima <- local.min.max(quantifiable.vl)$minima

  for (mi in minima) {
    
    min.index <- min(which(quantifiable.vl == mi))
    data.context <- quantifiable.vl[(min.index - 2): (min.index + 2)]
    
    if(length(na.omit(data.context)) == 5 & (min(data.context) == mi)) {
      return(min(which(data$y_virus==quantifiable.vl[min.index])))
    }
  }

  return(max(which(data$y_virus == quantifiable.vl[length(quantifiable.vl)])))
  
}

back.to.initial <- function(data) {
  
  quantifiable.vl <- data[!is.na(data$y_virus),]$y_virus 
  less.than.initial <- which(quantifiable.vl[5:length(quantifiable.vl)] <= 
                               quantifiable.vl[1])

  if (length(less.than.initial) == 0) {
    return(which(data$y_virus == quantifiable.vl[length(quantifiable.vl)]))
  } else {
    return(which(data$y_virus == quantifiable.vl[min(less.than.initial)+4]))
  }
}

all.fits <- function(data, maxt, numguess, detect.threshold, detect.threshold.2 = NA) {
  
  participants <- unique(data$ID)

  participantfits <- do.call(rbind,
                             lapply(participants,
                                    function(x) 
                                      generate.fits(data[data$ID==x,][1:(maxt[maxt$ID==x,]$max.point),],
                                                    numguess, detect.threshold,
                                                    detect.threshold.2)))
  
  return(participantfits)
}

participant.params.minsse <- function(fits) {
  
  participants <- unique(fits$ID)
  
  participantparams <- data.frame(do.call(rbind, 
                               lapply(participants, 
                                      function(x) params.minsse(fits[fits$ID == x,]))))
  
  colnames(participantparams) <- c("ID", "p1", "p2",
                               "p3", "p4")
  
  participantparams[, 2:5] <- apply(participantparams[, 2:5], 2, as.numeric)
  
  return(participantparams)
}

# Setting the endpoint as the first local minimum
noro.maxt.firstmin <- do.call(rbind, 
                         lapply(noroParticipants, 
                                function(x) data.frame(x, 
                                                       first.local.min(noro.FShedData[noro.FShedData$ID == x,]))))
colnames(noro.maxt.firstmin) <- c('ID', 'max.point')

# SARS-CoV-2 data
sars.maxt.firstmin <- do.call(rbind, 
                         lapply(sarsParticipants, 
                                function(x) data.frame(x, 
                                                       first.local.min(sars.TShedData[sars.TShedData$ID == x,]))))
colnames(sars.maxt.firstmin) <- c('ID', 'max.point')

# Setting the endpoint as the first time that viral load decreases to the 
# initial viral load or lower

noro.maxt.backtoinitial <- do.call(rbind, 
                         lapply(noroParticipants, 
                                function(x) data.frame(x, 
                                                       back.to.initial(noro.FShedData[noro.FShedData$ID == x,]))))
colnames(noro.maxt.backtoinitial) <- c('ID', 'max.point')

# SARS-CoV-2 data
sars.maxt.backtoinitial <- do.call(rbind, 
                         lapply(sarsParticipants, 
                                function(x) data.frame(x, 
                                                       back.to.initial(sars.TShedData[sars.TShedData$ID == x,]))))
colnames(sars.maxt.backtoinitial) <- c('ID', 'max.point')

```

Note that because this model is statistical, not deterministic, the parameters
will fluctuate with each run. We account for this uncertainty later on by 
producing confidence bounds in our analyses via bootstrapping/case resampling.
```{r, eval = FALSE}
noro.fits.localmin <- all.fits(noro.FShedData, noro.maxt.firstmin, 100,
                               detect.threshold = log10(noro.detection.threshold), 
                               detect.threshold.2 = log10(noro.detection.threshold.2))
noro.params.localmin <- participant.params.minsse(noro.fits.localmin)

sars.fits.localmin <- all.fits(sars.TShedData, sars.maxt.firstmin, 100,
                               detect.threshold = log10(sars.detection.threshold))
sars.params.localmin <- participant.params.minsse(sars.fits.localmin)

noro.fits.backtoinitial <- all.fits(noro.FShedData, noro.maxt.backtoinitial, 100,
                                    detect.threshold = log10(noro.detection.threshold), 
                                    detect.threshold.2 = log10(noro.detection.threshold.2))
noro.params.backtoinitial <- participant.params.minsse(noro.fits.backtoinitial)

sars.fits.backtoinitial <- all.fits(sars.TShedData, sars.maxt.backtoinitial, 100,
                                    detect.threshold = log10(sars.detection.threshold))
sars.params.backtoinitial <- participant.params.minsse(sars.fits.backtoinitial)
```

As a result, we saved the results of our first iteration in a csv file.
```{r}
noro.fits.localmin <- read.csv(here("data", "Ge fits local minimum.csv"))
noro.params.localmin <- read.csv(here("data", "Ge parameters local minimum.csv"))

sars.fits.localmin <- read.csv(here("data", "Zhou fits local minimum.csv"))
sars.params.localmin <- read.csv(here("data", "Zhou parameters local minimum.csv"))

noro.fits.backtoinitial <- read.csv(here("data", "Ge fits back to initial.csv"))
noro.params.backtoinitial <- read.csv(here("data", "Ge parameters back to initial.csv"))

sars.fits.backtoinitial <- read.csv(here("data", "Zhou fits back to initial.csv"))
sars.params.backtoinitial <- read.csv(here("data", "Zhou parameters back to initial.csv"))
```

We proceed to plot trajectories for every individual.
```{r, fig.height = 7.5, fig.width = 3.5}
plot.viralload <- function(data, pars, sympdata, max.modeltime, cex=1,
                           xaxisLabs = T, yaxisLabs = T, col, pch, ylim.lower=3,
                           cex_labels, cex.axis, xlabel, ylabel, panellabel,
                           example=FALSE) {

  # Plotting real shedding values
  plot(1, col=col, xlim=c(0, 25), 
       ylim=c(ylim.lower, 15), xlab="", ylab="", xaxt="n", yaxt="n", cex.lab=cex, 
       cex.axis=cex, font.lab=2, bty='n')
  
  points(data$days, log10(data$y_virus), col=col, cex=cex, pch=pch)
  
  # Grey rectangles where viral shedding is a range (qualitative results)
  range.indexes <- which(is.na(data$y_virus) & grepl('POS', data$y_type))
  rectangle.x_vals <- lapply(range.indexes, function(x) c(data[x-1,]$days + 0.25, 
                                                          data[x+1,]$days - 0.25))
  lapply(rectangle.x_vals, function(x) 
    rect(x[1], log10(15000), x[2], log10(4e7), border=NA, col="lightgray"))
  
  
  # Plotting simulated VL
  linet <- seq(min(data[!is.na(data$y_virus),]$days) * 24, 
                 data[max.modeltime,]$days * 24, by=1)

  predictedvl <- generate.estimates(linet, pars)

  lines(linet / 24, predictedvl, col=col)
  
  # Symptom onset
  symp.onset <- sympdata$incubation
  
  abline(v = symp.onset, col=col, lty=2)
  
  # Peak shedding
  t.peak <- linet[which(predictedvl == max(predictedvl))]/24

  if (is.na(symp.onset)) {
    redpointstyle <- NA
  } else if (t.peak < symp.onset) {
    redpointstyle <- 19
  } else {
    redpointstyle <- 1
  }
  
  if (!example) {
    text(x=18, y=12, labels=unique(data$ID), font=2)
  }
  
  ylabel.line <- 4.5
  xlabel.line <- 3.5

  points(t.peak, max(predictedvl), pch=redpointstyle,
         col="red", lwd=cex, cex=cex)

  xLabs = NA
  if(xaxisLabs==T){
        xLabs = c(expression(0),
                  expression(5),
                  expression(10),
                  expression(15),
                  expression(20),
                  expression(25))}
  axis(1, cex.axis=cex.axis, at=seq(0, 25, by=5), labels = xLabs,
       line=1.25,
       mgp=c(2, 0.75, 0), tck=-0.04)
  
  yLabs = NA
  if(yaxisLabs==T){
      yLabs = c(expression(10^3),
                expression(10^6),
                expression(10^9),
                expression(10^12),
                expression(10^15))}
  axis(2, cex.axis=cex.axis, at=seq(3, 15, by=3), 
       labels=yLabs,
       line=1.25,
       las=2, 
       mgp=c(2, 1, 0), tck= -0.04)
  
  if (example) {
    mtext(text=xlabel, side=1, line=xlabel.line, cex=cex_labels, adj=3.25)
    mtext(text=ylabel, side=2, line=ylabel.line, cex=cex_labels, adj=5)
    text(.93 * 25, .93 * (15-3) + 3, panellabel, cex=cex_labels,
         font=2)
  }
  else {
    mtext(text=xlabel, side=1, line=xlabel.line, cex=cex_labels)
    mtext(text=ylabel, side=2, line=ylabel.line, cex=cex_labels)
  }
  
}
```

First, we show examples of pre- and post-symptomatic transmission.
```{r}
sars.color <- "#56b3e9"
noro.color <- "#871a6e"
sars.pch <- 5
noro.pch <- 2

tiff(filename="Example Trajectories.tiff", height=5, 
     width=6.5, units = "in", res=500)

participantexamples <- c('Throat_16', 'Throat_5', 'ID12')

par(mfrow=c(2, 2), mai=c(0.42, 0.52, 0.52, 0.1), oma=c(2, 3, 1, 2))

for(i in 1: length(participantexamples)) {
  
  p <- participantexamples[i]
  
  if(grepl('Throat', p)) {
    participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
    sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
    params <- unlist(sars.params.localmin[sars.params.localmin$ID==p,][2:5])
    maxt <- sars.maxt.firstmin[sars.maxt.firstmin$ID==p,]$max.point
    col <- sars.color
    pch <- sars.pch
  } else {
    participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
    sympdata <- noro.IncubData[noro.IncubData$ID == p, ]
    params <- unlist(noro.params.localmin[noro.params.localmin$ID==p,][2:5])
    maxt <- noro.maxt.firstmin[noro.maxt.firstmin$ID==p,]$max.point
    col <- noro.color
    pch <- noro.pch
  }

  if (i == 3) {
    ylabel <- "Viral shedding"
    xlabel <- "Hours after inoculation"
  } else {
    ylabel <- ""
    xlabel <- ""
  }
  
  plot.viralload(data=participantdata, 
                 pars=params, 
                 sympdata=sympdata, 
                 max.modeltime=maxt,
                 cex=1.33, 
                 col=col,
                 pch=pch,
                 cex_labels=1,
                 cex.axis=1,
                 xlabel=xlabel,
                 ylabel=ylabel,
                 panellabel=LETTERS[i],
                 example=TRUE)
  
  if (i == 1) {
    mtext("Post-symptomatic", side=3, line=2, font=2)
  } else if (p==participantexamples[2]) {
    mtext("Pre-symptomatic", side=3, line=2, font=2)
  }
}

plot.new()

legend("center", legend=c("SARS-CoV-2", "Norovirus"), col=c(sars.color, noro.color),
       pch=c(5, 2))

dev.off()
```

We then plot the trajectories of each participant from both studies using both 
sets of endpoints. Since they produce qualitatively similar fits, we arbitrarily 
use the first local minimum in pathogen shedding as the endpoint going forward.
```{r, fig.height = 7.5, fig.width = 6.5}
tiff("Participant trajectories norovirus.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(6, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(noroParticipants)) {
  
  p <- noroParticipants[i]
  participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
  sympdata <- noro.IncubData[noro.IncubData$ID==p, ]
  params <- unlist(noro.params.localmin[noro.params.localmin$ID==p,][2:5])
  maxt <- noro.maxt.firstmin[noro.maxt.firstmin$ID==p,]$max.point
  col <- noro.color
  pch <- noro.pch
  
  if (i==16) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else if (i %in% seq(1, 16, by=3)) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(15, 17)) {
     plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else {
    plot.viralload(
    data=participantdata,
    pars=params,
    sympdata=sympdata,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=col,
    pch=pch,
    ylim.lower = 7,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}
dev.off()

#Repeating with a different endpoint

tiff("Participant trajectories norovirus alternative endpoint.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(6, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(noroParticipants)) {
  
  p <- noroParticipants[i]
  participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
  sympdata <- noro.IncubData[noro.IncubData$ID==p, ]
  params <- unlist(noro.params.backtoinitial[noro.params.backtoinitial$ID==p,][2:5])
  maxt <- noro.maxt.backtoinitial[noro.maxt.backtoinitial$ID==p,]$max.point
  col <- noro.color
  pch <- noro.pch
  
  if (i==16) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      col=noro.color,
      pch=noro.pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else if (i %in% seq(1, 16, by=3)) {
    plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=noro.color,
      pch=noro.pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(15, 17)) {
     plot.viralload(
      data=participantdata,
      pars=params,
      sympdata=sympdata,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=noro.color,
      pch=noro.pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else {
    plot.viralload(
    data=participantdata,
    pars=params,
    sympdata=sympdata,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=noro.color,
    pch=noro.pch,
    ylim.lower = 7,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}

dev.off()

tiff("Participant Trajectories SARS-CoV-2.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(7, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(sarsParticipants)) {
  
  p <- sarsParticipants[i]
  participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
  sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
  params <- unlist(sars.params.localmin[sars.params.localmin$ID==p,][2:5])
  maxt <- sars.maxt.firstmin[sars.maxt.firstmin$ID==p,]$max.point
  
  if (i %in% seq(1, 13, by=3)) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(17, 18)) {
     plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else if (i==16) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else {
    plot.viralload(
    data=participantdata,
    sympdata=sympdata,
    pars=params,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=sars.color,
    pch=sars.pch,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}

dev.off()

# Repeating with a different endpoint

tiff("Participant Trajectories SARS-CoV-2 alternative endpoint.tiff", res=500,
      height=7.5, width=6.5, unit="in")

par(mfrow=c(7, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 4, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(sarsParticipants)) {
  
  p <- sarsParticipants[i]
  participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
  sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
  params <- unlist(sars.params.backtoinitial[sars.params.backtoinitial$ID==p,][2:5])
  maxt <- sars.maxt.backtoinitial[sars.maxt.backtoinitial$ID==p,]$max.point
  
  if (i %in% seq(1, 13, by=3)) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      xaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding")
  } else if (i %in% c(17, 18)) {
     plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      yaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="")
  } else if (i==16) {
    plot.viralload(
      data=participantdata,
      sympdata=sympdata,
      pars=params,
      max.modeltime=maxt,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      ylabel="Viral shedding")
  } else {
    plot.viralload(
    data=participantdata,
    sympdata=sympdata,
    pars=params,
    max.modeltime=maxt,
    xaxisLabs=F,
    yaxisLabs=F,
    col=sars.color,
    pch=sars.pch,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="")
  }
}

dev.off()
```

We exclude participants from some of the upcoming analyses due to unclear peaks.
```{r}
noro.unclearpeaks <- c('ID5', 'ID20')

sars.unclearpeaks <- c('Throat_1', 'Throat_12', 'Throat_13', 'Throat_14')
```

### Calculating our measures of interest

Now, we calculate the delay between symptom onset and peak pathogen load for
each participant in each study, which serves as a conservative measure of 
pre-symptomatic transmission. We also look at a 
non-conservative measure of pre-symptomatic transmission, i.e. the 
delay between shedding onset and symptom onset. A negative delay indicates 
pre-symptomatic transmission, while a positive one indicates post-symptomatic
transmission. The delay is in days.
```{r}
calculate.peaktime <- function(vldata, maxt, params) {
  
  t <- seq(0, vldata[maxt$max.point,]$days*24, 
        by=1)
  
  predictedvl <- generate.estimates(t, params)
  
  peak.vl.time <- t[which(predictedvl==max(predictedvl))]
  
  return(peak.vl.time)
}

calculate.delay.conservative <- function(vldata, sympdata, params, maxt) {
  
  if(unique(vldata$ID) %in% c(noro.unclearpeaks, sars.unclearpeaks)) {
    return(NA)
  }
  
  peak.vl.time <- calculate.peaktime(vldata, maxt, params)

  delay <- peak.vl.time - (sympdata$incubation * 24)
  
  return(delay/24)
}

calculate.delay.nonconservative <- function(vldata, sympdata) {

  delay <- shed.onset(vldata) - sympdata$incubation 
  
  return(delay)
}

noro.measures <- do.call(rbind,  
                               lapply(noroParticipants, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.conservative(noro.FShedData[noro.FShedData$ID == x, ],
                                                        noro.IncubData[noro.IncubData$ID == x,],
                                                        unlist(noro.params.localmin[noro.params.localmin$ID == x,][2:5]), 
                                                        noro.maxt.firstmin[noro.maxt.firstmin$ID == x,]),
                                                   calculate.peaktime(noro.FShedData[noro.FShedData$ID == x,],
                                                                      noro.maxt.firstmin[noro.maxt.firstmin$ID == x,],
                                                                      unlist(noro.params.localmin[noro.params.localmin$ID==x, 2:5])),
                                                   calculate.delay.nonconservative(noro.FShedData[noro.FShedData$ID == x, ],
                                                        noro.IncubData[noro.IncubData$ID == x,]),
                                                   noro.IncubData[noro.IncubData$ID == x,]$incubation
                                                   )))

colnames(noro.measures) <- c('ID', 'delay_conservative', 'peak_time', 
                             'delay_nonconservative', 'incubation')

noro.measures <- merge(noro.measures, noro.params.localmin, by.x='ID',
                       by.y='ID')

sars.measures <- do.call(rbind,  
                               lapply(sarsParticipants, 
                                      function(x) 
                                        data.frame(x, 
                                                   calculate.delay.conservative(sars.TShedData[sars.TShedData$ID == x, ],
                                                        sars.IncubData[sars.IncubData$ID == x,],
                                                        unlist(sars.params.localmin[sars.params.localmin$ID == x,][2:5]), 
                                                        sars.maxt.firstmin[sars.maxt.firstmin$ID == x,]),
                                                   calculate.peaktime(sars.TShedData[sars.TShedData$ID == x,],
                                                                      sars.maxt.firstmin[sars.maxt.firstmin$ID == x,],
                                                                      unlist(sars.params.localmin[sars.params.localmin$ID==x, 2:5])),
                                                   calculate.delay.nonconservative(sars.TShedData[sars.TShedData$ID == x, ],
                                                        sars.IncubData[sars.IncubData$ID == x,]),
                                                   sars.IncubData[sars.IncubData$ID == x,]$incubation)))

colnames(sars.measures) <- c('ID', 'delay_conservative', 'peak_time', 
                             'delay_nonconservative', 'incubation')

sars.measures <- merge(sars.measures, sars.params.localmin, by.x='ID',
                       by.y='ID')
```

We also calculate pre-symptomatic transmission potential,
measured as average shedding prior to symptoms, and the duration of the 
latency period (symptom onset minus shedding onset) for each person.
```{r}
presymp.transmission.potential <- function(vldata, sympdata) {
  
  vl.latent <- vldata[vldata$days < sympdata$incubation,]
  
  if(length(vl.latent[grepl('~', vl.latent$y_type),]$y_virus) > 0) {
    vl.latent[grepl('~', vl.latent$y_type),]$y_virus <- mean(c(15000, 4e7))
  }

  avg.shedding.latent <- log10(mean(vl.latent$y_virus, na.rm=T))
  
  return(avg.shedding.latent)
  
}

noro.presymptrans.avg <- apply(noro.measures, 1, 
                           function(x) presymp.transmission.potential(noro.FShedData[noro.FShedData$ID == x[1],],
                                                                       noro.IncubData[noro.IncubData$ID == x[1],]))

noro.latency <- apply(noro.measures, 1, 
                      function(x) -1 * noro.measures[noro.measures$ID == x[1],]$delay_nonconservative)

noro.measures$presymp_transmission_avg <- noro.presymptrans.avg
noro.measures$latency <- noro.latency


# SARS-CoV-2 data 

sars.presymptrans.avg <- apply(sars.measures, 1, 
                           function(x) presymp.transmission.potential(sars.TShedData[sars.TShedData$ID == x[1],],
                                                                       sars.IncubData[sars.IncubData$ID == x[1],]))

sars.latency <- apply(sars.measures, 1, 
                      function(x) -1 * sars.measures[sars.measures$ID == x[1],]$delay_nonconservative)

sars.measures$presymp_transmission_avg <- sars.presymptrans.avg
sars.measures$latency <- sars.latency
```

We also used cumulative pre-symptomatic shedding as an alternative measure of
pre-symptomatic transmission potential.
```{r}
presymp.transmission.potential.cum <- function(vldata, sympdata) {
  
  vl.latent <- vldata[vldata$days < sympdata$incubation,]
  
  if(length(vl.latent[grepl('~', vl.latent$y_type),]$y_virus) > 0) {
    vl.latent[grepl('~', vl.latent$y_type),]$y_virus <- mean(c(15000, 4e7))
  }
  
  vl.latent[is.na(vl.latent$y_virus),]$y_virus <- 0

  if (length(vl.latent$y_virus) == 1) {
    auc.vl.latent <- log10(vl.latent$y_virus)
  } else {
    auc.vl.latent <- log10(trapz(vl.latent$days, vl.latent$y_virus))
  }
  
  if (is.infinite(auc.vl.latent)) {return(NaN)} else {return(auc.vl.latent)}
}

noro.presymptrans.cum <- apply(noro.measures, 1, 
                               function(x) presymp.transmission.potential.cum(noro.FShedData[noro.FShedData$ID == x[1],],
                                                                                      noro.IncubData[noro.IncubData$ID == x[1],]))

noro.measures$presymp_transmission_cum <- noro.presymptrans.cum

# SARS-CoV-2 data
sars.presymptrans.cum <- apply(sars.measures, 1, 
                               function(x) presymp.transmission.potential.cum(sars.TShedData[sars.TShedData$ID == x[1],],
                                                                                      sars.IncubData[sars.IncubData$ID == x[1],]))

sars.measures$presymp_transmission_cum <- sars.presymptrans.cum
```

### Linear regressions
We run a linear regression between the delay between symptom onset and peak
pathogen load and each of the 4 parameters from the statistical model as well
as between viral growth and decay rate. In the Ge *et al.*, 2023 study, 
p1, p2, and p3, i.e. peak viral load, viral replication rate, and time of peak 
viral load, respectively, were found to have significant correlations with delay. 
```{r}
noro.excluding.unclear.peaks <- noro.measures[!noro.measures$ID %in% noro.unclearpeaks,]
sars.excluding.unclear.peaks <- sars.measures[!sars.measures$ID %in% sars.unclearpeaks,]

# Peak viral load vs. delay
lm.fit.p1.delay.conservative.noro <- 
  lm(delay_conservative ~ p1, data=noro.measures)
p1.delay.conservative.pval.noro <- 
  summary(lm.fit.p1.delay.conservative.noro)$coefficients[2,4]
p1.delay.conservative.pval.noro

# Viral replication rate vs. delay
lm.fit.p2.delay.conservative.noro <- 
  lm(delay_conservative ~ p2, data=noro.measures)
p2.delay.conservative.pval.noro <- 
  summary(lm.fit.p2.delay.conservative.noro)$coefficients[2,4]
p2.delay.conservative.pval.noro
p2.delay.conservative.rsquared.noro <- summary(lm.fit.p2.delay.conservative.noro)$r.squared
p2.delay.conservative.rsquared.noro

# Time of peak viral load vs. delay
lm.fit.p3.delay.conservative.noro <- 
  lm(delay_conservative ~ p3, data=noro.measures)
p3.delay.conservative.pval.noro <- 
  summary(lm.fit.p3.delay.conservative.noro)$coefficients[2,4]
p3.delay.conservative.pval.noro

# Viral decay rate vs. delay
lm.fit.p4.delay.conservative.noro <- 
  lm(delay_conservative ~ p4, data=noro.measures)
p4.delay.conservative.pval.noro <- 
  summary(lm.fit.p4.delay.conservative.noro)$coefficients[2,4]
p4.delay.conservative.pval.noro

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.noro <- 
  lm(p4 ~ p2, data=noro.excluding.unclear.peaks)
p4.p2.conservative.pval.noro <- 
  summary(lm.fit.p4.p2.conservative.noro)$coefficients[2,4]
p4.p2.conservative.pval.noro
```

There were no significant correlations found within the Zhou *et al.*, 2023 study,
looking at the same parameters.
```{r}
# Peak viral load vs. delay
lm.fit.p1.delay.conservative.sars <- 
  lm(delay_conservative ~ p1, data=sars.measures)
p1.delay.conservative.pval.sars <- 
  summary(lm.fit.p1.delay.conservative.sars)$coefficients[2,4]
p1.delay.conservative.pval.sars

# Viral replication rate vs. delay
lm.fit.p2.delay.conservative.sars <- 
  lm(delay_conservative ~ p2, data=sars.measures)
p2.delay.conservative.pval.sars <- 
  summary(lm.fit.p2.delay.conservative.sars)$coefficients[2,4]
p2.delay.conservative.pval.sars

# Time of peak viral load vs. delay
lm.fit.p3.delay.conservative.sars <- 
  lm(delay_conservative ~ p3, data=sars.measures)
p3.delay.conservative.pval.sars <- 
  summary(lm.fit.p3.delay.conservative.sars)$coefficients[2,4]
p3.delay.conservative.pval.sars

# Viral decay rate vs. delay
lm.fit.p4.delay.conservative.sars <- 
  lm(delay_conservative ~ p4, data=sars.measures)
p4.delay.conservative.pval.sars <- 
  summary(lm.fit.p4.delay.conservative.sars)$coefficients[2,4]
p4.delay.conservative.pval.sars

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.sars <- 
  lm(p4 ~ p2, data=sars.measures[!sars.measures$ID %in% sars.unclearpeaks,])
p4.p2.conservative.pval.sars <- 
  summary(lm.fit.p4.p2.conservative.sars)$coefficients[2,4]
p4.p2.conservative.pval.sars
```

We also test for significant correlations between the statistical 
model parameters and the duration of the latency period. With this 
non-conservative estimate of pre-symptomatic transmission, we find no 
significant correlations in the norovirus or SARS-CoV-2 data.
```{r}
lm.fit.p1.delay.nonconservative.noro <- 
  lm(delay_nonconservative ~ p1, data=noro.measures)
p1.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p1.delay.nonconservative.noro)$coefficients[2,4]
p1.delay.nonconservative.pval.noro

lm.fit.p2.delay.nonconservative.noro <- lm(delay_nonconservative ~ p2, 
                                           data=noro.measures)
p2.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p2.delay.nonconservative.noro)$coefficients[2,4]
p2.delay.nonconservative.pval.noro

lm.fit.p3.delay.nonconservative.noro <- 
  lm(delay_nonconservative ~ p3, data=noro.measures)
p3.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p3.delay.nonconservative.noro)$coefficients[2,4]
p3.delay.nonconservative.pval.noro

lm.fit.p4.delay.nonconservative.noro <- 
  lm(delay_nonconservative ~ p4, data=noro.measures)
p4.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p4.delay.nonconservative.noro)$coefficients[2,4]
p4.delay.nonconservative.pval.noro

# SARS-CoV-2 data
lm.fit.p1.delay.nonconservative.sars <- 
  lm(delay_nonconservative ~ p1, data=sars.measures)
p1.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p1.delay.nonconservative.sars)$coefficients[2,4]
p1.delay.nonconservative.pval.sars

lm.fit.p2.delay.nonconservative.sars <- 
  lm(delay_nonconservative ~ p2, data=sars.measures)
p2.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p2.delay.nonconservative.sars)$coefficients[2,4]
p2.delay.nonconservative.pval.sars

lm.fit.p3.delay.nonconservative.sars <- 
  lm(delay_nonconservative ~ p3, data=sars.measures)
p3.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p3.delay.nonconservative.sars)$coefficients[2,4]
p3.delay.nonconservative.pval.sars

lm.fit.p4.delay.nonconservative.sars <- 
  lm(delay_nonconservative ~ p4, data=sars.measures)
p4.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p4.delay.nonconservative.sars)$coefficients[2,4]
p4.delay.nonconservative.pval.sars
```

There is no correlation between average shedding prior to symptoms and the 
duration of the latency period (symptom onset minus shedding onset) in either 
the norovirus or SARS-CoV-2 data.
```{r}
transmission.latent.avg.fit.noro <- lm(presymp_transmission_avg ~ latency, 
                              data = noro.measures)
transmission.latent.avg.pval.noro <- 
  summary(transmission.latent.avg.fit.noro)$coefficients[2,4]

transmission.latent.avg.pval.noro

transmission.latent.avg.fit.sars <- lm(presymp_transmission_avg ~ latency, 
                              data = sars.measures)
transmission.latent.avg.pval.sars <- 
  summary(transmission.latent.avg.fit.sars)$coefficients[2,4]

transmission.latent.avg.pval.sars
```

There are also no statistically significant correlations found between 
cumulative shedding prior to symptoms and the duration of the latency period 
in either the norovirus or SARS-CoV-2 data.
```{r}
transmission.latent.cum.fit.noro <- lm(presymp_transmission_cum ~ latency, 
                              data = noro.measures)
transmission.latent.cum.pval.noro <- 
  summary(transmission.latent.cum.fit.noro)$coefficients[2,4]

transmission.latent.cum.pval.noro

# SARS-CoV-2 data

transmission.latent.cum.fit.sars <- lm(presymp_transmission_cum ~ latency, 
                              data = sars.measures)
transmission.latent.cum.pval.sars <- 
  summary(transmission.latent.cum.fit.sars)$coefficients[2,4]

transmission.latent.cum.pval.sars
```

Lastly, we break down the correlation between pre-symptomatic transmission
and viral growth rate by examining the relationships between time of
peak shedding and viral growth rate as well as between symptom onset
and viral growth rate.

For both norovirus and SARS-CoV-2, there is a significant correlation between
time of peak shedding and viral growth rate, but not between symptom onset 
and viral growth rate.
```{r}
lm.fit.p2.peaktime.noro <- lm(peak_time/24 ~ p2, 
                              data=noro.measures[!noro.measures$ID %in% noro.unclearpeaks,])
p2.peaktime.pval.noro <- summary(lm.fit.p2.peaktime.noro)$coefficients[2,4]
p2.peaktime.pval.noro
p2.peaktime.rsquared.noro <- summary(lm.fit.p2.peaktime.noro)$r.squared
p2.peaktime.rsquared.noro

lm.fit.p2.symponset.noro <- lm(incubation ~ p2, data=noro.measures)
p2.symponset.pval.noro <- summary(lm.fit.p2.symponset.noro)$coefficients[2,4]
p2.symponset.pval.noro

lm.fit.p2.peaktime.sars <- lm(peak_time/24 ~ p2, data=sars.measures[!sars.measures$ID %in% sars.unclearpeaks,])
p2.peaktime.pval.sars <- summary(lm.fit.p2.peaktime.sars)$coefficients[2,4]
p2.peaktime.pval.sars
p2.peaktime.rsquared.sars <- summary(lm.fit.p2.peaktime.sars)$r.squared
p2.peaktime.rsquared.sars

lm.fit.p2.symponset.sars <- lm(incubation ~ p2, data=sars.measures)
p2.symponset.pval.sars <- summary(lm.fit.p2.symponset.sars)$coefficients[2,4]
p2.symponset.pval.sars
```

### Bootstrapping for confidence bounds
We use bootstrapping to create 95% confidence bounds (n = 1000) for each 
correlation we show in Figures 3, S9, and S10.
```{r}
iters <- 1000

delay.conservative.sample.slopes.noro <- c()
delay.conservative.sample.intercepts.noro <- c()

delay.nonconservative.sample.slopes.noro <- c()
delay.nonconservative.sample.intercepts.noro <- c()

peakshedding.sample.slopes.noro <- c()
peakshedding.sample.intercepts.noro <- c()

symponset.sample.slopes.noro <- c()
symponset.sample.intercepts.noro <- c()

presymp.shed.avg.sample.slopes.noro <- c()
presymp.shed.avg.sample.intercepts.noro <- c()

presymp.shed.cum.sample.slopes.noro <- c()
presymp.shed.cum.sample.intercepts.noro <- c()

delay.conservative.sample.slopes.sars <- c()
delay.conservative.sample.intercepts.sars <- c()

delay.nonconservative.sample.slopes.sars <- c()
delay.nonconservative.sample.intercepts.sars <- c()

peakshedding.sample.slopes.sars <- c()
peakshedding.sample.intercepts.sars <- c()

symponset.sample.slopes.sars <- c()
symponset.sample.intercepts.sars <- c()

presymp.shed.avg.sample.slopes.sars <- c()
presymp.shed.avg.sample.intercepts.sars <- c()

presymp.shed.cum.sample.slopes.sars <- c()
presymp.shed.cum.sample.intercepts.sars <- c()

for (i in 1:iters) {
  
  # Fig 3B: delay between symptom onset and peak viral shedding vs. viral 
  # replication rate
  delay.conservative.resamp.noro <- noro.excluding.unclear.peaks[
    sample(1:nrow(noro.excluding.unclear.peaks), 
                         size=nrow(noro.excluding.unclear.peaks),
                         replace=T), c(2, 7)]
  
  delay.conservative.slope.noro <- coef(lm(delay_conservative ~ p2, data=delay.conservative.resamp.noro))[2]
  delay.conservative.intercept.noro <- coef(lm(delay_conservative ~ p2, data=delay.conservative.resamp.noro))[1]
  
  delay.conservative.sample.slopes.noro[i] <- delay.conservative.slope.noro
  delay.conservative.sample.intercepts.noro[i] <- delay.conservative.intercept.noro
  
  delay.conservative.resamp.sars <- sars.excluding.unclear.peaks[
    sample(1:nrow(sars.excluding.unclear.peaks), 
                         size=nrow(sars.excluding.unclear.peaks),
                         replace=T), c(2, 7)]
  
  delay.conservative.slope.sars <- coef(lm(delay_conservative ~ p2, data=delay.conservative.resamp.sars))[2]
  delay.conservative.intercept.sars <- coef(lm(delay_conservative ~ p2, data=delay.conservative.resamp.sars))[1]
  
  delay.conservative.sample.slopes.sars[i] <- delay.conservative.slope.sars
  delay.conservative.sample.intercepts.sars[i] <- delay.conservative.intercept.sars
  
  # Fig S9B: delay between symptom onset and shedding onset vs. viral 
  # replication rate
  delay.nonconservative.resamp.noro <- noro.measures[
    sample(1:nrow(noro.measures), 
                         size=nrow(noro.measures),
                         replace=T), c(4, 7)]
  
  delay.nonconservative.slope.noro <- coef(lm(delay_nonconservative ~ p2, 
                                              data=delay.nonconservative.resamp.noro))[2]
  delay.nonconservative.intercept.noro <- coef(lm(delay_nonconservative ~ p2, 
                                                  data=delay.nonconservative.resamp.noro))[1]
  
  delay.nonconservative.sample.slopes.noro[i] <- delay.nonconservative.slope.noro
  delay.nonconservative.sample.intercepts.noro[i] <- delay.nonconservative.intercept.noro
  
  delay.nonconservative.resamp.sars <- sars.measures[
    sample(1:nrow(sars.measures), 
                         size=nrow(sars.measures),
                         replace=T), c(4, 7)]
  
  delay.nonconservative.slope.sars <- coef(lm(delay_nonconservative ~ p2, 
                                              data=delay.nonconservative.resamp.sars))[2]
  delay.nonconservative.intercept.sars <- coef(lm(delay_nonconservative ~ p2, 
                                                  data=delay.nonconservative.resamp.sars))[1]
  
  delay.nonconservative.sample.slopes.sars[i] <- delay.nonconservative.slope.sars
  delay.nonconservative.sample.intercepts.sars[i] <- delay.nonconservative.intercept.sars
  
  # Fig 3C: day of peak shedding vs. viral replication rate 
  peakshedding.resamp.noro <- noro.excluding.unclear.peaks[
    sample(1:nrow(noro.excluding.unclear.peaks), 
                         size=nrow(noro.excluding.unclear.peaks),
                         replace=T), c(3, 7)]
  
  peakshedding.slope.noro <- coef(lm(peak_time ~ p2, data=peakshedding.resamp.noro))[2]
  peakshedding.intercept.noro <- coef(lm(peak_time ~ p2, data=peakshedding.resamp.noro))[1]
  
  peakshedding.sample.slopes.noro[i] <- peakshedding.slope.noro
  peakshedding.sample.intercepts.noro[i] <- peakshedding.intercept.noro
  
  peakshedding.resamp.sars <- sars.excluding.unclear.peaks[
    sample(1:nrow(sars.excluding.unclear.peaks), 
                         size=nrow(sars.excluding.unclear.peaks),
                         replace=T), c(3, 7)]
  
  peakshedding.slope.sars <- coef(lm(peak_time ~ p2, data=peakshedding.resamp.sars))[2]
  peakshedding.intercept.sars <- coef(lm(peak_time ~ p2, data=peakshedding.resamp.sars))[1]
  
  peakshedding.sample.slopes.sars[i] <- peakshedding.slope.sars
  peakshedding.sample.intercepts.sars[i] <- peakshedding.intercept.sars
  
  # Fig 3D: day of symptom onset vs. viral replication rate 
  symponset.resamp.noro <- noro.measures[sample(1:nrow(noro.measures),
                                                        size=nrow(noro.measures),
                                                        replace=T), c(5, 7)]
  
  symponset.slope.noro <- coef(lm(incubation ~ p2, data=symponset.resamp.noro))[2]
  symponset.intercept.noro <- coef(lm(incubation ~ p2, data=symponset.resamp.noro))[1]
  
  symponset.sample.slopes.noro[i] <- symponset.slope.noro
  symponset.sample.intercepts.noro[i] <- symponset.intercept.noro
  
  symponset.resamp.sars <- sars.measures[sample(1:nrow(sars.measures),
                                                        size=nrow(sars.measures),
                                                        replace=T), c(5, 7)]
  
  symponset.slope.sars <- coef(lm(incubation ~ p2, data=symponset.resamp.sars))[2]
  symponset.intercept.sars <- coef(lm(incubation ~ p2, data=symponset.resamp.sars))[1]
  
  symponset.sample.slopes.sars[i] <- symponset.slope.sars
  symponset.sample.intercepts.sars[i] <- symponset.intercept.sars
  
  # Fig 3E: average pre-symptomatic shedding vs. duration of latency period 
  presymp.shed.avg.resamp.noro <- noro.measures[!is.na(noro.measures$presymp_transmission_avg),][sample(1:nrow(noro.measures[
    !is.na(noro.measures$presymp_transmission_avg),]),
                                                              size=nrow(noro.measures[
                                                                !is.na(noro.measures$presymp_transmission_avg),
                                                              ]),
                                                              replace=T), c(10, 11)] 
  
  presymp.shed.avg.slope.noro <- coef(lm(presymp_transmission_avg ~ latency, 
                                     data=presymp.shed.avg.resamp.noro))[2]
  presymp.shed.avg.intercept.noro <- coef(lm(presymp_transmission_avg ~ latency,
                                         data=presymp.shed.avg.resamp.noro))[1]
  
  presymp.shed.avg.sample.slopes.noro[i] <- presymp.shed.avg.slope.noro 
  presymp.shed.avg.sample.intercepts.noro[i] <- presymp.shed.avg.intercept.noro 
 
  presymp.shed.avg.resamp.sars <- sars.measures[!is.na(sars.measures$presymp_transmission_avg),][sample(1:nrow(sars.measures[
    !is.na(sars.measures$presymp_transmission_avg),]),
                                                              size=nrow(sars.measures[
                                                                !is.na(sars.measures$presymp_transmission_avg),
                                                              ]),
                                                              replace=T), c(10, 11)] 
  
  presymp.shed.avg.slope.sars <- coef(lm(presymp_transmission_avg ~ latency, 
                                     data=presymp.shed.avg.resamp.sars))[2]
  presymp.shed.avg.intercept.sars <- coef(lm(presymp_transmission_avg ~ latency,
                                         data=presymp.shed.avg.resamp.sars))[1]
  
  presymp.shed.avg.sample.slopes.sars[i] <- presymp.shed.avg.slope.sars
  presymp.shed.avg.sample.intercepts.sars[i] <- presymp.shed.avg.intercept.sars  
  
  # Fig S10: cumulative pre-symptomatic shedding vs. duration of latency period
  presymp.shed.cum.resamp.noro <- noro.measures[!is.na(noro.measures$presymp_transmission_cum),][sample(1:nrow(noro.measures[
    !is.na(noro.measures$presymp_transmission_cum),]),
                                                              size=nrow(noro.measures[
                                                                !is.na(noro.measures$presymp_transmission_cum),
                                                              ]),
                                                              replace=T), c(12, 11)] 
  
  presymp.shed.cum.slope.noro <- coef(lm(presymp_transmission_cum ~ latency, 
                                     data=presymp.shed.cum.resamp.noro))[2]
  presymp.shed.cum.intercept.noro <- coef(lm(presymp_transmission_cum ~ latency,
                                         data=presymp.shed.cum.resamp.noro))[1]
  
  presymp.shed.cum.sample.slopes.noro[i] <- presymp.shed.cum.slope.noro 
  presymp.shed.cum.sample.intercepts.noro[i] <- presymp.shed.cum.intercept.noro 
 
  presymp.shed.cum.resamp.sars <- sars.measures[!is.na(sars.measures$presymp_transmission_cum),][sample(1:nrow(sars.measures[
    !is.na(sars.measures$presymp_transmission_cum),]),
                                                              size=nrow(sars.measures[
                                                                !is.na(sars.measures$presymp_transmission_cum),
                                                              ]),
                                                              replace=T), c(12, 11)] 
  
  presymp.shed.cum.slope.sars <- coef(lm(presymp_transmission_cum ~ latency, 
                                     data=presymp.shed.cum.resamp.sars))[2]
  presymp.shed.cum.intercept.sars <- coef(lm(presymp_transmission_cum ~ latency,
                                         data=presymp.shed.cum.resamp.sars))[1]
  
  presymp.shed.cum.sample.slopes.sars[i] <- presymp.shed.cum.slope.sars
  presymp.shed.cum.sample.intercepts.sars[i] <- presymp.shed.cum.intercept.sars  
}

# Fig 3B
lower.bound.delay.conservativtransmission.latent.avg.fit.noro <- c(quantile(delay.conservative.sample.slopes.noro, 0.025),
                                quantile(delay.conservative.sample.intercepts.noro, 0.025))

upper.bound.delay.conservativtransmission.latent.avg.fit.noro <- c(quantile(delay.conservative.sample.slopes.noro, 0.975), 
                                quantile(delay.conservative.sample.intercepts.noro, 0.975))

lower.bound.delay.conservativtransmission.latent.avg.fit.sars <- c(quantile(delay.conservative.sample.slopes.sars, 0.025),
                                quantile(delay.conservative.sample.intercepts.sars, 0.025))
                                
upper.bound.delay.conservativtransmission.latent.avg.fit.sars <- c(quantile(delay.conservative.sample.slopes.sars, 0.975),
                                quantile(delay.conservative.sample.intercepts.sars, 0.975))

# Fig S9B
lower.bound.delay.nonconservativtransmission.latent.avg.fit.noro <- c(quantile(delay.nonconservative.sample.slopes.noro, 0.025),
                                quantile(delay.nonconservative.sample.intercepts.noro, 0.025))

upper.bound.delay.nonconservativtransmission.latent.avg.fit.noro <- c(quantile(delay.nonconservative.sample.slopes.noro, 0.975), 
                                quantile(delay.nonconservative.sample.intercepts.noro, 0.975))

lower.bound.delay.nonconservativtransmission.latent.avg.fit.sars <- c(quantile(delay.nonconservative.sample.slopes.sars, 0.025),
                                quantile(delay.nonconservative.sample.intercepts.sars, 0.025))
                                
upper.bound.delay.nonconservativtransmission.latent.avg.fit.sars <- c(quantile(delay.nonconservative.sample.slopes.sars, 0.975),
                                quantile(delay.nonconservative.sample.intercepts.sars, 0.975))

# Fig 3C
lower.bound.peakshedding.mod.noro <- c(quantile(peakshedding.sample.slopes.noro, 0.025),
                                       quantile(peakshedding.sample.intercepts.noro, 0.025))

upper.bound.peakshedding.mod.noro <- c(quantile(peakshedding.sample.slopes.noro, 0.975),
                                         quantile(peakshedding.sample.intercepts.noro, 0.975))

lower.bound.peakshedding.mod.sars <- c(quantile(peakshedding.sample.slopes.sars, 0.025),
                                       quantile(peakshedding.sample.intercepts.sars, 0.025))
upper.bound.peakshedding.mod.sars <- c(quantile(peakshedding.sample.slopes.sars, 0.975),
                                       quantile(peakshedding.sample.intercepts.sars, 0.975))

# Fig 3D
lower.bound.symponset.mod.noro <- c(quantile(symponset.sample.slopes.noro, 0.025),
                                      quantile(symponset.sample.intercepts.noro, 0.025))

upper.bound.symponset.mod.noro <- c(quantile(symponset.sample.slopes.noro, 0.975),
                                    quantile(symponset.sample.intercepts.noro, 0.975))

lower.bound.symponset.mod.sars <- c(quantile(symponset.sample.slopes.sars, 0.025),
                                    quantile(symponset.sample.intercepts.sars, 0.025))

upper.bound.symponset.mod.sars <- c(quantile(symponset.sample.slopes.sars, 0.975),
                                      quantile(symponset.sample.intercepts.sars, 0.975))

# Fig 3E

# There are few people in both the norovirus and SARS-CoV-2 study demonstrating 
# pre-symptomatic shedding, so sometimes resampling will return the same person 
# repeatedly. We remove those samples (na.rm = T).
lower.bound.presymp.shed.avg.mod.noro <- c(quantile(presymp.shed.avg.sample.slopes.noro, 0.025,
                                                na.rm=T),
                                       quantile(presymp.shed.avg.sample.intercepts.noro, 0.025,
                                                na.rm=T))

upper.bound.presymp.shed.avg.mod.noro <- c(quantile(presymp.shed.avg.sample.slopes.noro, 0.975,
                                                na.rm=T),
                                       quantile(presymp.shed.avg.sample.intercepts.noro, 0.975,
                                                na.rm=T))

lower.bound.presymp.shed.avg.mod.sars <- c(quantile(presymp.shed.avg.sample.slopes.sars, 
                                                0.025, na.rm=T),
                                       quantile(presymp.shed.avg.sample.intercepts.sars, 
                                                0.025, na.rm=T))

upper.bound.presymp.shed.avg.mod.sars <- c(quantile(presymp.shed.avg.sample.slopes.sars, 
                                                0.975, na.rm=T),
                                       quantile(presymp.shed.avg.sample.intercepts.sars, 
                                                0.975, na.rm=T))

# Fig S10

# There are few people in both the norovirus and SARS-CoV-2 study demonstrating 
# pre-symptomatic shedding, so sometimes resampling will return the same person 
# repeatedly. We remove those samples (na.rm = T).
lower.bound.presymp.shed.cum.mod.noro <- c(quantile(presymp.shed.cum.sample.slopes.noro, 0.025,
                                                na.rm=T),
                                       quantile(presymp.shed.cum.sample.intercepts.noro, 0.025,
                                                na.rm=T))

upper.bound.presymp.shed.cum.mod.noro <- c(quantile(presymp.shed.cum.sample.slopes.noro, 0.975,
                                                na.rm=T),
                                       quantile(presymp.shed.cum.sample.intercepts.noro, 0.975,
                                                na.rm=T))

lower.bound.presymp.shed.cum.mod.sars <- c(quantile(presymp.shed.cum.sample.slopes.sars, 
                                                0.025, na.rm=T),
                                       quantile(presymp.shed.cum.sample.intercepts.sars, 
                                                0.025, na.rm=T))

upper.bound.presymp.shed.cum.mod.sars <- c(quantile(presymp.shed.cum.sample.slopes.sars, 
                                                0.975, na.rm=T),
                                       quantile(presymp.shed.cum.sample.intercepts.sars, 
                                                0.975, na.rm=T))

```

### Plotting of analysis results
We plot the delay between symptom onset and peak viral shedding for each virus,
delay vs. viral replication rate, day of peak shedding vs. viral replication rate,
day of symptom onset vs. viral replication rate, and average viral shedding 
prior to symptoms vs. duration of the latency period in a 5-panel plot.
```{r, fig.height = 7.5, fig.width = 3.5}
measures.combined <- rbind(noro.measures, sars.measures)
measures.combined$pathogen <- ifelse(grepl('ID', measures.combined$ID), 
                                     'Norovirus', 'SARS-CoV-2')

cex <- 1.1
cex_labels <- 0.75
panellabelratio <- 0.975

tiff("Pre-symptomatic transmission analysis.tiff", res=500, height=6.5, width=3.5, unit="in")

par(mfrow=c(5, 1), oma=c(0.5, 2, 0.5, 0), mai=c(0.3, 0.5, 0.1, 0.1))

# Panel A: Delay between symptom onset and peak viral shedding 
{
  ylim.ab <- c(floor(min(measures.combined$delay_conservative, na.rm=T))-1, 
             ceiling(max(measures.combined$delay_conservative, na.rm=T))+1)
  
  plot(delay_conservative ~ jitter(ifelse(pathogen == 'Norovirus', 1, 2)), 
     data=measures.combined,
     col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
     xlim=c(.5, 2.5),
     ylim=ylim.ab, cex.axis=cex, cex=cex,
     pch=ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
                ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                       ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2', 23, 
                              ifelse(delay_conservative > 0 & pathogen == 'SARS-CoV-2', 5,
                                     9)))),
     bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
     yaxt="n",
     xaxt="n",
     ylab = "",
     xlab = "",
     mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  axis(1, at=seq(1,2), labels=unique(measures.combined$pathogen), cex.axis=cex, 
     mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
     las=2)
  
  #Average delays per pathogen
  for (i in 1:length(unique(measures.combined$pathogen))) {
  segments(-0.3 + i, 
           mean(measures.combined[measures.combined$pathogen == 
                         unique(measures.combined$pathogen)[i],]$delay_conservative,
                na.rm=T),
           -0.3 + i + 0.6, col=ifelse(unique(
             measures.combined$pathogen)[i] == 'Norovirus', 
                                      noro.color, sars.color), 
           lwd=cex)
  }
  
  #Pre-symptomatic vs post-symptomatic line
  abline(h=0, lty=3, lwd=cex)
  
  text(panellabelratio * 2 + .5, panellabelratio * (ylim.ab[2] - ylim.ab[1]) + 
       ylim.ab[1], labels="A", cex=cex, font=2)
}

# Panel B: Delay between symptom onset and peak viral shedding vs. viral
# growth rate

{
  xlim.bcd <- c(floor(min(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks),]$p2)) - 1,
              ceiling(max(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks),]$p2)) + 1)
  
  plot(delay_conservative ~ p2, data=measures.combined, 
   col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
   pch=ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
                ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                       ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2', 23, 
                              ifelse(delay_conservative > 0 & pathogen == 'SARS-CoV-2', 5,
                                     9)))),
   bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
   cex=cex, cex.axis=cex,
   ylab="", xlab="", xaxt="n", yaxt="n",
   ylim=ylim.ab,
   xlim=xlim.bcd,
   mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  
  bcd.xlabels <- lapply(seq(xlim.bcd[1], xlim.bcd[2], length.out=5), function(x) 
       bquote(10^.(x)))
  
  axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], length.out=5),
     labels=do.call(expression, bcd.xlabels),
     cex.axis=cex, 
     mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.ab[1],ylim.ab[2], length.out=5), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
     las=2)
  
  noro.r.range <- seq(min(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks) &
                                              measures.combined$pathogen == 'Norovirus',]$p2),
                      max(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks) &
                                              measures.combined$pathogen == 'Norovirus',]$p2),
                      length=10)
  
  sars.r.range <- seq(min(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks) &
                                              measures.combined$pathogen == 'SARS-CoV-2',]$p2),
                      max(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks) &
                                              measures.combined$pathogen == 'SARS-CoV-2',]$p2),
                      length=10)
  
  # Lines of best fit
  noro.bpred <- data.frame(p2 = noro.r.range)
  noro.bpred <- transform(noro.bpred, y_predicted = predict(lm.fit.p2.delay.conservative.noro, newdata=noro.bpred))
  lines(y_predicted ~ p2, data=noro.bpred, col=noro.color)
  
  sars.bpred <- data.frame(p2 = sars.r.range)
  sars.bpred <- transform(sars.bpred, y_predicted = predict(lm.fit.p2.delay.conservative.sars, newdata=sars.bpred))
  lines(y_predicted ~ p2, data=sars.bpred, col=sars.color)
  
  # Confidence bounds 
  noro.x <- noro.r.range
  noro.y.lower <- lower.bound.delay.conservative.mod.noro[1] * noro.x + lower.bound.delay.conservative.mod.noro[2]
  noro.y.higher <- upper.bound.delay.conservative.mod.noro[1] * noro.x + upper.bound.delay.conservative.mod.noro[2]
  
  polygon(c(rev(noro.x), noro.x), c(rev(noro.y.higher), noro.y.lower), 
        col = rgb(135, 26, 110, alpha=100,
                maxColorValue=255), border = NA)
  
  sars.x <- sars.r.range
  sars.y.lower <- lower.bound.delay.conservative.mod.sars[1] * sars.x + lower.bound.delay.conservative.mod.sars[2]
  sars.y.higher <- upper.bound.delay.conservative.mod.sars[1] * sars.x + upper.bound.delay.conservative.mod.sars[2]
  
  
  polygon(c(rev(sars.x), sars.x), c(rev(sars.y.higher), sars.y.lower), 
        col=rgb(86, 179, 233, alpha=100,
                maxColorValue=255), border = NA)
  
  abline(h=0, lty=3, lwd=cex)

  mtext(text="Day of peak viral shedding \n minus day of symptom onset",
        side=2, line=2.1, cex=cex_labels, adj=-0.5)
  
  text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1])  + xlim.bcd[1], 
     panellabelratio * (ylim.ab[2] - ylim.ab[1]) + ylim.ab[1], labels="B", 
     cex=cex, font=2)
  
}

# Panel C: Time of peak shedding vs. viral replication rate

{
  ylim.c <- c(floor(min(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks),]
                        $peak_time/24)) - 1, 
              ceiling(max(measures.combined[!measures.combined$ID %in% 
                                              c(noro.unclearpeaks, sars.unclearpeaks),]
                            $peak_time/24)) + 1)
  
  plot(peak_time/24 ~ p2, data=measures.combined,
     col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
     xlim=xlim.bcd,
     ylim=ylim.c, cex.axis=cex, cex=cex,
     pch=ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
              ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                     ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2', 23, 
                            ifelse(delay_conservative > 0 & pathogen == 'SARS-CoV-2', 5,
                                   9)))),
     bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
     xaxt="n", yaxt="n", ylab = "", xlab = "",
     mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  
  axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], length.out=5), 
     labels=do.call(expression, bcd.xlabels),
     cex.axis=cex, 
     mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.c[1],ylim.c[2], by=2), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, las=2)
  
  # Lines of best fit
  noro.cpred <- data.frame(p2 = noro.r.range)
  noro.cpred <- transform(noro.cpred, y_predicted = predict(lm.fit.p2.peaktime.noro, newdata=noro.cpred))
  lines(y_predicted ~ p2, data=noro.cpred, col=noro.color)
  
  sars.cpred <- data.frame(p2 = sars.r.range)
  sars.cpred <- transform(sars.cpred, y_predicted = predict(lm.fit.p2.peaktime.sars, newdata=sars.cpred))
  lines(y_predicted ~ p2, data=sars.cpred, col=sars.color)
  
  # Confidence bounds 
  noro.y.lower <- (lower.bound.peakshedding.mod.noro[1]/24) * noro.x +
    (lower.bound.peakshedding.mod.noro[2]/24)
  noro.y.higher <- (upper.bound.peakshedding.mod.noro[1]/24) * noro.x +
    (upper.bound.peakshedding.mod.noro[2]/24)
  
  polygon(c(rev(noro.x), noro.x), c(rev(noro.y.higher), noro.y.lower), 
        col=rgb(135, 26, 110, alpha=100,
                maxColorValue=255), border = NA)
  
  
  sars.y.lower <- (lower.bound.peakshedding.mod.sars[1]/24) * sars.x +
    (lower.bound.peakshedding.mod.sars[2]/24)
  sars.y.higher <- (upper.bound.peakshedding.mod.sars[1]/24) * sars.x +
    (upper.bound.peakshedding.mod.sars[2]/24)
  
  polygon(c(rev(sars.x), sars.x), c(rev(sars.y.higher), sars.y.lower), 
          col=rgb(86, 179, 233, alpha=100,
                maxColorValue=255), border = NA)
  
  mtext(text="Day of \npeak shedding", side=2, line=2, cex=cex_labels)
  
  text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
       panellabelratio * (ylim.c[2] - ylim.c[1]) + ylim.c[1], labels="C", 
       cex=cex, font=2)
}
  
# Panel D: Symptom onset vs. viral replication rate

{
  ylim.d <- c(floor(min(measures.combined$incubation, na.rm=T)) - 1, 
            ceiling(max(measures.combined$incubation, na.rm=T)) + 1)

  plot(incubation ~ p2, data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       xlim=xlim.bcd, ylim=ylim.d, cex.axis=cex, cex=cex,
       pch=ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
                ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                       ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2', 23, 
                              ifelse(delay_conservative > 0 & pathogen == 'SARS-CoV-2', 5,
                                     9)))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       yaxt="n", xaxt="n", ylab = "", xlab = "", bty='l')
  
  axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], length.out=5), 
     labels=do.call(expression, bcd.xlabels), 
     cex.axis=cex, 
     mgp=c(0, 0.5, 0), tck=-0.04)
  
  axis(2, at=seq(ylim.d[1], ylim.d[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, las=2)
  
    # Lines of best fit
  noro.dpred <- data.frame(p2 = noro.r.range)
  noro.dpred <- transform(noro.dpred, y_predicted = predict(lm.fit.p2.symponset.noro, newdata=noro.dpred))
  lines(y_predicted ~ p2, data=noro.dpred, col=noro.color)
  
  sars.dpred <- data.frame(p2 = sars.r.range)
  sars.dpred <- transform(sars.dpred, y_predicted = predict(lm.fit.p2.symponset.sars, newdata=sars.dpred))
  lines(y_predicted ~ p2, data=sars.dpred, col=sars.color)
  
  # Confidence bounds 
  noro.y.lower <- lower.bound.symponset.mod.noro[1] * noro.x + lower.bound.symponset.mod.noro[2]
  noro.y.higher <- upper.bound.symponset.mod.noro[1] * noro.x + upper.bound.symponset.mod.noro[2]
  
  polygon(c(rev(noro.x), noro.x), c(rev(noro.y.higher), noro.y.lower), 
          col = rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
  
  sars.y.lower <- lower.bound.symponset.mod.sars[1] * sars.x + lower.bound.symponset.mod.sars[2]
  sars.y.higher <- upper.bound.symponset.mod.sars[1] * sars.x + upper.bound.symponset.mod.sars[2]
  
  polygon(c(rev(sars.x), sars.x), c(rev(sars.y.higher), sars.y.lower), 
          col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
  
  mtext(text="Day of \nsymptom onset", side=2, line=2, cex=cex_labels)
  mtext(text=expression(Viral~replication~rate~(hour^-1)),
        side=1, line=2, cex=cex_labels)
  text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
       panellabelratio * (ylim.d[2] - ylim.d[1]) + ylim.d[1], 
       labels="D", cex=cex, font=2)
}

# Panel E: # Pre-symptomatic transmission potential vs. duration of latency period

{
  xrange <- c(floor(min(measures.combined$latency,
                na.rm=T)) - 1,
            ceiling(max(measures.combined$latency,
                na.rm=T)) + 1)

  yrange <- c(floor(min(measures.combined$presymp_transmission_avg,
                  na.rm=T)) - 1,
              ceiling(max(measures.combined$presymp_transmission_avg,
                  na.rm=T)) + 1)
  
  plot(presymp_transmission_avg ~ jitter(latency), 
       data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       pch=ifelse(is.na(ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
              ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                     ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2',
                            23, 5)))) | delay_conservative == 0,
              9, 
              ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
              ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                     ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2',
                            23, 5)))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       ylim=yrange,
       xlim=xrange,
       cex.axis=cex, cex=cex,
       ylab = "",
       xlab = "",
       xaxt="n",
       yaxt="n", bty='l')
  
  ylabels <- lapply(seq(yrange[1], yrange[2], by=2.5), function(x) 
       bquote(10^.(x)))
  axis(1, cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, at=seq(yrange[1], yrange[2], by=2.5),
       labels=do.call(expression, ylabels),
       las=2)
  
  legend(.5 * (xrange[2] - xrange[1]) + xrange[1], 
         1 * (yrange[2] - yrange[1]) + yrange[1], 
         legend=c("Pre-symptomatic", "Post-symptomatic", 
                  "Unclear peak (this panel only)"), 
     pch=c(19, 1, 9), col=c("black", "black", "black"), cex=cex_labels, bty="n")
  
  mtext(text="Average viral shedding \n prior to symptom onset",
        side=2, line=3, cex=cex_labels)
  mtext(text="Latency period (days)", side=1, line=1.5, cex=cex_labels)
  
    # Lines of best fit
  noro.latency.range <- seq(min(measures.combined[measures.combined$pathogen == 'Norovirus',]$latency, na.rm=T), 
                                max(measures.combined[measures.combined$pathogen == 'Norovirus',]$latency, na.rm=T), length=10)
  noro.pred <- data.frame(latency= noro.latency.range)
  noro.pred <- transform(noro.pred, y_predicted = predict(transmission.latent.avg.fit.noro, 
                                                          newdata=noro.pred))
  lines(y_predicted ~ latency, data=noro.pred, col=noro.color)
  
  sars.latency.range <- seq(min(measures.combined[measures.combined$pathogen == 'SARS-CoV-2',]$latency, na.rm=T), 
                                max(measures.combined[measures.combined$pathogen == 'SARS-CoV-2',]$latency, na.rm=T), length=10)
  sars.pred <- data.frame(latency = sars.latency.range)
  sars.pred <- transform(sars.pred, y_predicted = predict(transmission.latent.avg.fit.sars, 
                                                           newdata=sars.pred))
  lines(y_predicted ~ latency, data=sars.pred, col=sars.color)
  
  # Confidence bounds 
  noro.x <- noro.latency.range
  noro.y.lower <- lower.bound.presymp.shed.avg.mod.noro[1] * noro.x + lower.bound.presymp.shed.avg.mod.noro[2]
  noro.y.higher <- upper.bound.presymp.shed.avg.mod.noro[1] * noro.x + upper.bound.presymp.shed.avg.mod.noro[2]
  
  polygon(c(rev(noro.x), noro.x), c(rev(noro.y.higher), noro.y.lower), 
          col = rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
  
  sars.x <- sars.latency.range
  sars.y.lower <- lower.bound.presymp.shed.avg.mod.sars[1] * sars.x + lower.bound.presymp.shed.avg.mod.sars[2]
  sars.y.higher <- upper.bound.presymp.shed.avg.mod.sars[1] * sars.x + upper.bound.presymp.shed.avg.mod.sars[2]
  
  polygon(c(rev(sars.x), sars.x), c(rev(sars.y.higher), sars.y.lower), 
          col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
  
  text(panellabelratio * (xrange[2] - xrange[1]) + xrange[1], 
       panellabelratio * (yrange[2] - yrange[1]) + yrange[1], 
       labels="E", cex=cex, font=2)
}

dev.off()
```

We again plot delay vs. virus and delay vs. viral replication rate using
the non-conservative measure of pre-symptomatic transmission (shedding onset
minus symptom onset).
```{r, fig.height = 6, fig.width = 3.5}

tiff("Non-conservative pre-symptomatic transmission analysis.tiff", res=500, height=6.5, width=3.5, unit="in")

par(mfrow=c(5, 1), oma=c(0.5, 2, 0.5, 0), mai=c(0.3, 0.5, 0.1, 0.1))

# Panel A: Delay between symptom onset and shedding onset
{  
  ylim.ab <- c(floor(min(measures.combined$delay_nonconservative, na.rm=T))-1, 
               ceiling(max(measures.combined$delay_nonconservative, na.rm=T))+1)
  
  plot(delay_nonconservative ~ jitter(ifelse(pathogen == 'Norovirus', 1, 2)), 
       data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       xlim=c(.5, 2.5),
       ylim=ylim.ab, cex.axis=cex, cex=cex,
       pch=ifelse(delay_nonconservative < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(delay_nonconservative > 0 & pathogen == 'Norovirus', 2,
                         ifelse(delay_nonconservative < 0 & pathogen == 'SARS-CoV-2', 23, 
                                ifelse(delay_nonconservative > 0 & pathogen == 'SARS-CoV-2', 5,
                                       9)))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       yaxt="n",
       xaxt="n",
       ylab = "",
       xlab = "",
       mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  axis(1, at=seq(1,2), labels=unique(measures.combined$pathogen), cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
       las=2)
  
  #Average delays per pathogen
  for (i in 1:length(unique(measures.combined$pathogen))) {
    segments(-0.3 + i, 
             mean(measures.combined[measures.combined$pathogen == 
                           unique(measures.combined$pathogen)[i],]$delay_nonconservative,
                  na.rm=T),
             -0.3 + i + 0.6, col=ifelse(unique(
               measures.combined$pathogen)[i] == 'Norovirus', 
                                        noro.color, sars.color), 
             lwd=cex)
  }

  #Pre-symptomatic vs post-symptomatic line
  abline(h=0, lty=3, lwd=cex)
  
  text(panellabelratio * 2 + .5, panellabelratio * (ylim.ab[2] - ylim.ab[1]) + 
         ylim.ab[1], labels="A", cex=cex, font=2)
}
  
  # Panel B: Delay between symptom onset and peak viral shedding vs. viral
  # growth rate
  
{
  xlim.bcd <- c(floor(min(measures.combined$p2)) - 1,
                ceiling(max(measures.combined$p2)) + 1)
    
  plot(delay_nonconservative ~ p2, data=measures.combined, 
     col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
     pch=ifelse(delay_nonconservative < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(delay_nonconservative > 0 & pathogen == 'Norovirus', 2,
                         ifelse(delay_nonconservative < 0 & pathogen == 'SARS-CoV-2', 23, 
                                ifelse(delay_nonconservative > 0 & pathogen == 'SARS-CoV-2', 5,
                                       9)))),
     bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
     cex=cex, cex.axis=cex,
     ylab="", xlab="", xaxt="n", yaxt="n",
     ylim=ylim.ab,
     xlim=xlim.bcd,
     mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
  
  bcd.xlabels <- lapply(seq(xlim.bcd[1], xlim.bcd[2], length.out=5), function(x) 
         bquote(10^.(x)))
  
  axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], length.out=5),
       labels=do.call(expression, bcd.xlabels),
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, at=seq(ylim.ab[1],ylim.ab[2], length.out=5), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
       las=2)
  
  noro.r.range <- seq(min(
    measures.combined[measures.combined$pathogen == 'Norovirus',]$p2),
    max(measures.combined[measures.combined$pathogen == 'Norovirus',]$p2),
    length=10)
  
  sars.r.range <- seq(min(
    measures.combined[measures.combined$pathogen == 'SARS-CoV-2',]$p2),
    max(measures.combined[measures.combined$pathogen == 'SARS-CoV-2',]$p2),
    length=10)
  
  # Lines of best fit
  noro.bpred <- data.frame(p2 = noro.r.range)
  noro.bpred <- transform(noro.bpred, y_predicted = predict(lm.fit.p2.delay.nonconservative.noro, newdata=noro.bpred))
  lines(y_predicted ~ p2, data=noro.bpred, col=noro.color)
  
  sars.bpred <- data.frame(p2 = sars.r.range)
  sars.bpred <- transform(sars.bpred, y_predicted = predict(lm.fit.p2.delay.nonconservative.sars, newdata=sars.bpred))
  lines(y_predicted ~ p2, data=sars.bpred, col=sars.color)
  
  # Confidence bounds 
  noro.x <- noro.r.range
  noro.y.lower <- lower.bound.delay.nonconservative.mod.noro[1] * noro.x + 
    lower.bound.delay.nonconservative.mod.noro[2]
  noro.y.higher <- upper.bound.delay.nonconservative.mod.noro[1] * noro.x + 
    upper.bound.delay.nonconservative.mod.noro[2]
  
  polygon(c(rev(noro.x), noro.x), c(rev(noro.y.higher), noro.y.lower), 
          col = rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
  
  sars.x <- sars.r.range
  sars.y.lower <- lower.bound.delay.nonconservative.mod.sars[1] * sars.x + 
    lower.bound.delay.nonconservative.mod.sars[2]
  sars.y.higher <- upper.bound.delay.nonconservative.mod.sars[1] * sars.x + 
    upper.bound.delay.nonconservative.mod.sars[2]
  
  polygon(c(rev(sars.x), sars.x), c(rev(sars.y.higher), sars.y.lower), 
          col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
  
  abline(h=0, lty=3, lwd=cex)
  
  mtext(text=expression(Viral~replication~rate~(hour^-1)),
        side=1, line=2.5, cex=cex_labels)
  mtext(text="Day of shedding onset \n minus day of symptom onset",
        side=2, line=2.1, cex=cex_labels)

  text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1])  + xlim.bcd[1], 
       panellabelratio * (ylim.ab[2] - ylim.ab[1]) + ylim.ab[1], labels="B", 
       cex=cex, font=2)
}

dev.off()
```

Lastly, we plot cumulative pre-symptomatic shedding vs. the duration of the
latency period, as an alternative measure of pre-symptomatic transmission 
potential. As with average pre-symptomatic shedding, there is no pattern.
```{r}

tiff("Cumulative pre-symptomatic shedding vs. latency period.tiff", res=500, 
     height=6.5, width=3.5, unit="in")

par(mfrow=c(5, 1), oma=c(0.5, 2, 0.5, 0), mai=c(0.3, 0.5, 0.1, 0.1))

plot.new()
{
  xrange <- c(floor(min(measures.combined$latency,
                na.rm=T)) - 1,
            ceiling(max(measures.combined$latency,
                na.rm=T)) + 1)

  yrange <- c(floor(min(measures.combined$presymp_transmission_cum,
                  na.rm=T)) - 1,
              ceiling(max(measures.combined$presymp_transmission_cum,
                  na.rm=T)) + 1)
  
  plot(presymp_transmission_cum ~ jitter(latency), 
       data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       pch=ifelse(is.na(ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
              ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                     ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2',
                            23, 5)))) | delay_conservative == 0,
              9, 
              ifelse(delay_conservative < 0 & pathogen == 'Norovirus', 17, 
              ifelse(delay_conservative > 0 & pathogen == 'Norovirus', 2,
                     ifelse(delay_conservative < 0 & pathogen == 'SARS-CoV-2',
                            23, 5)))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       ylim=yrange,
       xlim=xrange,
       cex.axis=cex, cex=cex,
       ylab = "",
       xlab = "",
       xaxt="n",
       yaxt="n", bty='l')
  
  ylabels <- lapply(seq(yrange[1], yrange[2], by=2.5), function(x) 
       bquote(10^.(x)))
  axis(1, cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04)
  axis(2, cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, at=seq(yrange[1], yrange[2], by=2.5),
       labels=do.call(expression, ylabels),
       las=2)
  
  mtext(text="Cumulative viral shedding \n prior to symptom onset",
        side=2, line=3, cex=cex_labels)
  mtext(text="Latency period (days)", side=1, line=1.5, cex=cex_labels)
  
    # Lines of best fit
  noro.latency.range <- seq(min(measures.combined[measures.combined$pathogen == 'Norovirus',]$latency, na.rm=T), 
                                max(measures.combined[measures.combined$pathogen == 'Norovirus',]$latency, na.rm=T), length=10)
  noro.pred <- data.frame(latency= noro.latency.range)
  noro.pred <- transform(noro.pred, y_predicted = predict(transmission.latent.cum.fit.noro, 
                                                          newdata=noro.pred))
  lines(y_predicted ~ latency, data=noro.pred, col=noro.color)
  
  sars.latency.range <- seq(min(measures.combined[measures.combined$pathogen == 'SARS-CoV-2',]$latency, na.rm=T), 
                                max(measures.combined[measures.combined$pathogen == 'SARS-CoV-2',]$latency, na.rm=T), length=10)
  sars.pred <- data.frame(latency = sars.latency.range)
  sars.pred <- transform(sars.pred, y_predicted = predict(transmission.latent.cum.fit.sars, 
                                                           newdata=sars.pred))
  lines(y_predicted ~ latency, data=sars.pred, col=sars.color)
  
  # Confidence bounds 
  noro.x <- noro.latency.range
  noro.y.lower <- lower.bound.presymp.shed.cum.mod.noro[1] * noro.x + lower.bound.presymp.shed.cum.mod.noro[2]
  noro.y.higher <- upper.bound.presymp.shed.cum.mod.noro[1] * noro.x + upper.bound.presymp.shed.cum.mod.noro[2]
  
  polygon(c(rev(noro.x), noro.x), c(rev(noro.y.higher), noro.y.lower), 
          col = rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
  
  sars.x <- sars.latency.range
  sars.y.lower <- lower.bound.presymp.shed.cum.mod.sars[1] * sars.x + lower.bound.presymp.shed.cum.mod.sars[2]
  sars.y.higher <- upper.bound.presymp.shed.cum.mod.sars[1] * sars.x + upper.bound.presymp.shed.cum.mod.sars[2]
  
  polygon(c(rev(sars.x), sars.x), c(rev(sars.y.higher), sars.y.lower), 
          col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
}

dev.off()
```

For clarification, we plot the differences in incubation periods reported in 
Ge *et al.*, 2023 versus Atmar *et al.*, 2008.
```{r}
atmarIDs <- read.csv(here("data", "atmarIDs.csv"))

# Using peak viral load, inoculum dose, and type of symptoms to match up participant IDs

geSymptomData <- noroData$mvs
geSymptomData$type <- ""
geSymptomData$type[geSymptomData$mvsc3>0] <- "v"
# mvsc3 indicates duration of vomiting
# mvsc1 indicates duration of diarrhea
geSymptomData$type[geSymptomData$mvsc3>0 & geSymptomData$mvsc1>0] <- "dv"

# Participant ID4 had reported viral shedding in vomit; we and the authors
# of the study do not know why mvsc3 = 0
geSymptomData[geSymptomData$ID == 'ID4',]$type <- "dv"

geIDs <- do.call(rbind, 
                  lapply(noroParticipants,
                         function(x) data.frame(
                           geID=x,
                           dose=unique(noro.FShedData[noro.FShedData$ID == x,]$dose),
                           peak=round(log10(max(noro.FShedData[noro.FShedData$ID == x,]$y_virus, na.rm=T)), 1),
                           symptom.type=geSymptomData[geSymptomData$ID==x,]$type)))

ID_dict_noro <- merge(atmarIDs, geIDs, by=c("dose", "peak", "symptom.type"))

combinedNoroData <- merge(merge(ID_dict_noro, noro.IncubData, by.x = 'geID', 
                              by.y='ID')[, c(1, 5, 8, 6)], participant.peaktimes.noro,
                          by.x="geID", by.y="ID")
colnames(combinedNoroData) <- c('geID', 'atmarID', 'geIncubation', 'atmarIncubation',
                                'peaktime')

# Manually adding in ID10/720 because their trajectories are identical, but
# their symptoms do not match up between the two datasets
combinedNoroData <- rbind(combinedNoroData, 
                          data.frame(geID = 'ID10', atmarID='720', 
                                     geIncubation = noro.IncubData[
                                       noro.IncubData$ID == 'ID10',]$incubation,
                                     atmarIncubation = atmarIDs[
                                       (atmarIDs$atmarID == '720') & 
                                         (!is.na(atmarIDs$atmarID)),]$incubation,
                                     peaktime = participant.peaktimes.noro[
                                       participant.peaktimes.noro$ID == 'ID10',]$peaktime))

# Manual ordering of IDs
combinedNoroData <- combinedNoroData[c(1, 7, 8, 9, 10, 11, 12, 13, 2, 3, 4, 5, 6),]



atmarColor <- "#f1a340"
geColor <- "#871a6e"

tiff(filename="Symptom Onset Discrepancy.tiff", height=3.5, width=5, units = "in",
    res=500)

{par(mar=c(4.1, 3.6, 0.5, 0.1), oma=c(2, 0, 0, 0))
plot(1:nrow(combinedNoroData), combinedNoroData$atmarIncubation, xaxt="n",
     ylim=c(0, 5), col=atmarColor, xlab="", ylab="",
     bty="n")
axis(1, at=1:nrow(combinedNoroData), 
     labels=combinedNoroData$geID,las=2, col.axis=geColor)
axis(1, at=1:(nrow(combinedNoroData)), 
     labels=paste(combinedNoroData$atmarID, ' /        ', sep=''), las=2, 
     col.axis=atmarColor)
mtext("Participant ID", side=1, line=5)
mtext("Day", side=2, line=2.5)
legend(4, 5, pch=c(1, 1, 16), col=c(atmarColor, geColor, 'black'), 
       legend=c(bquote("Atmar" ~ italic("et al.") ~ 2008 ~ "\u2014 symptom onset"), 
                bquote("Ge" ~ italic("et al.") ~ 2023 ~ "\u2014 symptom onset"),
                "Peak viral shedding"))
points(1:nrow(combinedNoroData), combinedNoroData$geIncubation, col=geColor)
points(1:nrow(combinedNoroData), combinedNoroData$peaktime/24, pch=16)
}
```
