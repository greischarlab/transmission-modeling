---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

My packages for ODE models and plotting:

```{r}
require(deSolve)
require(ggplot2)
require(gridExtra)
```

Here, I have my ODE model, a function for calculating transmission potential from pathogen load, and a function for creating a dataframe containing the results of the model. I assume transmission potential is directly proportional to pathogen load via a constant k. Assuming that pathogen clearance is reached as soon as pathogen load reaches 0, I cut off the dataframe as soon as transmission potential reaches 0.
```{r}
transmission.model <- function(t, x, params) {
  P <- x[1]
  X <- x[2]
  
  with(
    as.list(params),
    {
      dP <- r*P - k*X*P
      dX <- a - d*X + y*k*X*P
    
      res <- c(dP, dX)
      list(res)
    }
  )
}

transmission.potential <- function(k, P) {
  return(ifelse(k*P < 0, 0, k*P))
}

cutter <- function(dose, time, params) {
  df= data.frame(lsoda(c(P=dose, X=0), time, transmission.model, params))
  if(any(df$P) <= 0){
    clearance = min(which(df$P <= 0))
    df[clearance:length(time)] = NA
  }
  return(df)
}
```

These first three sets of parameters were used in King et al., and I use them here to 1) plot immune response over time and 2) plot a simple model of transmission where symptoms are determined by a pathogen load threshold (explained below). I varied the infectious dose values by a factor of 10^2, set the time steps as 0.001 from 0 to 2 units and the proportionality constant between pathogen load and transmission potential to 10^-3, and differentiated the infectious doses by color (light grey to black). 
```{r}
params40 <- c(r=40, k=3.5, y=10^-4, a=1, d=.5)
params70 <- c(r=70, k=3.5, y=10^-4, a=1, d=.5)
params100 <- c(r=100, k=3.5, y=10^-4, a=1, d=.5)
time <- seq(0,2, by=0.001)
lowid <- 1
medid <- 100
highid <- 10000
ids <- data.frame(low=lowid, med=medid, high=highid)
k <- 10^-3
```

I first plotted immune response over time to visualize immune dynamics over the course of infection.
```{r}
plot.immune.response.panel <- function(ids, params, cols, label, time) {
  datalow= cutter(ids$low, time, params)
  datamed= cutter(ids$med, time, params)
  datahigh= cutter(ids$high, time, params)
  
  plot(datalow$time, datalow$X, col=cols[1], type="l", ylim=c(0, 300),
       xlab="Time", ylab="Immune Response", main=paste("R value:", params[1]),
       cex.lab=2, cex.axis=1.5, cex.main=2)
  text(0.05, 280, labels=label, font=2, cex=2)
  
  lines(datamed$time, datamed$X, col=cols[2])
  lines(datahigh$time, datahigh$X, col=cols[3])
}

#Plotting immune response over time

png("./Figures/Immune response.png", width=1000, height=900)

par(mfrow=c(2, 2), mar=c(5.1, 6.1, 4.1, 3.1))

plot.immune.response.panel(ids, params40, cols, "A)", time)

legend(0.18, 290, 
       title="Relative Infectious Dose",
       legend=c("1", "100", "10000"), 
       col=c(smallcolor, medcolor, highcolor), 
       cex=2, text.font=2, lty=1)

plot.immune.response.panel(ids, params70, cols, "B)")

plot.immune.response.panel(ids, params100, cols, "C)")

dev.off()
```

I constructed a function to determine peak immune response for applicable combinations of r and gamma values. Using this value, I can then determine two thresholds for determining symptoms--below, and right at it--via another function.
```{r}
peak.immuneresponse <- function(data) {
  peak = max(data$immune)
  return(peak)
}

symptom.thresh <- function(data, thresh.type) {
  peak.immune <- peak.immuneresponse(data)
  
  if(thresh.type == 'high') {
    return (peak.immune * 2)
  } else if (thresh.type == 'med') {
    return(peak.immune)
  } else {
    return(peak.immune / 2)
  }
}

symptomatic.df <- function(data, thresh) {
  symp= data[data$immune >= thresh,]
  
  return(symp)
}
```

The first model I examine is one in which symptom onset and duration is dependent only on pathogen load. This is represented by a dotted horizontal red line depicting the threshold for symptoms. I am defining presymptomatic transmission as reaching peak transmission potential before symptom onset. This is a conservative way of estimating presymptomatic transmission. Given this definition, there are two cases for transmission in this model: 1) symptoms threshold is below peak pathogen load, and 2) symptoms threshold is above peak pathogen load. The outlier case (symptoms threshold is at peak pathogen load) doesn't signify much--it just suggests that the person is symptomatic only at one point throughout the infection. I plotted three plots, each with three lines; each plot signifies a different pathogen replication rate (r), and each line signifies a different infectious dose.
```{r}
plot.simple.model.panel <- function(symp.thresh, k, datalow, datamed, datahigh, 
                                    cols, cex) {
  lowcolor= cols[1]
  medcolor= cols[2]
  highcolor= cols[3]
  
  plot(1, type="n", xlab='', ylab='', xlim=c(0, 0.4), ylim=c(1, 600), 
       cex.axis=3)
  
  plot.transmission.lines(datalow, k, lowcolor)
  plot.transmission.lines(datamed, k, medcolor)
  plot.transmission.lines(datahigh, k, highcolor)
  abline(h=symp.thresh, lty=3, col="red")
  mtext(text="Time", side=1, line=6, cex=cex)
  mtext(text="Transmission Potential", side=2, line=6, cex=cex)
  
  legend(0.23, 600, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptom threshold"), 
           lty= c(1, 1, 1, 3, 3), col=c(cols, "red"), lwd=3, 
           cex=2, text.font=2) 
}

plot.transmission.lines <- function(df, k, color) {
  lines(df$time, transmission.potential(k, df$P), col=color)
}

datalow <- cutter(ids$low, time, params40)
datamed <- cutter(ids$med, time, params40)
datahigh <- cutter(ids$high, time, params40)
cols <- c("#009E73", "#871a6e",  "#E69F00")
  
#Case 1: Symptoms threshold is below transmission threshold

{
  png("./Figures/Simple Model.png", width=1000, height=700)
  par(mar=c(7.1, 9.1, 4.1, 3.1))
  symp.thresh <- 430
  
  { 
  
    plot.simple.model.panel(symp.thresh, k, datalow, datamed, datahigh, cols, 5)
    
  }

  dev.off()
}

```

The second model I examine is one in which symptom onset and duration is dependent only on immune response. When immune response rises above a certain threshold, the patient is symptomatic, as represented by a boldening of the transmission potential line.
```{r}
plot.immune.model.panel <- function(symp.thresh, r, label, cols, y, vary) {
  par(mar=c(5.1, 6.1, 4.1, 3.1))
  params=c(r=r, k=3.5, y=y, a=1, d=.5)
  
  datalow= data.frame(lsoda(c(P=lowid, X=0), time, transmission.model, params))
  datamed= data.frame(lsoda(c(P=medid, X=0), time, transmission.model, params))
  datahigh=- data.frame(lsoda(c(P=highid, X=0), time, transmission.model, params))
  
  dfs <- list(datalow, datamed, datahigh)
  
  plot(1, type="n", xlab='', ylab='', log='y', xlim=c(0, 0.5), ylim=c(1, 10^4), 
       cex.lab=2, cex.axis=1.5, cex.main=2)
  plot.immune.model.line(datalow, symp.thresh, cols$low)
  plot.immune.model.line(datamed, symp.thresh, cols$med)
  plot.immune.model.line(datahigh, symp.thresh, cols$high)
  
  if(vary=="gamma") {
    mtext(text=bquote("Transmission when "~ gamma ~ " = " ~ .(y)), font=2, side=3, line=1, cex=2)
    text(0.05, 6000, labels=label, font=2, cex=2)
  } else {
    text(0.25, 10^11, labels=label, font=2, cex=2)
    mtext(text=bquote("Transmission when r =" ~ .(r)), side=3, font=2, line=1, cex=2)
  }
}

plot.immune.model.line <- function(data, symp.thresh, col) {
  data=data[transmission.potential(k, data$P) > 0,]
  lines(data$time, transmission.potential(k, data$P), col=col)
  symptomatic <- data[data$X >= symp.thresh,]
  lines(symptomatic$time, transmission.potential(k,symptomatic$P), lwd=3)
}

symp.thresh <- 5

#r varies. gamma= 10^-4

r <- seq(10, 130, by=10)

png("./Figures/Immune-based symptoms varying r.png", width=1400, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 12)) {
  
  plot.immune.model.panel(symp.thresh, round(r[i]), paste(LETTERS[i], ")"), cols, 10^-4, "r")

  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.21, 8800, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }

}

dev.off()

#gamma varies. r=40.

symp.thresh <- 5

y <- seq(.5 * 10^-4, 1.5*10^-4, by=.1*10^-4)

png("./Figures/Immune-based symptoms varying y many.png", width=1600, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 11)) {
  
  plot.immune.model.panel(symp.thresh, 40, paste(LETTERS[i], ")"), cols, y[i], "gamma")
  
  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.27, 10000, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }
  
}

dev.off()

```

# Plots of delay between pathogen load peak and symptom onset for different r and gamma values

On 11/21/21, I'm going to vary gamma and r and plot the delay between peak pathogen load and symptom onset against various r and gamma values (separately). 

```{r}  
gamma_variable <- seq(0.5 * 10^-4, 1.5 * 10^-4, by=7.692308e-06)
medgamma <- 10^-4
r_variable <- seq(10, 130, by=10)
medr <- 70
gamma <- "\u03B3"

get.params <- function(gamma, r) {
  return (c(y=gamma, r=r, a=1, d=.5, k=3.5))
}

desolve_function <- function(gamma, r, id, k) {
  time = seq(0,2, by=0.001)
  parameter_value = get.params(gamma, r)
  df = cutter(id, time, parameter_value)
  tp = data.frame(time=time, transmission_potential=transmission.potential(k, df$P), immune=df$X, gamma=gamma, r=r, dose=id)
  return(tp)
}

peak.pathogenloadtime <- function(df, k) {
  peak.pl= max(df$transmission_potential)
  return(df[which(df$transmission_potential==peak.pl),]$time)
}

symptom.onset <- function(df, thresh) {
  symptomatic= df[which(df$immune >= thresh),]$time
  if(length(symptomatic) > 0) {
    return(min(symptomatic))
  } else {
    return(NA)
  }
}

get.delay.peakload.symponset <- function(data, vals, symp.thresh, var_name) {
  delays.df <- data.frame(placeholder_name=integer(), delay.peakload.symponset=integer())
  names(delays.df)[names(delays.df) == "placeholder_name"] = var_name
  
  for (v in vals) {
    df= data[data[var_name]==v,]
    delay.peakload.symponset= peak.pathogenloadtime(df, k) - symptom.onset(df, symp.thresh)
    dftoadd= data.frame(v, delay.peakload.symponset)
    names(dftoadd)= c(var_name, "delay.peakload.symponset")
    delays.df <- rbind(delays.df, dftoadd)
  }
  
  return(delays.df)
}

k <- 10^-3
low.sympthresh <- 5
med.sympthresh <- 10
high.sympthresh <- 15

#Varying r and determinine delay between peak pathogen load and symptom onset accordingly. Dynamically, varyingr is a list.
varyingr <- data.frame(gamma= medgamma, r=r_variable, dose=ids$low)
varyingr <- do.call(rbind, mapply(desolve_function, varyingr$gamma, varyingr$r, varyingr$dose, k, SIMPLIFY = FALSE))

delays.byr.lowsympthresh <- get.delay.peakload.symponset(varyingr, r_variable, low.sympthresh, "r")
delays.byr.medsympthresh <- get.delay.peakload.symponset(varyingr, r_variable, med.sympthresh, "r")
delays.byr.highsympthresh <- get.delay.peakload.symponset(varyingr, r_variable, high.sympthresh, "r")

write.csv(delays.byr.lowsympthresh, "Delays by r low symp thresh.csv")
write.csv(delays.byr.medsympthresh, "Delays by r med symp thresh.csv")
write.csv(delays.byr.highsympthresh, "Delays by r high symp thresh.csv")

#Varying gamma and determinine delay between peak pathogen load and symptom onset accordingly. Dynamically, varyinggamma is a list.
varyinggamma <- data.frame(gamma=gamma_variable, r=medr, dose=ids$low)
varyinggamma <- do.call(rbind, mapply(desolve_function, varyinggamma$gamma, varyinggamma$r, id=varyinggamma$dose, k, SIMPLIFY = FALSE))

delays.df.bygamma <- data.frame(gamma=integer(), delay.peakload.symponset=integer())

delays.bygamma.lowsympthresh <- get.delay.peakload.symponset(varyinggamma, gamma_variable, low.sympthresh, "gamma")
delays.bygamma.medsympthresh <- get.delay.peakload.symponset(varyinggamma, gamma_variable, med.sympthresh, "gamma")
delays.bygamma.highsympthresh <- get.delay.peakload.symponset(varyinggamma, gamma_variable, high.sympthresh, "gamma")

write.csv(delays.bygamma.lowsympthresh, "Delays by gamma low symp thresh.csv")
write.csv(delays.bygamma.medsympthresh, "Delays by gamma med symp thresh.csv")
write.csv(delays.bygamma.highsympthresh, "Delays by gamma high symp thresh.csv")
```

On 12/2/21, I'm simulating groups of 10 people per infectious dose with varying r values and calculating the frequency of presymptomatic transmission per dose/group.
```{r}
get.presymp <- function(df, k, symp.thresh) {
  delay= peak.pathogenloadtime(df, k) - symptom.onset(df, symp.thresh)
  if(!(is.na(delay)) && delay < 0) {
    return(TRUE)
  } else{
    return(FALSE)
  }
}

get.freqpresymp <- function(df, symp.thresh, k) {
  presymp= 0
  
  patients= unique(df$r)
  for (p in  patients) {
    patientdf= df[df$r==p,]
    if(get.presymp(patientdf, k, symp.thresh)) {
      presymp = presymp + 1
    }
  }
  
  freq.presymp= presymp / length(patients)
  
  return(freq.presymp)
}

k <- 10^-3
low.sympthresh <- 5
med.sympthresh <- 10
high.sympthresh <- 15
medgamma <- 10^-4
medr <- 70

populationrvals <- runif(140, 10, 130)
dosevals <- 10^seq(0,6)

varyingdose <- data.frame(gamma= medgamma, r=populationrvals, dose=rep(dosevals, each=100))

# Below, varyingdose is a list.
varyingdose <- do.call(rbind, mapply(desolve_function, varyingdose$gamma, varyingdose$r, varyingdose$dose, k, SIMPLIFY = FALSE))

write.csv(varyingdose, "Dataframe with varying doses and r values (indicating different patients).csv")

freqpresymp.bydose.highsympthresh <- data.frame(dose=integer(), freq.presymp=integer())

for (d in dosevals) {
  df= varyingdose[varyingdose$dose==d,]
  dftoadd= data.frame(d, get.freqpresymp(df, high.sympthresh, k))
  names(dftoadd)= c("dose", "freq.presymp")
  freqpresymp.bydose.highsympthresh <- rbind(freqpresymp.bydose.highsympthresh, dftoadd)
}

write.csv(freqpresymp.bydose.lowsympthresh, "Frequency of Presymptomatic Transmission by Dose (low symptom threshold, group population at 100).csv")

write.csv(freqpresymp.bydose.medsympthresh, "Frequency of Presymptomatic Transmission by Dose (low symptom threshold, group population at 100).csv")

write.csv(freqpresymp.bydose.highsympthresh, "Frequency of Presymptomatic Transmission by Dose (low symptom threshold, group population at 100).csv")
```

Here, I plot the results. These are scatterplots showing delay between peak pathogen load and symptom onset vs. either replication rate r or immune response recruitment rate gamma.
```{r}

plot.varyingr <- function(delaysbyr, symp.thresh) {
  ggplot(delaysbyr, aes(x=r, y=delay.peakload.symponset)) + 
  geom_point() +
  xlab("Replication Rate (r)") + 
  ylab("Delay Between Peak Pathogen Load and Symptom Onset") + 
  ggtitle(paste("Varying Replication Rate r (symptoms threshold = ", symp.thresh, ")")) +
  theme(strip.background = element_rect(fill="lightblue"))
}

plot.varyingr(delays.byr.lowsympthresh, low.sympthresh)
plot.varyingr(delays.byr.medsympthresh, med.sympthresh)
plot.varyingr(delays.byr.highsympthresh, high.sympthresh)

plot.varyinggamma <- function(delaysbygamma, symp.thresh) {
  ggplot(delaysbygamma, aes(x=gamma, y=delay.peakload.symponset)) + geom_point() +
  xlab(paste("Immune Response Recruitment Rate (", gamma, ")")) + 
  ylab("Delay Between Peak Pathogen Load and Symptom Onset") + 
  ggtitle(paste("Varying Immune Response Recruitment Rate (", gamma, ") ", "(symptoms threshold = ", symp.thresh, ")")) +
  theme(strip.background = element_rect(fill="lightblue"))
}

plot.varyinggamma(delays.bygamma.lowsympthresh, low.sympthresh)
plot.varyinggamma(delays.bygamma.medsympthresh, med.sympthresh)
plot.varyinggamma(delays.bygamma.highsympthresh, high.sympthresh)

plot.varyingdose <- function(presympfreq.bydose, symp.thresh) {
  ggplot(presympfreq.bydose, aes(x=dose, y=freq.presymp)) + geom_point() +
  xlab("Infectious Dose") + 
  ylab("Frequency of Presymptomatic Transmission") + 
  ggtitle(paste("Varying Infectious Dose ", "(symptoms threshold = ", symp.thresh, ")")) +
  theme(strip.background = element_rect(fill="lightblue")) +
  scale_x_log10()
}; plot.varyingdose(freqpresymp.bydose.highsympthresh, high.sympthresh)

```

On 12/3/21, I'm examining the dynamics of a couple of points that seemed to oscillate in my delay between
peak pathogen load and symptom onset vs. immune response recruitment rate plot.

```{r}

plot.dynamics <- function(df, point, symp.thresh, var_name) {
  cols= c("Transmission Potential"= "black", "Immune Response" = "purple", 
          "Symptom Threshold" = "red")
  linetypes= c("Transmission Potential"= "solid", "Immune Response" = "solid", 
          "Symptom Threshold" = "dashed")
  
  ggplot(df[df[var_name]==point,], 
         aes(x=time, y=log10(transmission_potential))) + 
  geom_line(aes(color="Transmission Potential", linetype="Transmission Potential")) + 
  geom_line(aes(y=log10(immune), 
             color="Immune Response", linetype="Immune Response")) + 
  geom_hline(aes(yintercept=log10(symp.thresh),
             color="Symptom Threshold", linetype="Symptom Threshold")) +
  
  xlab("Time") + ylab("Transmission Potential (log10)") + xlim(.15, 0.25) + 
  scale_y_continuous(limits=c(-20, 5), sec.axis=sec_axis(~. *1, name="Immune Response (log10)")) +
  scale_color_manual(name="",values = cols) +
  scale_linetype_manual(name="",values = linetypes) 
}

points <- c(delays.bygamma.highsympthresh$gamma[4], delays.bygamma.highsympthresh$gamma[5],
  delays.bygamma.highsympthresh$gamma[6], delays.bygamma.highsympthresh$gamma[7])

dfpoints <- varyinggamma[varyinggamma$gamma %in% points,]
#This is the point (gamma value) at which transmission potential was at 0 right before oscillating to a peak (0.001).

plot.dynamics(varyinggamma, delays.bygamma.highsympthresh$gamma[4], high.sympthresh, "gamma")

#This is the point (gamma value) at which transmission potential was at 0.001 (peak) 
plot.dynamics(varyinggamma, delays.bygamma.highsympthresh$gamma[5], high.sympthresh, "gamma")

#Transmission potential is still at 0.001 (peak) before oscillating back down to 0
plot.dynamics(varyinggamma, delays.bygamma.highsympthresh$gamma[6], high.sympthresh, "gamma")

#Transmission potential oscillates back down to 0
plot.dynamics(varyinggamma, delays.bygamma.highsympthresh$gamma[7], high.sympthresh, "gamma")

```