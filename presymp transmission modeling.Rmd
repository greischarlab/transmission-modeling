---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

My packages for ODE models and plotting:

```{r}
require(deSolve)
require(ggplot2)
```

Here, I have my ODE model, a function for calculating transmission potential from pathogen load, and a function for creating a dataframe containing the reuslts of the model. I assume transmission potential is directly proportional to pathogen load via a constant k.
```{r}
transmission.model <- function(t, x, params) {
  P <- x[1]
  X <- x[2]
  
  with(
    as.list(params),
    {
      dP <- r*P - k*X*P
      dX <- a - d*X + y*k*X*P
    
      res <- c(dP, dX)
      list(res)
    }
  )
}

transmission.potential <- function(k, P) {
  return(ifelse(k*P < 0, 0, k*P))
}

cutter <- function(dose, time, params) {
  df= data.frame(lsoda(c(P=dose, X=0), time, transmission.model, params))
  if(any(df$P) <= 0){
    clearance = min(which(df$P <= 0))
    df[clearance:length(time)] = NA
  }
  return(df)
}
```

These first three sets of parameters were used in King et al., and I use them here to 1) plot immune response over time and 2) plot a simple model of transmission where symptoms are determined by a pathogen load threshold (explained below). I varied the infectious dose values by a factor of 10^2, set the time steps as 0.01 from 0 to 10 units and the proportionality constant between pathogen load and transmission potential to 10^-3, and differentiated the infectious doses by color (light grey to black). 
```{r}
params40 <- c(r=40, k=3.5, y=10^-4, a=1, d=.5)
params70 <- c(r=70, k=3.5, y=10^-4, a=1, d=.5)
params100 <- c(r=100, k=3.5, y=10^-4, a=1, d=.5)
time <- seq(0,5, by=0.001)
lowid <- 1
medid <- 100
highid <- 10000
ids <- data.frame(low=lowid, med=medid, high=highid)
lowcolor <- "black"
medcolor <- "#a3a3a3"
highcolor <- "#d4d4d4"
cols <- data.frame(low=lowcolor, med=medcolor, high=highcolor)
k <- 10^-3
```

I first plotted immune response over time to visualize immune dynamics over the course of infection.
```{r}
plot.immune.response.panel <- function(ids, params, cols, label, time) {
  datalow= cutter(ids$low, time, params)
  datamed= cutter(ids$med, time, params)
  datahigh= cutter(ids$high, time, params)
  
  plot(datalow$time, datalow$X, col=cols[1], type="l", ylim=c(0, 300),
       xlab="Time", ylab="Immune Response", main=paste("R value:", params[1]),
       cex.lab=2, cex.axis=1.5, cex.main=2)
  text(0.05, 280, labels=label, font=2, cex=2)
  
  lines(datamed$time, datamed$X, col=cols[2])
  lines(datahigh$time, datahigh$X, col=cols[3])
}

#Plotting immune response over time

png("./Figures/Immune response.png", width=1000, height=900)

par(mfrow=c(2, 2), mar=c(5.1, 6.1, 4.1, 3.1))

plot.immune.response.panel(ids, params40, cols, "A)", time)

legend(0.18, 290, 
       title="Relative Infectious Dose",
       legend=c("1", "100", "10000"), 
       col=c(smallcolor, medcolor, highcolor), 
       cex=2, text.font=2, lty=1)

plot.immune.response.panel(ids, params70, cols, "B)")

plot.immune.response.panel(ids, params100, cols, "C)")

dev.off()
```

I constructed a function to determine peak immune response for applicable combinations of r and gamma values. Using this value, I then determined two thresholds for determining symptoms--below, and right at it--via another function.
```{r}
peak.immuneresponse <- function(data) {
  peak = max(data$immune)
  return(peak)
}

symp.thresh <- function(data, thresh.type) {
  peak.immune <- peak.immuneresponse(data)
  
  if(thresh.type == 'h') {
    return (peak.immune)
  } else {
    return(peak.immune - 5)
  }
}

symptomatic.df <- function(data, thresh.type) {
  threshold = symp.thresh(data, thresh.type)
  symp= data[data$immune >= threshold,]
  
  return(symp)
}
```
Assuming that pathogen clearance is reached as soon as pathogen load reaches 0, I only plot transmission potential until it first hits 0.
```{r}
plot.transmission.lines <- function(df, k, color) {
  lines(df$time, transmission.potential(k, df$P), col=color)
}
```

The first model I examine is one in which symptom onset and duration is dependent only on pathogen load. This is represented by a dotted horizontal red line depicting the threshold for symptoms. I am defining presymptomatic transmission as reaching peak transmission potential before symptom onset. This is a conservative way of estimating presymptomatic transmission. Given this definition, there are two cases for transmission in this model: 1) symptoms threshold is below peak pathogen load, and 2) symptoms threshold is above peak pathogen load. The outlier case (symptoms threshold is at peak pathogen load) doesn't signify much--it just suggests that the person is symptomatic only at one point throughout the infection. I plotted three plots, each with three lines; each plot signifies a different pathogen replication rate (r), and each line signifies a different infectious dose.
```{r}
plot.simple.model.panel <- function(symp.thresh, k, datalow, datamed, datahigh, 
                                    cols, label) {
  lowcolor= cols$low
  medcolor= cols$med
  highcolor= cols$high
  
  plot(1, type="n", xlab='', ylab='', log='y', xlim=c(0, 0.4), ylim=c(1, 10^4), 
       cex.lab=2, cex.axis=1.5, cex.main=2)
  plot.transmission.lines(datalow, k, lowcolor)
  plot.transmission.lines(datamed, k, medcolor)
  plot.transmission.lines(datahigh, k, highcolor)
  abline(h=symp.thresh, lty=3, col="red")
  text(0.03, 3 * 10^3, labels=label, font=2, cex=2)
  mtext(text="Time", side=1, line=4, cex=2)
  mtext(text="Transmission Potential", side=2, line=4, cex=2)
}

datalow <- cutter(lowid, time, params40)
datamed <- data.frame(lsoda(c(P=medid, X=0), time, transmission.model, params40))
datahigh <- data.frame(lsoda(c(P=highid, X=0), time, transmission.model, params40))

#Case 1: Symptoms threshold is below transmission threshold

{
  png("./Figures/Simple Model.png", width=1000, height=700)
  par(mfrow=c(1, 2), mar=c(5.1, 6.1, 4.1, 3.1))
  symp.thresh1 <- 50
  
  { 
  
    plot.simple.model.panel(symp.thresh1, k, datalow, datamed, datahigh, cols, "A)")
    
    legend(0.1, 9 * 10^3, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptom threshold"), 
           lty= c(1, 1, 1, 3, 3), col=c(cols$low, cols$med, cols$high, "red"), lwd=3, 
           cex=1.5, text.font=2) 
  }
  


#Case 2: Symptoms threshold is above transmission threshold

  symp.thresh2 <- 1000
  
  plot.simple.model.panel(symp.thresh2, k, datalow, datamed, datahigh, cols, "B)")
  
  dev.off()
}

```

The second model I examine is one in which symptom onset and duration is dependent only on immune response. When immune response rises above a certain threshold, the patient is symptomatic, as represented by a boldening of the transmission potential line.
```{r}
plot.immune.model.panel <- function(symp.thresh, r, label, cols, y, vary) {
  par(mar=c(5.1, 6.1, 4.1, 3.1))
  params=c(r=r, k=3.5, y=y, a=1, d=.5)
  
  datalow= data.frame(lsoda(c(P=lowid, X=0), time, transmission.model, params))
  datamed= data.frame(lsoda(c(P=medid, X=0), time, transmission.model, params))
  datahigh=- data.frame(lsoda(c(P=highid, X=0), time, transmission.model, params))
  
  dfs <- list(datalow, datamed, datahigh)
  
  plot(1, type="n", xlab='', ylab='', log='y', xlim=c(0, 0.5), ylim=c(1, 10^4), 
       cex.lab=2, cex.axis=1.5, cex.main=2)
  plot.immune.model.line(datalow, symp.thresh, cols$low)
  plot.immune.model.line(datamed, symp.thresh, cols$med)
  plot.immune.model.line(datahigh, symp.thresh, cols$high)
  
  if(vary=="gamma") {
    mtext(text=bquote("Transmission when "~ gamma ~ " = " ~ .(y)), font=2, side=3, line=1, cex=2)
    text(0.05, 6000, labels=label, font=2, cex=2)
  } else {
    text(0.25, 10^11, labels=label, font=2, cex=2)
    mtext(text=bquote("Transmission when r =" ~ .(r)), side=3, font=2, line=1, cex=2)
  }
}

plot.immune.model.line <- function(data, symp.thresh, col) {
  data=data[transmission.potential(k, data$P) > 0,]
  lines(data$time, transmission.potential(k, data$P), col=col)
  symptomatic <- data[data$X >= symp.thresh,]
  lines(symptomatic$time, transmission.potential(k,symptomatic$P), lwd=3)
}

symp.thresh <- 5

#r varies. gamma= 10^-4

r <- seq(10, 130, by=10)

png("./Figures/Immune-based symptoms varying r.png", width=1400, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 12)) {
  
  plot.immune.model.panel(symp.thresh, round(r[i]), paste(LETTERS[i], ")"), cols, 10^-4, "r")

  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.21, 8800, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }

}

dev.off()

#gamma varies. r=40.

symp.thresh <- 5

y <- seq(.5 * 10^-4, 1.5*10^-4, by=.1*10^-4)

png("./Figures/Immune-based symptoms varying y many.png", width=1600, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 11)) {
  
  plot.immune.model.panel(symp.thresh, 40, paste(LETTERS[i], ")"), cols, y[i], "gamma")
  
  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.27, 10000, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }
  
}

dev.off()

```

# Gamma r reproduction rate Figures

On 11/08/21, I'm going to vary gamma and r and plot transmission potential against time for 3 infectious doses. 

```{r}  
gamma_variable <- rep(c(0.5 * 10^-4, 10^-4, 1.5 * 10^-4), 3)
r_variable <- rep(c(10, 70, 130), 3)
dose <- c(rep(1, 3), rep(100, 3), rep(10000, 3))

varyingr <- data.frame(gamma= gamma_variable[2], r=r_variable, dose=dose)

varyingy <- data.frame(gamma=gamma_variable, r=r_variable[2], dose=dose)

get.params <- function(gamma, r) {
  return (c(y=gamma, r=r, a=1, d=.5, k=3.5))
}

desolve_function <- function(gamma, r, id, time) {
  parameter_value = get.params(gamma, r)
  df = cutter(id, time, parameter_value)
  tp = data.frame(time=time, transmission_potential=transmission.potential(10^-3, df$P), immune=df$X, gamma=gamma, r=r, dose=id)
  return(tp)
}

time <- seq(0,2, by=0.001)

#varyingr is a list
varyingr <- do.call(rbind, mapply(desolve_function, varyingr$gamma, varyingr$r, varyingr$dose, time, SIMPLIFY = FALSE))

lowr <- varyingr[varyingr$r == r_variable[1],] 
params.lowr <- get.params(gamma_variable[2], r_variable[1])
symptomatic.lowr.lowthresh <- symptomatic.df(lowr, 'low')
symptomatic.lowr.highthresh <- symptomatic.df(lowr, 'high')

medr <- varyingr[varyingr$r == r_variable[2],] 
params.medr <- get.params(gamma_variable[2], r_variable[2])
symptomatic.medr.lowthresh <- symptomatic.df(medr.lowdose, 'low')
symptomatic.medr.highthresh <- symptomatic.df(medr.lowdose, 'high')

highr <- varyingr[varyingr$r == r_variable[1],] 
params.highr <- get.params(gamma_variable[2], r_variable[1])
symptomatic.highr.lowthresh <- symptomatic.df(highr.lowdose, 'low')
symptomatic.highr.highthresh <- symptomatic.df(highr.lowdose, 'high')

#varyingy is a list
varyingy <- mapply(desolve_function, varyingy$gamma, varyingy$r, id=varyingy$dose, SIMPLIFY = FALSE)

varyingy <- do.call(rbind, varyingy)

symptomaticvaryingy <- varyingy[varyingy$immune >= symp.thresh,]
symp.lowgamma <- symptomaticvaryingy[symptomaticvaryingy$gamma == gamma_variable[1],]
symp.medgamma <- symptomaticvaryingy[symptomaticvaryingy$gamma == gamma_variable[2],]
symp.highgamma <- symptomaticvaryingy[symptomaticvaryingy$gamma == gamma_variable[3],]

```

Here, I plot the results. Each row is a different infectious dose. The left column varies r, and the right column varies gamma.
```{r}
gamma <- "\u03B3"

colsr <- c("10"="red", "70"="purple", "130"="orange")

colsgamma <- c("5e-05"="black", "1e-04"="green", "0.00015"="blue")
  
idlabels <- c("Infectious Dose: 1",
              "Infectious Dose: 100",
              "Infectious Dose: 10000")
names(idlabels) <- c("1", "100", "10000")

plot.varyingr <- function(lowr.df, medr.df, highr.df, symp.lowr.df, symp.medr.df, symp.highr.df) {
  ggplot(NULL, aes(x=time, y=transmission_potential)) + 
  xlim(0, 1.8) +
  geom_line(data=lowr.df, aes(colour=lowr)) +
  geom_line(data=medr.df, aes(colour=medr)) +
  geom_line(data=highr.df, aes(colour=highr)) +
  facet_wrap(~ dose, ncol=1, labeller=labeller(dose=idlabels)) +
  
  #Bolded transmission potential lines where symptoms occur
  geom_line(data=symp.lowr.df, aes(colour=lowr, lwd=1.1)) +
  geom_line(data=symp.medr.df, aes(colour=medr, lwd=1.1)) +
  geom_line(data=symp.highr.df, aes(colour=highr, lwd=1.1)) +
  
  xlab("Time") + ylab("Transmission Potential") + 
  scale_color_manual(name="Pathogen replication rate (r)", values = colsr) +
  theme(strip.background = element_rect(fill="lightblue"), 
        legend.position=c(.7, .15)) 
}

varyingr.plot.lowthresh <- plot.varyingr(lowr)

varyingy.plot <- ggplot(NULL, aes(x=time, y=transmission_potential)) + 
  xlim(0, 0.25) +
  geom_line(data=varyingy[varyingy$gamma==gamma_variable[1],],
            aes(colour=toString(gamma_variable[1]))) +
  geom_line(data=varyingy[varyingy$gamma==gamma_variable[2],], 
            aes(colour=toString(gamma_variable[2]))) +
  geom_line(data=varyingy[varyingy$gamma==gamma_variable[3],], 
            aes(colour=toString(gamma_variable[3]))) +
  facet_wrap(~ dose, ncol=1, labeller=labeller(dose=idlabels)) +
  
  #Bolded transmission potential lines where symptoms occur
  geom_line(data=symp.lowgamma, 
            aes(colour= toString(gamma_variable[1])), lwd=1.1) +
  geom_line(data=symp.medgamma, 
            aes(colour= toString(gamma_variable[2])), lwd=1.1) +
  geom_line(data=symp.highgamma, 
            aes(colour= toString(gamma_variable[3])), lwd=1.1) +
  
  xlab("Time") +  ylab("") +
  theme(axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        strip.background = element_rect(fill="lightblue"),
        legend.position=c(.7, .15)) +
  scale_color_manual(name=
                       paste("Immune response recruitment rate (", gamma, ")", 
                             sep=""),
                       values = colsgamma)

grid.arrange(varyingr.plot, varyingy.plot, ncol=2)

ggsave("./Figures/Varying r and y 6 panels.png")

```
