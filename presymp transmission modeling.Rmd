---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

My packages for ODE models and plotting:

```{r}
require(deSolve)
require(ggplot2)
require(gridExtra)
```

Here, I have my ODE model, a function for calculating transmission potential from pathogen load, and a function for creating a dataframe containing the results of the model. I assume transmission potential is directly proportional to pathogen load via a constant k. Assuming that pathogen clearance is reached as soon as pathogen load reaches 0, I cut off the dataframe as soon as transmission potential reaches 0.
```{r}
transmission.model <- function(t, x, params) {
  P <- x[1]
  X <- x[2]
  
  with(
    as.list(params),
    {
      dP <- r*P - k*X*P
      dX <- a - d*X + y*k*X*P
    
      res <- c(dP, dX)
      list(res)
    }
  )
}

transmission.potential <- function(k, P) {
  return(ifelse(k*P < 0, 0, k*P))
}

cutter <- function(dose, time, params) {
  df= data.frame(lsoda(c(P=dose, X=0), time, transmission.model, params))
  if(any(df$P) <= 0){
    clearance = min(which(df$P <= 0))
    df[clearance:length(time)] = NA
  }
  return(df)
}
```

These first three sets of parameters were used in King et al., and I use them here to 1) plot immune response over time and 2) plot a simple model of transmission where symptoms are determined by a pathogen load threshold (explained below). I varied the infectious dose values by a factor of 10^2, set the time steps as 0.001 from 0 to 2 units and the proportionality constant between pathogen load and transmission potential to 10^-3, and differentiated the infectious doses by color (light grey to black). 
```{r}
params40 <- c(r=40, k=3.5, y=10^-4, a=1, d=.5)
params70 <- c(r=70, k=3.5, y=10^-4, a=1, d=.5)
params100 <- c(r=100, k=3.5, y=10^-4, a=1, d=.5)
time <- seq(0,2, by=0.001)
lowid <- 1
medid <- 100
highid <- 10000
ids <- data.frame(low=lowid, med=medid, high=highid)
k <- 10^-3
```

I first plotted immune response over time to visualize immune dynamics over the course of infection.
```{r}
plot.immune.response.panel <- function(ids, params, cols, label, time) {
  datalow= cutter(ids$low, time, params)
  datamed= cutter(ids$med, time, params)
  datahigh= cutter(ids$high, time, params)
  
  plot(datalow$time, datalow$X, col=cols[1], type="l", ylim=c(0, 300),
       xlab="Time", ylab="Immune Response", main=paste("R value:", params[1]),
       cex.lab=2, cex.axis=1.5, cex.main=2)
  text(0.05, 280, labels=label, font=2, cex=2)
  
  lines(datamed$time, datamed$X, col=cols[2])
  lines(datahigh$time, datahigh$X, col=cols[3])
}

#Plotting immune response over time

png("./Figures/Immune response.png", width=1000, height=900)

par(mfrow=c(2, 2), mar=c(5.1, 6.1, 4.1, 3.1))

plot.immune.response.panel(ids, params40, cols, "A)", time)

legend(0.18, 290, 
       title="Relative Infectious Dose",
       legend=c("1", "100", "10000"), 
       col=c(smallcolor, medcolor, highcolor), 
       cex=2, text.font=2, lty=1)

plot.immune.response.panel(ids, params70, cols, "B)")

plot.immune.response.panel(ids, params100, cols, "C)")

dev.off()
```

I constructed a function to determine peak immune response for applicable combinations of r and gamma values. Using this value, I can then determine two thresholds for determining symptoms--below, and right at it--via another function.
```{r}
peak.immuneresponse <- function(data) {
  peak = max(data$immune)
  return(peak)
}

symptom.thresh <- function(data, thresh.type) {
  peak.immune <- peak.immuneresponse(data)
  
  if(thresh.type == 'high') {
    return (peak.immune * 2)
  } else if (thresh.type == 'med') {
    return(peak.immune)
  } else {
    return(peak.immune / 2)
  }
}

symptomatic.df <- function(data, thresh) {
  symp= data[data$immune >= thresh,]
  
  return(symp)
}

plot.transmission.lines <- function(df, k, color) {
  lines(df$time, transmission.potential(k, df$P), col=color)
}
```

The first model I examine is one in which symptom onset and duration is dependent only on pathogen load. This is represented by a dotted horizontal red line depicting the threshold for symptoms. I am defining presymptomatic transmission as reaching peak transmission potential before symptom onset. This is a conservative way of estimating presymptomatic transmission. Given this definition, there are two cases for transmission in this model: 1) symptoms threshold is below peak pathogen load, and 2) symptoms threshold is above peak pathogen load. The outlier case (symptoms threshold is at peak pathogen load) doesn't signify much--it just suggests that the person is symptomatic only at one point throughout the infection. I plotted three plots, each with three lines; each plot signifies a different pathogen replication rate (r), and each line signifies a different infectious dose.
```{r}
plot.simple.model.panel <- function(symp.thresh, k, datalow, datamed, datahigh, 
                                    cols, label) {
  lowcolor= cols$low
  medcolor= cols$med
  highcolor= cols$high
  
  plot(1, type="n", xlab='', ylab='', xlim=c(0, 0.4), ylim=c(1, 600), 
       cex.lab=2, cex.axis=1.5, cex.main=2)
  plot.transmission.lines(datalow, k, lowcolor)
  plot.transmission.lines(datamed, k, medcolor)
  plot.transmission.lines(datahigh, k, highcolor)
  abline(h=symp.thresh, lty=3, col="red")
  mtext(text="Time", side=1, line=4, cex=2)
  mtext(text="Transmission Potential", side=2, line=4, cex=2)
}

datalow <- cutter(ids$low, time, params40)
datamed <- cutter(ids$med, time, params40)
datahigh <- cutter(ids$high, time, params40)

#Case 1: Symptoms threshold is below transmission threshold

{
  png("./Figures/Simple Model.png", width=1000, height=700)
  par(mar=c(5.1, 6.1, 4.1, 3.1))
  symp.thresh <- 430
  
  { 
  
    plot.simple.model.panel(symp.thresh, k, datalow, datamed, datahigh, cols)
    
    legend(0.25, 600, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptom threshold"), 
           lty= c(1, 1, 1, 3, 3), col=c(cols$low, cols$med, cols$high, "red"), lwd=3, 
           cex=1.5, text.font=2) 
  }

  dev.off()
}

```

The second model I examine is one in which symptom onset and duration is dependent only on immune response. When immune response rises above a certain threshold, the patient is symptomatic, as represented by a boldening of the transmission potential line.
```{r}
plot.immune.model.panel <- function(symp.thresh, r, label, cols, y, vary) {
  par(mar=c(5.1, 6.1, 4.1, 3.1))
  params=c(r=r, k=3.5, y=y, a=1, d=.5)
  
  datalow= data.frame(lsoda(c(P=lowid, X=0), time, transmission.model, params))
  datamed= data.frame(lsoda(c(P=medid, X=0), time, transmission.model, params))
  datahigh=- data.frame(lsoda(c(P=highid, X=0), time, transmission.model, params))
  
  dfs <- list(datalow, datamed, datahigh)
  
  plot(1, type="n", xlab='', ylab='', log='y', xlim=c(0, 0.5), ylim=c(1, 10^4), 
       cex.lab=2, cex.axis=1.5, cex.main=2)
  plot.immune.model.line(datalow, symp.thresh, cols$low)
  plot.immune.model.line(datamed, symp.thresh, cols$med)
  plot.immune.model.line(datahigh, symp.thresh, cols$high)
  
  if(vary=="gamma") {
    mtext(text=bquote("Transmission when "~ gamma ~ " = " ~ .(y)), font=2, side=3, line=1, cex=2)
    text(0.05, 6000, labels=label, font=2, cex=2)
  } else {
    text(0.25, 10^11, labels=label, font=2, cex=2)
    mtext(text=bquote("Transmission when r =" ~ .(r)), side=3, font=2, line=1, cex=2)
  }
}

plot.immune.model.line <- function(data, symp.thresh, col) {
  data=data[transmission.potential(k, data$P) > 0,]
  lines(data$time, transmission.potential(k, data$P), col=col)
  symptomatic <- data[data$X >= symp.thresh,]
  lines(symptomatic$time, transmission.potential(k,symptomatic$P), lwd=3)
}

symp.thresh <- 5

#r varies. gamma= 10^-4

r <- seq(10, 130, by=10)

png("./Figures/Immune-based symptoms varying r.png", width=1400, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 12)) {
  
  plot.immune.model.panel(symp.thresh, round(r[i]), paste(LETTERS[i], ")"), cols, 10^-4, "r")

  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.21, 8800, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }

}

dev.off()

#gamma varies. r=40.

symp.thresh <- 5

y <- seq(.5 * 10^-4, 1.5*10^-4, by=.1*10^-4)

png("./Figures/Immune-based symptoms varying y many.png", width=1600, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 11)) {
  
  plot.immune.model.panel(symp.thresh, 40, paste(LETTERS[i], ")"), cols, y[i], "gamma")
  
  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.27, 10000, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }
  
}

dev.off()

```

# Plots of delay between pathogen load peak and symptom onset for different r and gamma values

On 11/21/21, I'm going to vary gamma and r and plot the delay between peak pathogen load and symptom onset against various r and gamma values (separately). 

```{r}  
gamma_variable <- seq(0.5 * 10^-4, 1.5 * 10^-4, by=7.692308e-06)
medgamma <- 10^-4
r_variable <- seq(10, 130, by=10)
medr <- 70
dose <- 10^seq(1, 6)
gamma <- "\u03B3"

get.params <- function(gamma, r) {
  return (c(y=gamma, r=r, a=1, d=.5, k=3.5))
}

desolve_function <- function(gamma, r, id, k) {
  time = seq(0,2, by=0.001)
  parameter_value = get.params(gamma, r)
  df = cutter(id, time, parameter_value)
  tp = data.frame(time=time, transmission_potential=transmission.potential(k, df$P), immune=df$X, gamma=gamma, r=r, dose=id)
  return(tp)
}

peak.pathogenloadtime <- function(df, k) {
  peak.pl= max(df$transmission_potential)
  return(df[which(df$transmission_potential==peak.pl),]$time)
}

symptom.onset <- function(df, thresh) {
  symptomatic= df[which(df$immune >= thresh),]$time
  if(length(symptomatic) > 0) {
    return(min(symptomatic))
  } else {
    return(NA)
  }
}

k <- 10^-3

#Varying r and determinine delay between peak pathogen load and symptom onset accordingly. Dynamically, varyingr is a list.
varyingr <- data.frame(gamma= medgamma, r=r_variable, dose=ids$low)
varyingr <- do.call(rbind, mapply(desolve_function, varyingr$gamma, varyingr$r, varyingr$dose, k, SIMPLIFY = FALSE))

lowr <- varyingr[varyingr$r == r_variable[1],]

symp.thresh1 <- 5
symp.thresh2 <- 10
symp.thresh3 <- 15

delays.df.byr <- data.frame(r=integer(), delay.peakload.symponset=integer())

for (r in r_variable) {
  df= varyingr[varyingr$r==r,]
  delay.peakload.symponset= peak.pathogenloadtime(df, k) - symptom.onset(df, symp.thresh)
  dftoadd= data.frame(r, delay.peakload.symponset)
  names(dftoadd)= c("r", "delay.peakload.symponset")
  delays.df.byr <- rbind(delays.df.byr, dftoadd)
}

#Varying gamma and determinine delay between peak pathogen load and symptom onset accordingly. Dynamically, varyinggamma is a list.
varyinggamma <- data.frame(gamma=gamma_variable, r=medr, dose=ids$low)
varyinggamma <- do.call(rbind, mapply(desolve_function, varyinggamma$gamma, varyinggamma$r, id=varyinggamma$dose, k, SIMPLIFY = FALSE))

delays.df.bygamma <- data.frame(gamma=integer(), delay.peakload.symponset=integer())

for (gamma in gamma_variable) {
  df= varyinggamma[varyinggamma$gamma==gamma,]
  delay.peakload.symponset= peak.pathogenloadtime(df, k) - symptom.onset(df, symp.thresh)
  dftoadd= data.frame(gamma, delay.peakload.symponset)
  names(dftoadd)= c("gamma", "delay.peakload.symponset")
  delays.df.bygamma <- rbind(delays.df.bygamma, dftoadd)
}

#Varying infectious dose and determinine delay between peak pathogen load and symptom onset accordingly. Dynamically, varyingdose is a list.
varyingdose <- data.frame(gamma= medgamma, r=medr, dose=dose)
varyingdose <- do.call(rbind, mapply(desolve_function, varyingdose$gamma, varyingdose$r, varyingdose$dose, k, SIMPLIFY = FALSE))

delays.df.bydose <- data.frame(dose=integer(), delay.peakload.symponset=integer())

for (d in dose) {
  df= varyingdose[varyingdose$dose==d,]
  delay.peakload.symponset= peak.pathogenloadtime(df, k) - symptom.onset(df, symp.thresh3)
  dftoadd= data.frame(d, delay.peakload.symponset)
  names(dftoadd)= c("dose", "delay.peakload.symponset")
  delays.df.bydose <- rbind(delays.df.bydose, dftoadd)
}

```

Here, I plot the results. These are scatterplots showing delay between peak pathogen load and symptom onset vs. either replication rate r or immune response recruitment rate gamma.
```{r}

plot.varyingr <- function(delaysbyr, symp.thresh) {
  ggplot(delaysbyr, aes(x=r, y=delay.peakload.symponset)) + 
  geom_point() +
  xlab("Replication Rate (r)") + 
  ylab("Delay Between Peak Pathogen Load and Symptom Onset") + 
  ggtitle(paste("Varying Replication Rate r (symptoms threshold = ", symp.thresh, ")")) +
  theme(strip.background = element_rect(fill="lightblue"))
}; plot.varyingr(delays.df.byr, symp.thresh)

plot.varyinggamma <- function(delaysbygamma, symp.thresh) {
  ggplot(delaysbygamma, aes(x=gamma, y=delay.peakload.symponset)) + geom_point() +
  xlab(paste("Immune Response Recruitment Rate (", gamma, ")")) + 
  ylab("Delay Between Peak Pathogen Load and Symptom Onset") + 
  ggtitle(paste("Varying Immune Response Recruitment Rate (", gamma, ") ", "(symptoms threshold = ", symp.thresh, ")")) +
  theme(strip.background = element_rect(fill="lightblue"))
}; plot.varyinggamma(delays.df.bygamma, symp.thresh)

plot.varyingdose <- function(delaysbydose, symp.thresh) {
  ggplot(delaysbydose, aes(x=dose, y=delay.peakload.symponset)) + geom_point() +
  xlab("Infectious Dose") + 
  ylab("Delay Between Peak Pathogen Load and Symptom Onset") + 
  ggtitle(paste("Varying Infectious Dose ", "(symptoms threshold = ", symp.thresh, ")")) +
  theme(strip.background = element_rect(fill="lightblue")) +
  scale_x_log10()
}; plot.varyingdose(delays.df.bydose, symp.thresh3)

```
