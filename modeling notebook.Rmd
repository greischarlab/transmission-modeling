---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

My packages for ODE models and plotting:

```{r}
require(deSolve)
require(ggplot2)
```

Here, I have my ODE model and a function for calculating transmission potential from pathogen load. I assume transmission potential is directly proportional to pathogen load via a constant k.
```{r}
transmission.model <- function(t, x, params) {
  P <- x[1]
  X <- x[2]
  
  with(
    as.list(params),
    {
      dP <- r*P - k*X*P
      dX <- a - d*X + y*k*X*P
    
      res <- c(dP, dX)
      list(res)
    }
  )
}

transmission.potential <- function(k, P) {
  return(ifelse(k*P < 0, 0, k*P))
}
```

Assuming that pathogen clearance is reached as soon as pathogen load reaches 0, I only plot transmission potential when pathogen load is positive. 
```{r}
plot.transmission.lines <- function(df, k, color) {
  df=df[df$P > 0,]
  transmission= transmission.potential(k, df$P)
  lines(df$time, transmission, col=color)
}
```

I plotted immune response over time to visualize immune dynamics over the course of infection.
```{r}
plot.immune.response.panel <- function(ids, params, cols, label) {
  datalow <- data.frame(lsoda(c(P=ids[1], X=0), time, transmission.model, params))
  datamed <- data.frame(lsoda(c(P=ids[2], X=0), time, transmission.model, params))
  datahigh <- data.frame(lsoda(c(P=ids[3], X=0), time, transmission.model, params))
  
  plot(datalow$time, datalow$X, col=cols[1], type="l", ylim=c(0, 300),
       xlab="Time", ylab="Immune Response", main=paste("R value:", params[1]),
       cex.lab=2, cex.axis=1.5, cex.main=2)
  text(0.05, 280, labels=label, font=2, cex=2)
  
  lines(datamed$time, datamed$X, col=cols[2])
  lines(datahigh$time, datahigh$X, col=cols[3])
}

#Plotting immune response over time

png("Immune response.png", width=1000, height=900)

par(mfrow=c(2, 2), mar=c(5.1, 6.1, 4.1, 3.1))

plot.immune.response.panel(ids, params40, cols, "A)")

legend(0.18, 290, 
       title="Relative Infectious Dose",
       legend=c("1", "100", "10000"), 
       col=c(smallcolor, medcolor, highcolor), 
       cex=2, text.font=2, lty=1)

plot.immune.response.panel(ids, params70, cols, "B)")

plot.immune.response.panel(ids, params100, cols, "C)")

dev.off()
```

The first model I examine is one in which symptom onset and duration is dependent only on pathogen load. This is represented by a dotted horizontal red line depicting the threshold for symptoms. I am defining presymptomatic transmission as reaching peak transmission potential before symptom onset. This is a conservative way of estimating presymptomatic transmission. Given this definition, there are two cases for transmission in this model: 1) symptoms threshold is below peak pathogen load, and 2) symptoms threshold is above peak pathogen load. The outlier case (symptoms threshold is at peak pathogen load) doesn't signify much--it just suggests that the person is symptomatic only at one point throughout the infection. 

```{r}
params40 <- c(r=40, k=3.5, y=10^-4, a=1, d=.5)
params70 <- c(r=70, k=3.5, y=10^-4, a=1, d=.5)
params100 <- c(r=100, k=3.5, y=10^-4, a=1, d=.5)
time <- seq(0,10, by=0.01)
#ids <- read.csv("IDs.csv")
lowid <- 1
medid <- 100
highid <- 10000
ids <- c(lowid, medid, highid)
lowcolor <- "black"
medcolor <- "#a3a3a3"
highcolor <- "#d4d4d4"
cols <- data.frame(low=lowcolor, med=medcolor, high=highcolor)
k <- 10^-3

datalow <- data.frame(lsoda(c(P=lowid, X=0), time, transmission.model, params40))
datamed <- data.frame(lsoda(c(P=medid, X=0), time, transmission.model, params40))
datahigh <- data.frame(lsoda(c(P=highid, X=0), time, transmission.model, params40))
```

I plotted three plots, each with three lines; each plot signifies a different pathogen replication rate (r), and each line signifies a different infectious dose.
```{r}
plot.simple.model.panel <- function(symp.thresh, k, datalow, datamed, datahigh, 
                                    cols, label) {
  lowcolor= cols$low
  medcolor= cols$med
  highcolor= cols$high
  
  plot(datalow$time, transmission.potential(k,datalow$P), log='y', ylim=c(1, 10^12), type="l",
       xlab="", ylab="", cex.lab=2, cex.axis=1.5, col=lowcolor)
  text(0.05, 3 * 10^11, labels=label, font=2, cex=2)
  plot.transmission.lines(datamed, k, medcolor)
  plot.transmission.lines(datahigh, k, highcolor)
  abline(h=symp.thresh, lty=3, col="red")
  mtext(text="Time", side=1, line=4, cex=2)
  mtext(text="Transmission Potential", side=2, line=4, cex=2)
}

#Case 1: Symptoms threshold is below transmission threshold

png("Simple Model.png", width=1000, height=700)
par(mfrow=c(1, 2), mar=c(5.1, 6.1, 4.1, 3.1))
symp.thresh1 <- 100
#plot(1, type="n", xlab='', ylab='', log="y", xlim=c(0, 0.5), ylim=c(1,10^12), cex.axis=2)
#lapply(dfs, plot.transmission.lines, k=k[2])
plot.simple.model.panel(symp.thresh1, k, datalow, datamed, datahigh, cols, "A)")

legend(0.13, 5 * 10^11, 
       title="Relative Infectious Dose",
       legend=c("1", "100", "10000", "Symptom threshold"), 
       lty= c(1, 1, 1, 3, 3), col=c(cols$low, cols$med, cols$high, "red"), lwd=3, 
       cex=1.5, text.font=2)

dev.off()

#Case 2: Symptoms threshold is above transmission threshold

symp.thresh2 <- 1000

plot.simple.model.panel(symp.thresh2, datalow, datamed, datahigh, cols, "B)")

dev.off()

```

The second model I examine is one in which symptom onset and duration is dependent only on immune response. When immune response rises above a certain threshold, the patient is symptomatic, as represented by a boldening of the transmission potential line.
```{r}
plot.immune.model.panel <- function(symp.thresh, r, label, cols, y, vary) {
  par(mar=c(5.1, 6.1, 4.1, 3.1))
  params=c(r=r, k=3.5, y=y, a=1, d=.5)
  
  datalow <- data.frame(lsoda(c(P=lowid, X=0), time, transmission.model, params))
  datamed <- data.frame(lsoda(c(P=medid, X=0), time, transmission.model, params))
  datahigh <- data.frame(lsoda(c(P=highid, X=0), time, transmission.model, params))
  
  dfs <- list(datalow, datamed, datahigh)
  
  plot(1, type="n", xlab='', ylab='', log='y', xlim=c(0, 0.5), ylim=c(1, 10^4), 
       cex.lab=2, cex.axis=1.5, cex.main=2)
  plot.immune.model.line(datalow, symp.thresh, cols$low)
  plot.immune.model.line(datamed, symp.thresh, cols$med)
  plot.immune.model.line(datahigh, symp.thresh, cols$high)
  
  if(vary=="gamma") {
    mtext(text=bquote("Transmission when "~ gamma ~ " = " ~ .(y)), font=2, side=3, line=1, cex=2)
    text(0.05, 6000, labels=label, font=2, cex=2)
  } else {
    text(0.25, 10^11, labels=label, font=2, cex=2)
    mtext(text=bquote("Transmission when r =" ~ .(r)), side=3, font=2, line=1, cex=2)
  }
}

plot.immune.model.line <- function(data, symp.thresh, col) {
  data=data[transmission.potential(k, data$P) > 0,]
  lines(data$time, transmission.potential(k, data$P), col=col)
  symptomatic <- data[data$X >= symp.thresh,]
  lines(symptomatic$time, transmission.potential(k,symptomatic$P), lwd=3)
}

symp.thresh <- 5

#r varies. gamma= 10^-4

r <- seq(10, 130, by=10)

png("Immune-based symptoms varying r.png", width=1400, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 12)) {
  
  plot.immune.model.panel(symp.thresh, round(r[i]), paste(LETTERS[i], ")"), cols, 10^-4, "r")

  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.21, 8800, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }

}

dev.off()

#gamma varies. r=40.

symp.thresh <- 5

y <- seq(.5 * 10^-4, 1.5*10^-4, by=.1*10^-4)

png("Immune-based symptoms varying y many.png", width=1600, height=1000)

par(mfrow=c(3, 4), mar=c(5.1, 6.1, 4.1, 3.1))

for (i in seq(1, 11)) {
  
  plot.immune.model.panel(symp.thresh, 40, paste(LETTERS[i], ")"), cols, y[i], "gamma")
  
  if (i == 9) {
    mtext(text="Time", side=1, line=4, cex=2)
    mtext(text="Transmission Potential", side=2, line=4, cex=2)
    
    legend(0.27, 10000, 
           title="Relative Infectious Dose",
           legend=c("1", "100", "10000", "Symptoms"), 
           col=c(smallcolor, medcolor, highcolor, smallcolor), lwd=c(1, 1, 1, 3), 
           cex=1.5, text.font=2)
  }
  
}

dev.off()

```

# Gamma r reproduction rate Figures

On 11/05/21, I'm going to vary gamma and r and plot transmission potential against time for 3 infectious doses.

```{r}
symp.thresh <- 5
gamma_variable <- c(0.5 * 10^-4, 10^-4, 1.5 * 10^-4)
r_variable <- c(10, 70, 130)

gamma_r <- expand.grid(gamma=gamma_variable, r=r_variable)

desolve_function <- function(gamma, r, id) {
  time= seq(0,2, by=0.01)
  parameter_value = c(y=gamma, r=r, a=1, d=.5, k=3.5)
  df = data.frame(lsoda(c(P=id, X=0), time, transmission.model, parameter_value))
  tp = data.frame(time=time, transmission_potential=transmission.potential(10^-3, df$P), immune=df$X, gamma, r)
  return(tp)
}

#lowdose is a list
lowdose <- mapply(desolve_function, gamma_r$gamma, gamma_r$r, id=1, SIMPLIFY = FALSE)

lowdose_full <- do.call(rbind, lowdose)

symptomaticlow <- lowdose_full[lowdose_full$immune >= symp.thresh,]

#meddose is a list
meddose <- mapply(desolve_function, gamma_r$gamma, gamma_r$r, id=100, SIMPLIFY = FALSE)

meddose_full <- do.call(rbind, meddose)

symptomaticmed <- meddose_full[meddose_full$immune >= symp.thresh,]

#highdose is a list
highdose <- mapply(desolve_function, gamma_r$gamma, gamma_r$r, id=10000, SIMPLIFY = FALSE)

highdose_full <- do.call(rbind, highdose)

symptomatichigh <- highdose_full[highdose_full$immune >= symp.thresh,]

```

Here, I plot the results:
```{r}
r.labs <- rep(c("r: 10", "r: 70", "r: 130"), 9)
names(r.labs) <- rep(c("10", "70", "130"), 3)

gamma.labs <- c(rep("\u03B3: 5e-05", 3), rep("\u03B3: 1e-04", 3), rep("\u03B3: 0.00015", 3))
names(gamma.labs) <- c(rep("5e-05", 3), rep("1e-04", 3), rep("0.00015", 3))

cols <- c("1"="#009E73", "100"="#871a6e", "10000"="#E69F00")
  
ggplot(NULL, aes(x=time, y=transmission_potential)) +
  facet_wrap(gamma~r, scales='free', labeller=labeller(gamma=gamma.labs, r=r.labs)) + 
  
  #Transmission potential lines
  geom_line(data=lowdose_full, aes(colour= "1")) +
  geom_line(data=meddose_full, aes(colour="100")) + 
  geom_line(data=highdose_full, aes(colour="10000")) + 
  
  #Bolded transmission potential lines where symptoms occur
  geom_line(data=symptomaticlow, aes(colour= "1"), lwd=1.1) +
  geom_line(data=symptomaticmed, aes(colour="100"), lwd=1.1) + 
  geom_line(data=symptomatichigh, aes(colour="10000"), lwd=1.1) + 
  
  xlab("Time") + ylab("Transmission Potential") +
  theme(strip.background = element_rect(fill="lightblue")) +
  scale_color_manual(name="Relative Infectious Dose", values = cols)

ggsave("./Figures/Varying r and y 9 plots.png")

```
